function SNSBaseList(){this._list,this._size=0}function XmlHttp(){}function XmlDocument(){}function JSJaCConnection(a){a&&a.httpbase&&(this._httpbase=a.httpbase),a&&a.oDbg&&a.oDbg.log?this.oDbg=a.oDbg:this.oDbg={log:function(){}},a&&a.timerval?this.setPollInterval(a.timerval):this.setPollInterval(JSJAC_TIMERVAL),a&&a.cookie_prefix?this._cookie_prefix=a.cookie_prefix:this._cookie_prefix="",this._connected=!1,this._events=[],this._keys=null,this._ID=0,this._IDPrefix="jump"+(new Date).format("yyMMdd")+"_",this._inQ=[],this._pQueue=[],this._regIDs=[],this._req=[],this._status="intialized",this._errcnt=0,this._inactivity=JSJAC_INACTIVITY,this._sendRawCallbacks=[]}function JSJaCConsoleLogger(a){this.level=a||4,this.start=function(){},this.log=function(a,b){if(b=b||0,!(b>this.level)&&"undefined"!=typeof console)try{switch(b){case 0:console.warn(a);break;case 1:console.error(a);break;case 2:console.info(a);break;case 4:console.debug(a);break;default:console.log(a)}}catch(c){try{console.log(a)}catch(d){}}},this.setLevel=function(a){return this.level=a,this},this.getLevel=function(){return this.level}}function STANZA_ERROR(a,b,c){return window==this?new STANZA_ERROR(a,b,c):(this.code=a,this.type=b,void(this.cond=c))}function JSJaCCookieException(a){this.message=a,this.name="CookieException"}function JSJaCCookie(a,b,c,d,e){return window==this?new JSJaCCookie(a,b,c,d,e):(this.name=a,this.value=b,this.secs=c,this.domain=d,this.path=e,this.write=function(){var a;if(this.secs){var b=new Date;b.setTime(b.getTime()+1e3*this.secs),a="; expires="+b.toGMTString()}else a="";var c=this.domain?"; domain="+this.domain:"",d=this.path?"; path="+this.path:"; path=/";document.cookie=this.getName()+"="+JSJaCCookie._escape(this.getValue())+a+c+d},this.erase=function(){var a=new JSJaCCookie(this.getName(),"",-1);a.write()},this.getName=function(){return this.name},this.setName=function(a){return this.name=a,this},this.getValue=function(){return this.value},this.setValue=function(a){return this.value=a,this},this.setDomain=function(a){return this.domain=a,this},void(this.setPath=function(a){return this.path=a,this}))}function JSJaCDebugger(){}function JSJaCError(a,b,c){var d=XmlDocument.create("error","jsjac");return d.documentElement.setAttribute("code",a),d.documentElement.setAttribute("type",b),c&&d.documentElement.appendChild(d.createElement(c)).setAttribute("xmlns",NS_STANZAS),d.documentElement}function JSJaCHttpBindingConnection(a){this.base=JSJaCConnection,this.base(a),this._hold=JSJACHBC_MAX_HOLD,this._inactivity=0,this._last_requests={},this._last_rid=0,this._min_polling=0,this._pause=0,this._wait=a.wait||JSJACHBC_MAX_WAIT,function(){function c(a,b){return this.slice(a,b)}function d(a,b){arguments.length<2&&(b=0);for(var c=0,d=a.length;d>c;++c,++b)this[b]=255&a[c]}function e(a){var b;if("number"==typeof a){b=new Array(a);for(var e=0;a>e;++e)b[e]=0}else b=a.slice(0);return b.subarray=c,b.buffer=b,b.byteLength=b.length,b.set=d,"object"==typeof a&&a.buffer&&(b.buffer=a.buffer),b}try{new Uint8Array(1);return}catch(b){}window.Uint8Array=e,window.Uint32Array=e,window.Int32Array=e}()}function JSJaCHttpPollingConnection(a){this.base=JSJaCConnection,this.base(a),JSJACPACKET_USE_XMLNS=!1}function JSJaCJIDInvalidException(a){this.message=a,this.name="JSJaCJIDInvalidException"}function JSJaCJID(a){this._node="",this._domain="",this._resource="","string"==typeof a?(-1!=a.indexOf("@")&&(this.setNode(a.substring(0,a.indexOf("@"))),a=a.substring(a.indexOf("@")+1)),-1!=a.indexOf("/")&&(this.setResource(a.substring(a.indexOf("/")+1)),a=a.substring(0,a.indexOf("/"))),this.setDomain(a)):(this.setNode(a.node),this.setDomain(a.domain),this.setResource(a.resource))}function JSJaCJSON(){}function JSJaCKeys(a,b){var c=Math.random();if(this._k=[],this._k[0]=c.toString(),b?this.oDbg=b:(this.oDbg={},this.oDbg.log=function(){}),a)for(var d=1;d<JSJAC_NKEYS;d++)this._k[d]=a(this._k[d-1]),b.log(d+": "+this._k[d],4);this._indexAt=JSJAC_NKEYS-1,this.getKey=function(){return this._k[this._indexAt--]},this.lastKey=function(){return 0===this._indexAt},this.size=function(){return this._k.length},this._getSuspendVars=function(){return"_k,_indexAt".split(",")}}function JSJaCPacket(a){this.name=a,"undefined"!=typeof JSJACPACKET_USE_XMLNS&&JSJACPACKET_USE_XMLNS?this.doc=XmlDocument.create(a,NS_CLIENT):this.doc=XmlDocument.create(a,"")}function JSJaCPresence(){this.base=JSJaCPacket,this.base("presence")}function JSJaCIQ(){this.base=JSJaCPacket,this.base("iq")}function JSJaCMessage(){this.base=JSJaCPacket,this.base("message")}function JSJaCWebSocketConnection(a){this.base=JSJaCConnection,this.base(a),this._ws=null,this.registerHandler("onerror",JSJaC.bind(this._cleanupWebSocket,this))}function hex_sha1(a){return rstr2hex(rstr_sha1(str2rstr_utf8(a)))}function b64_sha1(a){return rstr2b64(rstr_sha1(str2rstr_utf8(a)))}function any_sha1(a,b){return rstr2any(rstr_sha1(str2rstr_utf8(a)),b)}function hex_hmac_sha1(a,b){return rstr2hex(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(b)))}function b64_hmac_sha1(a,b){return rstr2b64(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(b)))}function any_hmac_sha1(a,b,c){return rstr2any(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(b)),c)}function sha1_vm_test(){return"a9993e364706816aba3e25717850c26c9cd0d89d"==hex_sha1("abc").toLowerCase()}function rstr_sha1(a){return binb2rstr(binb_sha1(rstr2binb(a),8*a.length))}function rstr_hmac_sha1(a,b){var c=rstr2binb(a);c.length>16&&(c=binb_sha1(c,8*a.length));for(var d=Array(16),e=Array(16),f=0;16>f;f++)d[f]=909522486^c[f],e[f]=1549556828^c[f];var g=binb_sha1(d.concat(rstr2binb(b)),512+8*b.length);return binb2rstr(binb_sha1(e.concat(g),672))}function rstr2binb(a){for(var b=Array(a.length>>2),c=0;c<b.length;c++)b[c]=0;for(var c=0;c<8*a.length;c+=8)b[c>>5]|=(255&a.charCodeAt(c/8))<<24-c%32;return b}function binb2rstr(a){for(var b="",c=0;c<32*a.length;c+=8)b+=String.fromCharCode(a[c>>5]>>>24-c%32&255);return b}function binb_sha1(a,b){a[b>>5]|=128<<24-b%32,a[(b+64>>9<<4)+15]=b;for(var c=Array(80),d=1732584193,e=-271733879,f=-1732584194,g=271733878,h=-1009589776,i=0;i<a.length;i+=16){for(var j=d,k=e,l=f,m=g,n=h,o=0;80>o;o++){16>o?c[o]=a[i+o]:c[o]=bit_rol(c[o-3]^c[o-8]^c[o-14]^c[o-16],1);var p=safe_add(safe_add(bit_rol(d,5),sha1_ft(o,e,f,g)),safe_add(safe_add(h,c[o]),sha1_kt(o)));h=g,g=f,f=bit_rol(e,30),e=d,d=p}d=safe_add(d,j),e=safe_add(e,k),f=safe_add(f,l),g=safe_add(g,m),h=safe_add(h,n)}return Array(d,e,f,g,h)}function sha1_ft(a,b,c,d){return 20>a?b&c|~b&d:40>a?b^c^d:60>a?b&c|b&d|c&d:b^c^d}function sha1_kt(a){return 20>a?1518500249:40>a?1859775393:60>a?-1894007588:-899497514}function hex_md5(a){return rstr2hex(rstr_md5(str2rstr_utf8(a)))}function b64_md5(a){return rstr2b64(rstr_md5(str2rstr_utf8(a)))}function any_md5(a,b){return rstr2any(rstr_md5(str2rstr_utf8(a)),b)}function hex_hmac_md5(a,b){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(b)))}function b64_hmac_md5(a,b){return rstr2b64(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(b)))}function any_hmac_md5(a,b,c){return rstr2any(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(b)),c)}function md5_vm_test(){return"900150983cd24fb0d6963f7d28e17f72"==hex_md5("abc").toLowerCase()}function rstr_md5(a){return binl2rstr(binl_md5(rstr2binl(a),8*a.length))}function rstr_hmac_md5(a,b){var c=rstr2binl(a);c.length>16&&(c=binl_md5(c,8*a.length));for(var d=Array(16),e=Array(16),f=0;16>f;f++)d[f]=909522486^c[f],e[f]=1549556828^c[f];var g=binl_md5(d.concat(rstr2binl(b)),512+8*b.length);return binl2rstr(binl_md5(e.concat(g),640))}function rstr2hex(a){try{}catch(b){hexcase=0}for(var e,c=hexcase?"0123456789ABCDEF":"0123456789abcdef",d="",f=0;f<a.length;f++)e=a.charCodeAt(f),d+=c.charAt(e>>>4&15)+c.charAt(15&e);return d}function rstr2b64(a){try{}catch(b){b64pad=""}for(var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d="",e=a.length,f=0;e>f;f+=3)for(var g=a.charCodeAt(f)<<16|(e>f+1?a.charCodeAt(f+1)<<8:0)|(e>f+2?a.charCodeAt(f+2):0),h=0;4>h;h++)d+=8*f+6*h>8*a.length?b64pad:c.charAt(g>>>6*(3-h)&63);return d}function arr2b64(a){try{}catch(b){b64pad=""}for(var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d="",e=a.length,f=0;e>f;f+=3)for(var g=a[f]<<16|(e>f+1?a[f+1]<<8:0)|(e>f+2?a[f+2]:0),h=0;4>h;h++)d+=8*f+6*h>8*a.length?b64pad:c.charAt(g>>>6*(3-h)&63);return d}function rstr2any(a,b){var d,e,f,g,h,c=b.length,i=Array(Math.ceil(a.length/2));for(d=0;d<i.length;d++)i[d]=a.charCodeAt(2*d)<<8|a.charCodeAt(2*d+1);var j=Math.ceil(8*a.length/(Math.log(b.length)/Math.log(2))),k=Array(j);for(e=0;j>e;e++){for(h=Array(),g=0,d=0;d<i.length;d++)g=(g<<16)+i[d],f=Math.floor(g/c),g-=f*c,(h.length>0||f>0)&&(h[h.length]=f);k[e]=g,i=h}var l="";for(d=k.length-1;d>=0;d--)l+=b.charAt(k[d]);return l}function str2rstr_utf8(a){for(var d,e,b="",c=-1;++c<a.length;)d=a.charCodeAt(c),e=c+1<a.length?a.charCodeAt(c+1):0,d>=55296&&56319>=d&&e>=56320&&57343>=e&&(d=65536+((1023&d)<<10)+(1023&e),c++),127>=d?b+=String.fromCharCode(d):2047>=d?b+=String.fromCharCode(192|d>>>6&31,128|63&d):65535>=d?b+=String.fromCharCode(224|d>>>12&15,128|d>>>6&63,128|63&d):2097151>=d&&(b+=String.fromCharCode(240|d>>>18&7,128|d>>>12&63,128|d>>>6&63,128|63&d));return b}function str2rstr_utf16le(a){for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(255&a.charCodeAt(c),a.charCodeAt(c)>>>8&255);return b}function str2rstr_utf16be(a){for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a.charCodeAt(c)>>>8&255,255&a.charCodeAt(c));return b}function rstr2binl(a){for(var b=Array(a.length>>2),c=0;c<b.length;c++)b[c]=0;for(var c=0;c<8*a.length;c+=8)b[c>>5]|=(255&a.charCodeAt(c/8))<<c%32;return b}function binl2rstr(a){for(var b="",c=0;c<32*a.length;c+=8)b+=String.fromCharCode(a[c>>5]>>>c%32&255);return b}function binl_md5(a,b){a[b>>5]|=128<<b%32,a[(b+64>>>9<<4)+14]=b;for(var c=1732584193,d=-271733879,e=-1732584194,f=271733878,g=0;g<a.length;g+=16){var h=c,i=d,j=e,k=f;c=md5_ff(c,d,e,f,a[g+0],7,-680876936),f=md5_ff(f,c,d,e,a[g+1],12,-389564586),e=md5_ff(e,f,c,d,a[g+2],17,606105819),d=md5_ff(d,e,f,c,a[g+3],22,-1044525330),c=md5_ff(c,d,e,f,a[g+4],7,-176418897),f=md5_ff(f,c,d,e,a[g+5],12,1200080426),e=md5_ff(e,f,c,d,a[g+6],17,-1473231341),d=md5_ff(d,e,f,c,a[g+7],22,-45705983),c=md5_ff(c,d,e,f,a[g+8],7,1770035416),f=md5_ff(f,c,d,e,a[g+9],12,-1958414417),e=md5_ff(e,f,c,d,a[g+10],17,-42063),d=md5_ff(d,e,f,c,a[g+11],22,-1990404162),c=md5_ff(c,d,e,f,a[g+12],7,1804603682),f=md5_ff(f,c,d,e,a[g+13],12,-40341101),e=md5_ff(e,f,c,d,a[g+14],17,-1502002290),d=md5_ff(d,e,f,c,a[g+15],22,1236535329),c=md5_gg(c,d,e,f,a[g+1],5,-165796510),f=md5_gg(f,c,d,e,a[g+6],9,-1069501632),e=md5_gg(e,f,c,d,a[g+11],14,643717713),d=md5_gg(d,e,f,c,a[g+0],20,-373897302),c=md5_gg(c,d,e,f,a[g+5],5,-701558691),f=md5_gg(f,c,d,e,a[g+10],9,38016083),e=md5_gg(e,f,c,d,a[g+15],14,-660478335),d=md5_gg(d,e,f,c,a[g+4],20,-405537848),c=md5_gg(c,d,e,f,a[g+9],5,568446438),f=md5_gg(f,c,d,e,a[g+14],9,-1019803690),e=md5_gg(e,f,c,d,a[g+3],14,-187363961),d=md5_gg(d,e,f,c,a[g+8],20,1163531501),c=md5_gg(c,d,e,f,a[g+13],5,-1444681467),f=md5_gg(f,c,d,e,a[g+2],9,-51403784),e=md5_gg(e,f,c,d,a[g+7],14,1735328473),d=md5_gg(d,e,f,c,a[g+12],20,-1926607734),c=md5_hh(c,d,e,f,a[g+5],4,-378558),f=md5_hh(f,c,d,e,a[g+8],11,-2022574463),e=md5_hh(e,f,c,d,a[g+11],16,1839030562),d=md5_hh(d,e,f,c,a[g+14],23,-35309556),c=md5_hh(c,d,e,f,a[g+1],4,-1530992060),f=md5_hh(f,c,d,e,a[g+4],11,1272893353),e=md5_hh(e,f,c,d,a[g+7],16,-155497632),d=md5_hh(d,e,f,c,a[g+10],23,-1094730640),c=md5_hh(c,d,e,f,a[g+13],4,681279174),f=md5_hh(f,c,d,e,a[g+0],11,-358537222),e=md5_hh(e,f,c,d,a[g+3],16,-722521979),d=md5_hh(d,e,f,c,a[g+6],23,76029189),c=md5_hh(c,d,e,f,a[g+9],4,-640364487),f=md5_hh(f,c,d,e,a[g+12],11,-421815835),e=md5_hh(e,f,c,d,a[g+15],16,530742520),d=md5_hh(d,e,f,c,a[g+2],23,-995338651),c=md5_ii(c,d,e,f,a[g+0],6,-198630844),f=md5_ii(f,c,d,e,a[g+7],10,1126891415),e=md5_ii(e,f,c,d,a[g+14],15,-1416354905),d=md5_ii(d,e,f,c,a[g+5],21,-57434055),c=md5_ii(c,d,e,f,a[g+12],6,1700485571),f=md5_ii(f,c,d,e,a[g+3],10,-1894986606),e=md5_ii(e,f,c,d,a[g+10],15,-1051523),d=md5_ii(d,e,f,c,a[g+1],21,-2054922799),c=md5_ii(c,d,e,f,a[g+8],6,1873313359),f=md5_ii(f,c,d,e,a[g+15],10,-30611744),e=md5_ii(e,f,c,d,a[g+6],15,-1560198380),d=md5_ii(d,e,f,c,a[g+13],21,1309151649),c=md5_ii(c,d,e,f,a[g+4],6,-145523070),f=md5_ii(f,c,d,e,a[g+11],10,-1120210379),e=md5_ii(e,f,c,d,a[g+2],15,718787259),d=md5_ii(d,e,f,c,a[g+9],21,-343485551),c=safe_add(c,h),d=safe_add(d,i),e=safe_add(e,j),f=safe_add(f,k)}return Array(c,d,e,f)}function md5_cmn(a,b,c,d,e,f){return safe_add(bit_rol(safe_add(safe_add(b,a),safe_add(d,f)),e),c)}function md5_ff(a,b,c,d,e,f,g){return md5_cmn(b&c|~b&d,a,b,e,f,g)}function md5_gg(a,b,c,d,e,f,g){return md5_cmn(b&d|c&~d,a,b,e,f,g)}function md5_hh(a,b,c,d,e,f,g){return md5_cmn(b^c^d,a,b,e,f,g)}function md5_ii(a,b,c,d,e,f,g){return md5_cmn(c^(b|~d),a,b,e,f,g)}function safe_add(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}function bit_rol(a,b){return a<<b|a>>>32-b}function utf8t2d(a){a=a.replace(/\r\n/g,"\n");var b=new Array,c=String.fromCharCode(237);if(c.charCodeAt(0)<0)for(var d=0;d<a.length;d++){var e=a.charCodeAt(d);e>0?b[b.length]=e:(b[b.length]=256+e>>6|192,b[b.length]=256+e&63|128)}else for(var d=0;d<a.length;d++){var e=a.charCodeAt(d);128>e?b[b.length]=e:e>127&&2048>e?(b[b.length]=e>>6|192,b[b.length]=63&e|128):(b[b.length]=e>>12|224,b[b.length]=e>>6&63|128,b[b.length]=63&e|128)}return b}function utf8d2t(a){for(var b=new Array,c=0;c<a.length;)a[c]<128?(b[b.length]=String.fromCharCode(a[c]),c++):a[c]>191&&a[c]<224?(b[b.length]=String.fromCharCode((31&a[c])<<6|63&a[c+1]),c+=2):(b[b.length]=String.fromCharCode((15&a[c])<<12|(63&a[c+1])<<6|63&a[c+2]),c+=3);return b.join("")}function b64arrays(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";b64=new Array,f64=new Array;for(var b=0;b<a.length;b++)b64[b]=a.charAt(b),f64[a.charAt(b)]=b}function b64d2t(a){var b=new Array,c=0,d=a.length;for(d%3==1&&(a[a.length]=0,a[a.length]=0),d%3==2&&(a[a.length]=0);c<a.length;)b[b.length]=b64[a[c]>>2],b[b.length]=b64[(3&a[c])<<4|a[c+1]>>4],b[b.length]=b64[(15&a[c+1])<<2|a[c+2]>>6],b[b.length]=b64[63&a[c+2]],c+=3;d%3==1&&(b[b.length-1]=b[b.length-2]="="),d%3==2&&(b[b.length-1]="=");var e=b.join("");return e}function b64t2d(a){var b=new Array,c=0;for(a=a.replace(/\n|\r/g,""),a=a.replace(/=/g,"");c<a.length;)b[b.length]=f64[a.charAt(c)]<<2|f64[a.charAt(c+1)]>>4,b[b.length]=(15&f64[a.charAt(c+1)])<<4|f64[a.charAt(c+2)]>>2,b[b.length]=(3&f64[a.charAt(c+2)])<<6|f64[a.charAt(c+3)],c+=4;return a.length%4==2&&(b=b.slice(0,b.length-2)),a.length%4==3&&(b=b.slice(0,b.length-1)),b}function createXHR(){var a;if("undefined"!=typeof ActiveXObject)for(var b=["Microsoft.XMLHTTP","Msxml2.XMLHttp.6.0","Msxml2.XMLHttp.5.0","Msxml2.XMLHttp.4.0","Msxml2.XMLHttp.3.0"],c=0;c<b.length;c++)try{a=new ActiveXObject(b[c])}catch(d){}else"undefined"!=typeof XMLHttpRequest&&(a=new XMLHttpRequest);return a}function snsimUploadUseXHR(a){var b='<div id="${fileID}" class="uploadify-queue-item"><div class="upload_file_icon"><img src="${fileTypeIcon}" /></div><div class="uploadify-progress"><div id="udn_uploadify_progress_bar" class="uploadify-progress-bar"></div></div><span class="up_filename">${fileName}</span><span class="uploadbtn" style="display:none;">\u4e0a\u4f20</span><button id="btnstop" style="display:none;" >stop</button><button id="${continueUpload}" style="display:none;">\u7eed\u4f20</button><span class="delfilebtn" ></span></div>',c={fileTypeExts:"*",uploader:"",auto:!0,method:"post",formData:{},fileObjName:"file",fileSizeLimit:2048,showUploadedPercent:!0,showUploadedSize:!0,buttonText:"",removeTimeout:100,itemTemplate:b,breakPoints:!0,fileSplitSize:10485760,getUploadedSize:null,saveUploadedSize:null,saveInfoLocal:!0,onUploadStart:null,onUploadSuccess:null,onUploadComplete:null,onUploadError:null,onInit:null,onCancel:null,onSelect:null,uploadIdPrefix:"file_upload_",inputId:null,to:null,type:4,chatType:"chat",showProcess:!1,processId:null,resource:null},d=jQuery.extend(c,a),e=function(a,b,c,e,f,g){var j,k,l,h=g,i=parseInt(SNSStorage.getLocalVal(c.name))||0;YYIMChat.isAnonymous()?(j=YYIMChat.getUserFullJID(),l="anonymous"):(j=YYIMChat.getUserNode(),l=YYIMChat.getToken()),k=d.resource&&"anonymous"==d.resource.toLowerCase()?YYIMChat.getJIDUtil().buildUserJID(YYIMChat.getJIDUtil().getID(h),"ANONYMOUS"):"groupchat"==d.chatType?YYIMChat.getJIDUtil().buildChatGroupJID(YYIMChat.getJIDUtil().getNode(h)):YYIMChat.getJIDUtil().buildUserJID(YYIMChat.getJIDUtil().getNode(h)),a=a+"?fileName="+encodeURI(c.name,"utf-8")+"&uploadedSize="+i+"&fileSize="+f+"&fromUser="+j+"&toUser="+k+"&token="+l+"&muc=1",d.type==UPLOAD_AVATAR&&(a+="&isAvatar=true"),YYIMChat.log("file upload url",2,a),b.open(d.method,a,!0),b.withCredentials=!0,b.setRequestHeader("X-Requested-With","XMLHttpRequest");var m=new FormData;if(m.append(d.fileObjName,c),e)for(key in e)m.append(key,e[key]);b.send(m)};this.each(function(){var a=jQuery(this),b=jQuery(".uploadify").length+1,c='<span id="'+d.uploadIdPrefix+b+'-queue" class="uploadify-queue"></span>',f=jQuery("#"+d.processId);jQuery("#"+d.uploadIdPrefix+b+"-queue").length<=0&&d.showProcess&&(f.append(c),jQuery("#"+d.processId).perfectScrollbar({suppressScrollX:!0})),FileUpload.getInstanceByInputId(d.inputId).fileObj={uploadAllowed:!0,fileInput:a,uploadFileList:f.find("#"+d.uploadIdPrefix+b+"-queue"),url:d.uploader,fileFilter:[],uploadOver:!1,filter:function(a){for(var b=[],c=d.fileTypeExts.split(";"),e=0,f=a.length;f>e;e++){var g=a[e];parseInt(FileUpload.formatFileSize(g.size,!0))>d.fileSizeLimit?alert("\u6587\u4ef6"+g.name+"\u5927\u5c0f\u8d85\u51fa\u9650\u5236\uff01"):"*"==d.fileTypeExts||jQuery.inArray(g.name.split(".").pop().toLowerCase(),c)>=0?b.push(g):alert("\u6587\u4ef6"+g.name+"\u7c7b\u578b\u4e0d\u5141\u8bb8\uff01")}return b},funSelect:function(c){for(var e=0,f=c.length;f>e;e++){var g=c[e];filesIndex+=","+g.index;var h="unknown";g.name&&(h=g.name.substr(g.name.lastIndexOf(".")+1));var i=jQuery(d.itemTemplate.replace(/\${fileID}/g,"fileupload_"+b+"_"+g.index).replace(/\${fileTypeIcon}/g,"res/skin/default/icons/filetype/"+h+".png").replace(/\${fileName}/g,g.name).replace(/\${fileSize}/g,FileUpload.formatFileSize(g.size)).replace(/\${instanceID}/g,a.attr("id")).replace(/\${continueUpload}/g,"continueUpload_"+b+"_"+g.index));d.auto&&i.find(".uploadbtn").remove();var j=0,k="0KB",l="0%";if(d.breakPoints){var m=this.funGetUploadedSize(g);j=m/g.size*100+"%",k=FileUpload.formatFileSize(m),l=(m/g.size*100).toFixed(2)+"%",i.find(".uploadify-progress-bar").css("width",j)}if(this.uploadFileList.append(i),d.showUploadedSize){var n='<span class="progressnum"><span id="isUploadingFileSize_'+b+"_"+g.index+'" class="uploadedsize">'+k+'</span>/<span class="totalsize">${fileSize}</span></span>'.replace(/\${fileSize}/g,FileUpload.formatFileSize(g.size));i.find(".uploadify-progress").after(n)}if(d.showUploadedPercent){var o='<span class="up_percent" style="display:none">'+l+"</span>";i.find(".uploadify-progress").after(o)}d.onSelect&&d.onSelect(c),d.auto?this.funUploadFile(g):i.find(".uploadbtn").click(function(a){return function(){FileUpload.getInstanceByInputId(d.inputId).fileObj.funUploadFile(a)}}(g)),i.find(".delfilebtn").click(function(a){return function(){FileUpload.getInstanceByInputId(d.inputId).fileObj.funDeleteFile(a)}}(g)),i.find("#btnstop").click(function(a){return function(){deletefilesIndex+=","+a.index}}(g)),i.find("#continueUpload_"+b+"_"+g.index).click(function(a){var b=a.index;return function(){if(deletefilesIndex.length>0&&deletefilesIndex.indexOf(","+b)>-1){for(var a=deletefilesIndex.split(","),c="",e=0;e<a.length;e++)a[e]!=b&&""!=a[e]&&(c+=","+a[e]);deletefilesIndex=c}var f=FileUpload.getFile(b,FileUpload.getInstanceByInputId(d.inputId).fileObj.fileFilter);f&&FileUpload.getInstanceByInputId(d.inputId).fileObj.funUploadFile(f)}}(g))}},onProgress:function(a,c,e){var g=f.find("#fileupload_"+b+"_"+a.index+" .uploadify-progress"),h=c,i=g.attr("lastLoaded")||0;i>c&&(i=0),c-=parseInt(i);var j=g.children(".uploadify-progress-bar"),k=parseFloat(j.get(0).style.width||0),l=(c/e*100+k).toFixed(2),m=l>100?"99.99%":l+"%";if(d.showUploadedSize&&(g.nextAll(".progressnum .uploadedsize").text(FileUpload.formatFileSize(c)),g.nextAll(".progressnum .totalsize").text(FileUpload.formatFileSize(e))),d.showUploadedPercent){g.nextAll(".up_percent").text(m);var n=FileUpload.formatFileSize(l*e/100);l*e/100>e&&(n=FileUpload.formatFileSize(e)),document.getElementById("isUploadingFileSize_"+b+"_"+a.index).innerHTML=n}j.css("width",m),h<d.fileSplitSize?g.attr("lastLoaded",h):g.removeAttr("lastLoaded")},funGetProgressWidth:function(a){var c=f.find("#fileupload_"+b+"_"+a+" .uploadify-progress-bar");return c.get(0).style.width||""},funGetUploadedSize:function(a){return d.getUploadedSize?d.getUploadedSize(a):d.saveInfoLocal?parseInt(SNSStorage.getLocalVal(a.name))||0:void 0},funSaveUploadedSize:function(a,b,c){d.saveUploadedSize?d.saveUploadedSize(a,b):d.saveInfoLocal&&!c&&SNSStorage.setLocal(a.name,b)},funSendFile:function(a){var b=a.files;b=this.filter(b);for(var c=0,d=b.length;d>c;c++)this.fileFilter.push(b[c]);return this.funDealFiles(b),this},funDealFiles:function(a){for(var c=f.find(".uploadify-queue .uploadify-queue-item").length,d=0,e=a.length;e>d;d++)a[d].index=++c,a[d].id="fileupload_"+b+"_"+a[d].index;return this.funSelect(a),this},funDeleteFile:function(a){d.breakPoints&&(deletefilesIndex+=","+a.index),f.find("#fileupload_"+b+"_"+a.index).fadeOut(),FileUpload.getInstanceByInputId(d.inputId).fileObj.fileInput.val(""),d.onCancel&&d.onCancel(a);var c=YYIMChat.getServletPath().FILE_DELETE_SERVLET,e={fileName:a.name,toUser:d.to,fromUser:YYIMChat.getUserNode(),token:YYIMChat.getToken(),muc:1};return $.ajax({url:c,async:!1,type:"POST",data:e,dataType:"text",success:function(b){"success"==b&&(SNSStorage.removeLocal(a.name),isDelete=!0)},error:function(){SNSStorage.removeLocal(a.name),isDelete=!0}}),this},funUploadFile:function(a){var c=!1,g=a,h=f.find("#fileupload_"+b+"_"+a.index),i=function(){FileUpload.getInstanceByInputId(d.inputId).fileObj.uploadOver&&(h.find(".uploadify-progress-bar").css("width","100%"),d.showUploadedSize&&h.find(".uploadedsize").text(h.find(".totalsize").text()),d.showUploadedPercent&&h.find(".up_percent").text("100%"))};try{c=new XMLHttpRequest}catch(j){c=ActiveXobject("Msxml12.XMLHTTP")}if("undefined"==c)return void alert("\u6d4f\u89c8\u5668\u7248\u672c\u4e0d\u652f\u6301\uff0c\u8bf7\u66f4\u65b0\u7248\u672c");if(g.size<=31457280||g.type.indexOf("image/")>-1?d.breakPoints=!1:d.breakPoints=!0,d.breakPoints){var k=a.name,l=a.id,m=a.index,n=a.size,o=parseInt(this.funGetUploadedSize(g));if(browserSys.firefox){var p=browserSys.firefox.split(".");a=p[0]>6&&p[0]<15?g.mozSlice(o,o+d.fileSplitSize):g.slice(o,o+d.fileSplitSize)}else if(browserSys.chrome){var p=browserSys.chrome.split(".");a=p[0]>10&&p[0]<21?g.webkitSlice(o,o+d.fileSplitSize):g.slice(o,o+d.fileSplitSize)}else a=g.slice(o,o+d.fileSplitSize);a.name=k,a.id=l,a.index=m}c.upload&&o!==!1&&c.upload.addEventListener("progress",function(b){FileUpload.getInstanceByInputId(d.inputId).fileObj.onProgress(a,b.loaded,g.size)},!1);var q=d.to;g.userJid=q,c.onreadystatechange=function(h){if(4==c.readyState){if(FileUpload.getInstanceByInputId(d.inputId).fileObj.uploadOver=!0,200==c.status){var j=JSON.parse(c.responseText);"success"==j.status&&(setTimeout(function(){f.find("#fileupload_"+b+"_"+g.index).fadeOut()},100),SNSStorage.removeLocal(a.name));var p=g.index;if(d.breakPoints)if(o+=d.fileSplitSize,"success"==j.status||isDelete?(FileUpload.getInstanceByInputId(d.inputId).fileObj.funSaveUploadedSize(g,o,!0),isDelete=!1):FileUpload.getInstanceByInputId(d.inputId).fileObj.funSaveUploadedSize(g,o,!1),deletefilesIndex.indexOf(p)>-1&&SNSStorage.removeLocal(g.name),n>o){if(FileUpload.getInstanceByInputId(d.inputId).fileObj.uploadOver=!1,filesIndex.indexOf(","+p)>-1&&-1==deletefilesIndex.indexOf(p)){if(browserSys.firefox){var r=browserSys.firefox.split(".");a=r[0]>6&&r[0]<15?g.mozSlice(o,o+d.fileSplitSize):g.slice(o,o+d.fileSplitSize)}else if(browserSys.chrome){var r=browserSys.chrome.split(".");a=r[0]>10&&r[0]<21?g.webkitSlice(o,o+d.fileSplitSize):g.slice(o,o+d.fileSplitSize)}else a=g.slice(o,o+d.fileSplitSize);a.name=k,a.id=l,a.index=m,a.size=n,e(FileUpload.getInstanceByInputId(d.inputId).fileObj.url,c,a,d.formData,g.size,q)}}else i();else i();if(FileUpload.getInstanceByInputId(d.inputId).fileObj.uploadOver){if(d.type==UPLOAD_AVATAR)d.onUploadSuccess&&d.onUploadSuccess(j.result);else{var s=j.result,t={id:Math.uuid(),body:{content:new SNSFile(a.name,s.attachId,a.size),contentType:d.type,dateline:(new Date).getTime()},to:d.to,type:d.chatType,success:function(a){var b=Object.clone(a);b.to=YYIMChat.getJIDUtil().getID(a.to),b.body.content.path=YYIMChat.getFileUrl(b.body.content.path),d.onUploadSuccess&&d.onUploadSuccess(b)}};d.resource&&(t.resource=d.resource),YYIMChat.sendMessage(t)}setTimeout(function(){f.find("#fileupload_"+b+"_"+g.index).fadeOut()},d.removeTimeout)}}else FileUpload.getInstanceByInputId(d.inputId).fileObj.uploadOver&&d.onUploadError&&d.onUploadError(g,c.responseText),setTimeout(function(){f.find("#fileupload_"+b+"_"+g.index).fadeOut()},100),SNSStorage.removeLocal(a.name);FileUpload.getInstanceByInputId(d.inputId).fileObj.uploadOver&&(d.onUploadComplete&&d.onUploadComplete(g,c.responseText),FileUpload.getInstanceByInputId(d.inputId).fileObj.fileInput.val(""))}},d.onUploadStart&&d.onUploadStart(),FileUpload.getInstanceByInputId(d.inputId).fileObj.uploadAllowed=!0,e(this.url,c,a,d.formData,g.size,q)}},d.onInit&&d.onInit()})}function _Range(a,b){this.START=a,this.END=b,this.SIZE=b-a}function _Opcode(a,b,c){this.KEY=a,this.SEND=b,this.RECV=c?c:b,OPCODE_MAP.SEND.add(this.SEND,this.KEY),OPCODE_MAP.RECV.add(this.RECV,this.KEY)}function shallowClone(a){function b(){}return b.prototype=a,new b}function inheritPrototype(a,b){var c=shallowClone(b.prototype);c.constructor=a,a.prototype=c}function JumpPacket(a,b){this.sFrame=0,this.version=256,this.seqId=0,this.packetLen=0,this.content=a,this.opcode=b}SNSBaseList.prototype.size=function(){return this._size},SNSBaseList.prototype._get=function(a){return this.get(a)},SNSBaseList.prototype._add=function(a,b){return this.add(a,b)},SNSBaseList.prototype._update=function(a,b){this.update(a,b)},SNSBaseList.prototype._remove=function(a){return this.remove(a)},SNSBaseList.prototype._contains=function(a){return this.contains(a)},SNSBaseList.prototype.add=function(a,b){return this._contains(a)?(this._list[a]=b,!1):(this._size++,this._list&&null!=this._list||(this._list=new Object),this._list[a]=b,!0)},SNSBaseList.prototype.update=function(a,b){return this._contains(a)?void(this._list[a]=b):(this.add(a,b),!0)},SNSBaseList.prototype.contains=function(a){return void 0!=this._list&&void 0!=this._list[a]},SNSBaseList.prototype.get=function(a){return this._list&&null!=this._list?this._list[a]:void 0},SNSBaseList.prototype.remove=function(a){return this._contains(a)?(delete this._list[a],this._size--,!0):void 0},SNSBaseList.prototype.removeAll=function(a){this._list=new Object,this._size=0},SNSBaseList.prototype.toArray=function(){var a=[];for(var b in this._list)this._list[b]&&"function"!=typeof this._list[b]&&a.push(this._list[b]);return a},function(){var a="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(b,c){var f,d=a,e=[];if(c=c||d.length,b)for(f=0;b>f;f++)e[f]=d[0|Math.random()*c];else{var g;for(e[8]=e[13]=e[18]=e[23]="-",e[14]="4",f=0;36>f;f++)e[f]||(g=0|16*Math.random(),e[f]=d[19==f?3&g|8:g])}return e.join("")},Math.uuidFast=function(){for(var e,b=a,c=new Array(36),d=0,f=0;36>f;f++)8==f||13==f||18==f||23==f?c[f]="-":14==f?c[f]="4":(2>=d&&(d=33554432+16777216*Math.random()|0),e=15&d,d>>=4,c[f]=b[19==f?3&e|8:e]);return c.join("")},Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})}}(),String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,"")},String.prototype.ltrim=function(){return this.replace(/(^\s*)/g,"")},String.prototype.rtrim=function(){return this.replace(/(\s*$)/g,"")},String.prototype.notEmpty=function(){return null!=this&&""!=this.trim()},String.prototype.isEmpty=function(){return!this.notEmpty()},String.prototype.endWith=function(a){return null==a||""==a||0==this.length||a.length>this.length?!1:this.substring(this.length-a.length)==a?!0:!1},String.prototype.startWith=function(a){return null==a||""==a||0==this.length||a.length>this.length?!1:this.substr(0,a.length)==a?!0:!1},Object.clone=function(a){if("object"!=typeof a)return a;var b={};a.constructor==Array&&(b=[]);for(var c in a)b[c]=a[c]?Object.clone(a[c]):null;return b},Date.now||(Date.now=function(){return(new Date).getTime()}),Date.prototype.format=function(a){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var c in b)new RegExp("("+c+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?b[c]:("00"+b[c]).substr((""+b[c]).length)));return a},Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e});var SNSStroageItem=function(a){this.user=YYIMChat.getUserNode(),this.id=SNSStorage.id,this.timestamp=(new Date).getTime(),this.val=a},SNSStorage={TYPE:{SESSION:"session",LOCAL:"local"}};SNSStorage.id=Math.uuid(),SNSStorage.setLocal=function(a,b){this._set(this.TYPE.LOCAL,a,b)},SNSStorage.appendLocal=function(a,b){this._append(this.TYPE.LOCAL,a,b)},SNSStorage.deleteLocalItem=function(a,b){this._deleteItem(this.TYPE.LOCAL,a,b)},SNSStorage.getLocal=function(a,b){return this._get(this.TYPE.LOCAL,a,b)},SNSStorage.getLocalVal=function(a,b){var c=this.getLocal(a,b);return c?c.val?c.val:"string"==typeof c?c:b:void 0},SNSStorage.removeLocal=function(a){this._remove(this.TYPE.LOCAL,a)},SNSStorage.clearLocal=function(){this._clear(this.TYPE.LOCAL)},SNSStorage.setSession=function(a,b){this._set(this.TYPE.SESSION,a,b)},SNSStorage.getSession=function(a,b){return this._get(this.TYPE.SESSION,a,b)},SNSStorage.removeSession=function(a){this._remove(this.TYPE.SESSION,a)},SNSStorage.clearSession=function(){this._clear(this.TYPE.SESSION)},SNSStorage._set=function(a,b,c){switch(a){case this.TYPE.LOCAL:store.set(b,JSON.stringify(new SNSStroageItem(c)));break;case this.TYPE.SESSION:sessionStorage.setItem(b,JSON.stringify(new SNSStroageItem(c)));break;default:return void YYIMChat.log("invalid storage type",0,a)}},SNSStorage._append=function(a,b,c){if(YYIMChat.log("append storage",3,b,c),"string"!=typeof c)return void YYIMChat.log("append storage: invalid val",3,c);var d=this._get(a,b);return d?(d=d.val,-1==d.indexOf(c)&&this._set(a,b,d+"|"+c)):this._set(a,b,"|"+c),this._get(a,b)},SNSStorage._deleteItem=function(a,b,c){if("string"!=typeof c)return void YYIMChat.log("_deleteItem storage: invalid val",3,c);var d=this._get(a,b).val;return d&&this._set(a,b,d.replace("|"+c,"")),this._get(a,b)},SNSStorage._get=function(a,b,c){var d;switch(a){case this.TYPE.LOCAL:d=JSON.parse(store.get(b));break;case this.TYPE.SESSION:d=JSON.parse(sessionStorage.getItem(b));break;default:YYIMChat.log("invalid storage type",0,a)}return null==d?c:d},SNSStorage._remove=function(a,b){try{switch(a){case this.TYPE.LOCAL:store.remove(b);break;case this.TYPE.SESSION:sessionStorage.removeItem(b);break;default:return void YYIMChat.log("invalid storage type",0,a)}}catch(c){YYIMChat.log("Storage remove error : "+c,1,a)}},SNSStorage._clear=function(a){
switch(YYIMChat.log("clear storage",1,a),a){case this.TYPE.LOCAL:store.clear();break;case this.TYPE.SESSION:sessionStorage.clear();break;default:return void YYIMChat.log("invalid storage type",0,a)}},"object"!=typeof JSON&&(JSON={}),function(){"use strict";function f(a){return 10>a?"0"+a:a}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,h,g=gap,i=b[a];switch(i&&"object"==typeof i&&"function"==typeof i.toJSON&&(i=i.toJSON(a)),"function"==typeof rep&&(i=rep.call(b,a,i)),typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";if(gap+=indent,h=[],"[object Array]"===Object.prototype.toString.apply(i)){for(f=i.length,c=0;f>c;c+=1)h[c]=str(c,i)||"null";return e=0===h.length?"[]":gap?"[\n"+gap+h.join(",\n"+gap)+"\n"+g+"]":"["+h.join(",")+"]",gap=g,e}if(rep&&"object"==typeof rep)for(f=rep.length,c=0;f>c;c+=1)"string"==typeof rep[c]&&(d=rep[c],e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e));else for(d in i)Object.prototype.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&h.push(quote(d)+(gap?": ":":")+e));return e=0===h.length?"{}":gap?"{\n"+gap+h.join(",\n"+gap)+"\n"+g+"}":"{"+h.join(",")+"}",gap=g,e}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx,escapable,gap,indent,meta,rep;"function"!=typeof JSON.stringify&&(escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},JSON.stringify=function(a,b,c){var d;if(gap="",indent="","number"==typeof c)for(d=0;c>d;d+=1)indent+=" ";else"string"==typeof c&&(indent=c);if(rep=b,b&&"function"!=typeof b&&("object"!=typeof b||"number"!=typeof b.length))throw new Error("JSON.stringify");return str("",{"":a})}),"function"!=typeof JSON.parse&&(cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&"object"==typeof e)for(c in e)Object.prototype.hasOwnProperty.call(e,c)&&(d=walk(e,c),void 0!==d?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}();var store=function(){function g(){return f?f:(f=c.body.appendChild(c.createElement("div")),f.style.display="none",f.addBehavior("#default#userData"),f.load(d),f)}var f,a={},b=window,c=b.document,d="localStorage",e="globalStorage";return a.set=function(a,b){},a.get=function(a){},a.remove=function(a){},a.clear=function(){},d in b&&b[d]?(f=b[d],a.set=function(a,b){f.setItem(a,b)},a.get=function(a){return f.getItem(a)},a.remove=function(a){f.removeItem(a)},a.clear=function(){f.clear()}):e in b&&b[e]?(f=b[e][b.location.hostname],a.set=function(a,b){f[a]=b},a.get=function(a){return f[a]&&f[a].value},a.remove=function(a){delete f[a]},a.clear=function(){for(var a in f)delete f[a]}):c.documentElement.addBehavior&&(a.set=function(a,b){var c=g();c.setAttribute(a,b),c.save(d)},a.get=function(a){var b=g();return b.getAttribute(a)},a.remove=function(a){var b=g();b.removeAttribute(a),b.save(d)},a.clear=function(){var a=g(),b=a.XMLDocument.documentElement.attributes;a.load(d);for(var e,c=0;e=b[c];c++)a.removeAttribute(e.name);a.save(d)}),a}(),YYIMCommonUtil={isFunction:function(a){return"function"==typeof a},isStringAndNotEmpty:function(a){return"string"==typeof a?a.notEmpty():!1},chatNumInString:function(a,b){if("string"==typeof a&&"string"==typeof b){var c=new RegExp("\\"+b,"gi"),d=a.match(c);if(d)return d.length}return 0},isNumber:function(a){return"[object Number]"===Object.prototype.toString.call(a)}},SNSCommonUtil={isFunction:YYIMCommonUtil.isFunction,isStringAndNotEmpty:YYIMCommonUtil.isStringAndNotEmpty,chatNumInString:YYIMCommonUtil.chatNumInString,isNumber:YYIMCommonUtil.isNumber},YYIMArrayUtil={contains:function(a,b){if("[object Array]"===Object.prototype.toString.call(a)){for(var c=0;c<a.length;c++)if(a[c]===b)return!0;return!1}return!1},isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},unique:function(a){a.sort();for(var b=[a[0]],c=1;c<a.length;c++)a[c]!==b[b.length-1]&&b.push(a[c]);return b},insert:function(a,b,c){a.splice(b,0,c)}},SNSArrayUtil={contains:YYIMArrayUtil.contains,isArray:YYIMArrayUtil.isArray,unique:YYIMArrayUtil.unique,insert:YYIMArrayUtil.insert},YYIMCookieUtil={getcookie:function(a){for(var b=document.cookie,c=b.split(";"),d=c.length,e=0;d>e;e++){var f=c[e].split("=");if(f[0].replace(/(^\s+)|(\s+$)/g,"")==a)return unescape(f[1])}return null},setcookie:function(a,b,c,d,e,f){var g=a+"="+escape(b);if(c){var h=new Date((new Date).getTime()+6e4*c);g+=";expires="+h.toGMTString()}d&&(g+=";path="+d),e&&(g+=";domain="+e),f&&(g+=";secure"),document.cookie=g},delcookie:function(a,b,c){if(get_cookie(a)){var d=a+"=;expires=Fri, 02-Jan-1970 00:00:00 GMT";b&&(d+=";path="+b),c&&(d+=";domain="+c),document.cookie=d}}};XmlHttp.create=function(){try{if(window.XMLHttpRequest){var a=new XMLHttpRequest;return null===a.readyState&&(a.readyState=1,a.addEventListener("load",function(){a.readyState=4,"function"==typeof a.onreadystatechange&&a.onreadystatechange()},!1)),a}if(window.ActiveXObject)return new ActiveXObject(XmlHttp.getPrefix()+".XmlHttp")}catch(b){}throw new Error("Your browser does not support XmlHttp objects")},XmlHttp.getPrefix=function(){if(XmlHttp.prefix)return XmlHttp.prefix;for(var b,a=["MSXML2","Microsoft","MSXML","MSXML3"],c=0;c<a.length;c++)try{return b=new ActiveXObject(a[c]+".XmlHttp"),XmlHttp.prefix=a[c]}catch(d){}throw new Error("Could not find an installed XML parser")},XmlDocument.create=function(a,b){a=a||"foo",b=b||"";try{var c;if(document.implementation&&document.implementation.createDocument?(c=document.implementation.createDocument(b,a,null),null===c.readyState&&(c.readyState=1,c.addEventListener("load",function(){c.readyState=4,"function"==typeof c.onreadystatechange&&c.onreadystatechange()},!1))):window.ActiveXObject&&(c=new ActiveXObject(XmlDocument.getPrefix()+".DomDocument")),!c.documentElement||c.documentElement.tagName!=a||c.documentElement.namespaceURI&&c.documentElement.namespaceURI!=b)try{""!==b?c.appendChild(c.createElement(a)).setAttribute("xmlns",b):c.appendChild(c.createElement(a))}catch(d){c=document.implementation.createDocument(b,a,null),null===c.documentElement&&c.appendChild(c.createElement(a)),""!==b&&c.documentElement.getAttribute("xmlns")!=b&&c.documentElement.setAttribute("xmlns",b)}return c}catch(e){}throw new Error("Your browser does not support XmlDocument objects")},XmlDocument.getPrefix=function(){if(XmlDocument.prefix)return XmlDocument.prefix;for(var b,a=["MSXML2","Microsoft","MSXML","MSXML3"],c=0;c<a.length;c++)try{return b=new ActiveXObject(a[c]+".DomDocument"),XmlDocument.prefix=a[c]}catch(d){}throw new Error("Could not find an installed XML parser")},"undefined"!=typeof Document&&window.DOMParser&&(Document.prototype.loadXML=function(a){for(var b=(new DOMParser).parseFromString(a,"text/xml");this.hasChildNodes();)this.removeChild(this.lastChild);for(var c=0;c<b.childNodes.length;c++)this.appendChild(this.importNode(b.childNodes[c],!0))}),window.XMLSerializer&&window.Node&&Node.prototype&&Node.prototype.__defineGetter__&&(XMLDocument.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}),Document.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}),Node.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}));var JSJaC={Version:"1.4",bind:function(a,b,c){return function(d){return a.apply(b,[d,c])}}},JSJaCBuilder={buildNode:function(a,b){var c,d=arguments[4];if(arguments[2])if(JSJaCBuilder._isStringOrNumber(arguments[2])||arguments[2]instanceof Array)c=this._createElement(a,b,d),JSJaCBuilder._children(a,c,arguments[2]);else{d=arguments[2].xmlns||d,c=this._createElement(a,b,d);for(var e in arguments[2])arguments[2].hasOwnProperty(e)&&"xmlns"!=e&&c.setAttribute(e,arguments[2][e])}else c=this._createElement(a,b,d);return arguments[3]&&JSJaCBuilder._children(a,c,arguments[3],d),c},_createElement:function(a,b,c){try{if(c)return a.createElementNS(c,b)}catch(d){}var e=a.createElement(b);return c&&e.setAttribute("xmlns",c),e},_text:function(a,b){return a.createTextNode(b)},_children:function(a,b,c,d){if("object"==typeof c){for(var e in c)if(c.hasOwnProperty(e)){var f=c[e];if("object"==typeof f)if(f instanceof Array){var g=JSJaCBuilder.buildNode(a,f[0],f[1],f[2],d);b.appendChild(g)}else b.appendChild(f);else JSJaCBuilder._isStringOrNumber(f)&&b.appendChild(JSJaCBuilder._text(a,f))}}else JSJaCBuilder._isStringOrNumber(c)&&b.appendChild(JSJaCBuilder._text(a,c))},_attributes:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c+'="'+a[c].toString().htmlEnc()+'"');return b.join(" ")},_isStringOrNumber:function(a){return"string"==typeof a||"number"==typeof a}};JSJAC_HAVEKEYS=!0,JSJAC_NKEYS=16,JSJAC_INACTIVITY=300,JSJAC_ERR_COUNT=10,JSJAC_ALLOW_PLAIN=!0,JSJAC_ALLOW_SCRAM=!1,JSJAC_CHECKQUEUEINTERVAL=100,JSJAC_CHECKINQUEUEINTERVAL=100,JSJAC_TIMERVAL=2e3,JSJAC_RETRYDELAY=5e3,JSJAC_REGID_TIMEOUT=2e4,JSJACHBC_MAX_HOLD=1,JSJACHBC_MAX_WAIT=300,JSJACHBC_BOSH_VERSION="1.10",JSJACHBC_USE_BOSH_VER=!0,JSJACHBC_MAXPAUSE=120,JSJaCConnection.prototype.connect=function(a){this._setStatus("connecting"),this.domain=a.domain||"localhost",this.username=a.username,this.resource=a.resource,this.pass=a.password||a.pass,this.authzid=a.authzid||"",this.register=a.register,this.authhost=a.authhost||a.host||a.domain,this.authtype=a.authtype||"sasl",a.xmllang&&""!==a.xmllang?this._xmllang=a.xmllang:this._xmllang="en",a.allow_plain?this._allow_plain=a.allow_plain:this._allow_plain=JSJAC_ALLOW_PLAIN,a.allow_scram?this._allow_scram=a.allow_scram:this._allow_scram=JSJAC_ALLOW_SCRAM,this.host=a.host,this.port=a.port||5222,this.jid=this.username+"@"+this.domain,this.fulljid=this.jid+"/"+this.resource,this._rid=Math.round(100000.5+799999.99999*Math.random());var b=this._getFreeSlot();this._req[b]=this._setupRequest(!0);var c=this._getInitialRequestString();this.oDbg.log(c,4),this._req[b].r.onreadystatechange=JSJaC.bind(function(){var a=this._req[b].r;4==a.readyState&&(this.oDbg.log("async recv: "+a.responseText,4),this._handleInitialResponse(a))},this),"undefined"!=typeof this._req[b].r.onerror&&(this._req[b].r.onerror=JSJaC.bind(function(){this.oDbg.log("XmlHttpRequest error",1)},this)),this._req[b].r.send(c)},JSJaCConnection.prototype.connected=function(){return this._connected},JSJaCConnection.prototype.disconnect=function(){if(this._setStatus("disconnecting"),this.connected()){this._connected=!1,clearInterval(this._interval),clearInterval(this._inQto),this._timeout&&clearTimeout(this._timeout);var a=this._getFreeSlot();this._req[a]=this._setupRequest(!1);var b=this._getRequestString(!1,!0);this.oDbg.log("Disconnecting: "+b,4);try{this._req[a].r.send(b)}catch(c){}this.oDbg.log("disconnected");try{JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase()}catch(c){}this._handleEvent("ondisconnect")}},JSJaCConnection.prototype.getPollInterval=function(){return this._timerval},JSJaCConnection.prototype.registerHandler=function(a,b,c,d){a=a.toLowerCase();var e={handler:arguments[arguments.length-1],ns:"*",type:"*"};return arguments.length>2&&(e.ns=arguments[1]),arguments.length>3&&(e.type=arguments[2]),this._events[a]?this._events[a]=this._events[a].concat(e):this._events[a]=[e],this._events[a]=this._events[a].sort(function(a,b){var c=0,d=0;return"*"==a.type&&c++,"*"==a.ns&&c++,c++,"*"==b.type&&d++,"*"==b.ns&&d++,c>d?1:d>c?-1:0}),this.oDbg.log("registered handler for event '"+a+"'",2),this},JSJaCConnection.prototype.unregisterHandler=function(a,b){if(a=a.toLowerCase(),!this._events[a])return this;for(var c=this._events[a],d=[],e=0;e<c.length;e++)c[e].handler!=b&&d.push(c[e]);return c.length!=d.length&&(this._events[a]=d,this.oDbg.log("unregistered handler for event '"+a+"'",2)),this},JSJaCConnection.prototype.registerIQGet=function(a,b,c){return this.registerHandler("iq",a,b,"get",c)},JSJaCConnection.prototype.registerIQSet=function(a,b,c){return this.registerHandler("iq",a,b,"set",c)},JSJaCConnection.prototype.resume=function(){try{var a=JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").getValue();return this.oDbg.log("read cookie: "+a,2),JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase(),this.resumeFromData(JSJaCJSON.parse(a))}catch(b){}return!1},JSJaCConnection.prototype.resumeFromData=function(a){try{for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);if(this._keys){this._keys2=new JSJaCKeys;for(var c=this._keys2._getSuspendVars(),d=0;d<c.length;d++)this._keys2[c[d]]=this._keys[c[d]];this._keys=this._keys2}return this._connected?(this._setStatus("resuming"),this._handleEvent("onresume"),setTimeout(JSJaC.bind(this._resume,this),this.getPollInterval()),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL)):this._setStatus("terminated"),this._connected===!0}catch(e){return e.message?this.oDbg.log("Resume failed: "+e.message,1):this.oDbg.log("Resume failed: "+e,1),!1}},JSJaCConnection.prototype.sendJumpPacket=function(a,b,c){if(!this.connected())return!1;if(!a||!a.opcode)return this.oDbg.log("no jumpPacket: "+a,1),!1;if(b&&this._validateCallbackable(a)){if(!a.content)throw new Error("packet content cannot be null when send a Message or IQ packet.");a.content.id||(a.content.id=this._IDPrefix+this._ID++),this._registerPID(a,b,c)}return this._pQueue=this._pQueue.concat(a),this._handleEvent("packet_out",a),!0},JSJaCConnection.prototype.send=function(a,b,c){},JSJaCConnection.prototype.sendIQ=function(a,b,c){if(!a||"iq"!=a.pType())return!1;b=b||{};var d=b.error_handler||JSJaC.bind(function(a){this.oDbg.log(a.xml(),1)},this),e=b.result_handler||JSJaC.bind(function(a){this.oDbg.log(a.xml(),2)},this),f=function(a,b){switch(a.getType()){case"error":d(a);break;case"result":e(a,b)}};return this.send(a,f,c)},JSJaCConnection.prototype.setPollInterval=function(a){return a&&!isNaN(a)&&(this._timerval=a),this._timerval},JSJaCConnection.prototype.status=function(){return this._status},JSJaCConnection.prototype.suspend=function(){var a=this.suspendToData();try{var b=new JSJaCCookie(this._cookie_prefix+"JSJaC_State",JSJaCJSON.toString(a));this.oDbg.log("writing cookie: "+b.getValue()+"\n(length:"+b.getValue().length+")",2),b.write();var c=JSJaCCookie.get(this._cookie_prefix+"JSJaC_State");return b.getValue()!=c?(this.oDbg.log("Suspend failed writing cookie.\nread: "+c,1),b.erase(),!1):!0}catch(d){this.oDbg.log("Failed creating cookie '"+this._cookie_prefix+"JSJaC_State': "+d.message,1)}return!1},JSJaCConnection.prototype.suspendToData=function(){clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._suspend();var a="_connected,_keys,_ID,_xmllang,_inQ,_pQueue,_regIDs,_errcnt,_inactivity,domain,username,resource,jid,fulljid,_sid,_httpbase,_timerval,_is_polling".split(",");a=a.concat(this._getSuspendVars());for(var b={},c=0;c<a.length;c++)if(this[a[c]]){var d={};if(this[a[c]]._getSuspendVars)for(var e=this[a[c]]._getSuspendVars(),f=0;f<e.length;f++)d[e[f]]=this[a[c]][e[f]];else d=this[a[c]];b[a[c]]=d}return this._connected=!1,this._setStatus("suspending"),b},JSJaCConnection.prototype._abort=function(){clearTimeout(this._timeout),clearInterval(this._inQto),clearInterval(this._interval),this._connected=!1,this._setStatus("aborted"),this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._handleEvent("onerror",JSJaCError("500","cancel","service-unavailable"))},JSJaCConnection.prototype._checkInQ=function(){for(var a=0;a<this._inQ.length&&10>a;a++){var b=this._inQ[0],c=b.body,d=b.event;if(this._inQ=this._inQ.slice(1,this._inQ.length),!c)return this._handleEvent("packet_in"),void this._handleEvent(d);this._handlePID(c)||(this._handleEvent("packet_in",c),this._handleEvent(d,c))}},JSJaCConnection.prototype._checkQueue=function(){return this._pQueue.length>0&&this._process(),!0},JSJaCConnection.prototype._doAuth=function(){return this._sendJumpPacket(this._getAuthPacket(),function(a){if(a.event==OPCODE.AUTH.KEY){var b=a.body;if(200!=b.code)return void this._handleEvent("onerror",JSJaCError("401","auth","not-authorized"));this._handleEvent("packet_in",b),this._handleEvent(OPCODE.AUTH.KEY,b),this._handleEvent("onconnect")}}),!0},JSJaCConnection.prototype._doInBandReg=function(){if("saslanon"!=this.authtype&&"anonymous"!=this.authtype){var a=new JSJaCIQ;a.setType("set"),a.setID("reg1"),a.appendNode("query",{xmlns:NS_REGISTER},[["username",this.username],["password",this.pass]]),this.send(a,this._doInBandRegDone)}},JSJaCConnection.prototype._doInBandRegDone=function(a){return a&&"error"==a.getType()?(this.oDbg.log("registration failed for "+this.username,0),void this._handleEvent("onerror",a.getChild("error"))):(this.oDbg.log(this.username+" registered succesfully",0),void this._doAuth())},JSJaCConnection.prototype._doLegacyAuth=function(){if("nonsasl"!=this.authtype&&"anonymous"!=this.authtype)return!1;var a=new JSJaCIQ;return a.setIQ(null,"get","auth1"),a.appendNode("query",{xmlns:NS_AUTH},[["username",this.username]]),this.send(a,this._doLegacyAuth2),!0},JSJaCConnection.prototype._doLegacyAuth2=function(a){if(!a||"result"!=a.getType())return a&&"error"==a.getType()&&this._handleEvent("onerror",a.getChild("error")),void this.disconnect();var b=null!==a.getChild("digest"),c=new JSJaCIQ;c.setIQ(null,"set","auth2");var d=c.appendNode("query",{xmlns:NS_AUTH},[["username",this.username],["resource",this.resource]]);if(b)d.appendChild(c.buildNode("digest",{xmlns:NS_AUTH},hex_sha1(this.streamid+this.pass)));else{if(!this._allow_plain)return this.oDbg.log("no valid login mechanism found",1),void this.disconnect();d.appendChild(c.buildNode("password",{xmlns:NS_AUTH},this.pass))}this.send(c,this._doLegacyAuthDone)},JSJaCConnection.prototype._doLegacyAuthDone=function(a){"result"!=a.getType()?("error"==a.getType()&&this._handleEvent("onerror",a.getChild("error")),this.disconnect()):this._handleEvent("onconnect")},JSJaCConnection.prototype._doSASLAuth=function(){if("nonsasl"==this.authtype||"anonymous"==this.authtype)return!1;if("undefined"!=typeof this.username&&null!=this.username&&""!=this.username||"saslanon"!=this.authtype){if(this._allow_scram&&this.mechs["SCRAM-SHA-1"]){this.oDbg.log("SASL using mechanism 'SCRAM-SHA-1'",2),this._clientFirstMessageBare="n="+this.username.replace(/=/g,"=3D").replace(/,/g,"=2C")+",r="+JSJaCUtils.cnonce(16);var a;a=this.authzid?"n,a="+this.authzid.replace(/=/g,"=3D").replace(/,/g,"=2C")+",":"n,,";var b=a+this._clientFirstMessageBare;return this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='SCRAM-SHA-1'>"+b64encode(b)+"</auth>",this._doSASLAuthScramSha1S1)}if(this._allow_plain&&this.mechs.PLAIN){this.oDbg.log("SASL using mechanism 'PLAIN'",2);var c=this.authzid+String.fromCharCode(0)+this.username+String.fromCharCode(0)+this.pass;return this.oDbg.log("authenticating with '"+c+"'",2),c=b64encode(c),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='PLAIN'>"+c+"</auth>",this._doSASLAuthDone)}this.oDbg.log("No SASL mechanism applied",1),this.authtype="nonsasl"}else{if(this.mechs.ANONYMOUS)return this.oDbg.log("SASL using mechanism 'ANONYMOUS'",2),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='ANONYMOUS'/>",this._doSASLAuthDone);this.oDbg.log("SASL ANONYMOUS requested but not supported",1)}return!1},JSJaCConnection.prototype._doSASLAuthScramSha1S1=function(a){if("challenge"!=a.nodeName)this.oDbg.log("challenge missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var b=b64decode(a.firstChild.nodeValue);this.oDbg.log("got challenge: "+b,2);var c={},d=b.split(",");for(var e in d){var f=d[e].substring(2);c[d[e].substring(0,1)]=f}for(var i,g=str2rstr_utf8(this.pass),h=b64decode_bin(c.s)+"\x00\x00\x00",j=parseInt(c.i,10),k=0;j>k;k++)h=rstr_hmac_sha1(g,h),i=JSJaCUtils.xor(i,h);var l;l=this.authzid?"n,a="+this.authzid.replace(/=/g,"=3D").replace(/,/g,"=2C")+",":"n,,";var m="c="+b64encode(l)+",r="+c.r;this._saltedPassword=i;var n=rstr_hmac_sha1(this._saltedPassword,"Client Key"),o=rstr_sha1(n);this._authMessage=this._clientFirstMessageBare+","+b+","+m;var p=rstr_hmac_sha1(o,str2rstr_utf8(this._authMessage)),q=JSJaCUtils.xor(n,p),r=m+",p="+rstr2b64(q);this.oDbg.log("response: "+r,2),this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>"+b64encode(r)+"</response>",this._doSASLAuthScramSha1S2)}},JSJaCConnection.prototype._doSASLAuthScramSha1S2=function(a){if("success"!=a.nodeName)this.oDbg.log("auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var b=b64decode(a.firstChild.nodeValue);this.oDbg.log("got success: "+b,2);var c={},d=b.split(",");for(var e in d){var f=d[e].substring(2);c[d[e].substring(0,1)]=f}var g=rstr_hmac_sha1(this._saltedPassword,"Server Key"),h=rstr_hmac_sha1(g,str2rstr_utf8(this._authMessage)),i=b64decode_bin(c.v);h!==i?(this.oDbg.log("server auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()):this._reInitStream(JSJaC.bind(this._doStreamBind,this))}},JSJaCConnection.prototype._doSASLAuthDigestMd5S1=function(a){if("challenge"!=a.nodeName)this.oDbg.log("challenge missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var c,b=b64decode(a.firstChild.nodeValue);if(this.oDbg.log("got challenge: "+b,2),c=b.indexOf('nonce="'),-1===c)return this.oDbg.log("no valid nonce found, aborting",1),void this.disconnect();this._nonce=b.substring(c+7),this._nonce=this._nonce.substring(0,this._nonce.indexOf('"')),this.oDbg.log("nonce: "+this._nonce,2),c=b.indexOf('realm="'),-1!==c&&(this._realm=b.substring(c+7),this._realm=this._realm.substring(0,this._realm.indexOf('"'))),this._realm=this._realm||this.domain,this.oDbg.log("realm: "+this._realm,2),this._digest_uri="xmpp/"+this.domain,this._cnonce=JSJaCUtils.cnonce(14),this._nc="00000001";var d=this.username+":"+this._realm+":"+this.pass,e=rstr_md5(str2rstr_utf8(d)),f=e+":"+this._nonce+":"+this._cnonce;this.authzid&&(f=f+":"+this.authzid);var g=rstr2hex(rstr_md5(f)),h="AUTHENTICATE:"+this._digest_uri,i=hex_md5(h),j=hex_md5(g+":"+this._nonce+":"+this._nc+":"+this._cnonce+":auth:"+i),k='username="'+this.username+'",realm="'+this._realm+'",nonce="'+this._nonce+'",cnonce="'+this._cnonce+'",nc='+this._nc+',qop=auth,digest-uri="'+this._digest_uri+'",response='+j+",charset=utf-8";this.authzid&&(k='authzid="'+this.authzid+'",'+k),this.oDbg.log("response: "+k,2),this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>"+b64encode(k)+"</response>",this._doSASLAuthDigestMd5S2)}},JSJaCConnection.prototype._doSASLAuthDigestMd5S2=function(a){if("failure"==a.nodeName)return a.xml?this.oDbg.log("auth error: "+a.xml,1):this.oDbg.log("auth error",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),void this.disconnect();var b=b64decode(a.firstChild.nodeValue);this.oDbg.log("response: "+b,2);var c=b.substring(b.indexOf("rspauth=")+8);this.oDbg.log("rspauth: "+c,2);var d=this.username+":"+this._realm+":"+this.pass,e=rstr_md5(str2rstr_utf8(d)),f=e+":"+this._nonce+":"+this._cnonce;this.authzid&&(f=f+":"+this.authzid);var g=rstr2hex(rstr_md5(f)),h=":"+this._digest_uri,i=hex_md5(h),j=hex_md5(g+":"+this._nonce+":"+this._nc+":"+this._cnonce+":auth:"+i);return this.oDbg.log("rsptest: "+j,2),j!=c?(this.oDbg.log("SASL Digest-MD5: server repsonse with wrong rspauth",1),void this.disconnect()):void("success"==a.nodeName?this._reInitStream(JSJaC.bind(this._doStreamBind,this)):this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'/>",this._doSASLAuthDone))},JSJaCConnection.prototype._doSASLAuthDone=function(a){"success"!=a.nodeName?(this.oDbg.log("auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()):this._reInitStream(JSJaC.bind(this._doStreamBind,this))},JSJaCConnection.prototype._doStreamBind=function(){var a=new JSJaCIQ;a.setIQ(null,"set","bind_1"),a.appendNode("bind",{xmlns:NS_BIND},[["resource",this.resource]]),this.oDbg.log(a.xml()),this.send(a,this._doXMPPSess)},JSJaCConnection.prototype._doXMPPSess=function(a){return"result"!=a.getType()||"error"==a.getType()?(this.disconnect(),void("error"==a.getType()&&this._handleEvent("onerror",a.getChild("error")))):(this.fulljid=a.getChildVal("jid"),this.jid=this.fulljid.substring(0,this.fulljid.lastIndexOf("/")),a=new JSJaCIQ,a.setIQ(null,"set","sess_1"),a.appendNode("session",{xmlns:NS_SESSION},[]),this.oDbg.log(a.xml()),void this.send(a,this._doXMPPSessDone))},JSJaCConnection.prototype._doXMPPSessDone=function(a){return"result"!=a.getType()||"error"==a.getType()?(this.disconnect(),void("error"==a.getType()&&this._handleEvent("onerror",a.getChild("error")))):void this._handleEvent("onconnect")},JSJaCConnection.prototype._handleEvent=function(a,b){if(a=a.toLowerCase(),this.oDbg.log("incoming event '"+a+"'",3),this._events[a]){this.oDbg.log("handling event '"+a+"'",2);for(var c=0;c<this._events[a].length;c++){var d=this._events[a][c];if("function"==typeof d.handler)if(b){if("*"!=d.ns&&b.ns!=d.ns)continue;if("*"!=d.type&&b.type!=d.type)continue;if(this.oDbg.log(d.ns+"/"+d.type+" => match for handler "+d.handler,3),d.handler(b))break}else if(d.handler())break}}},JSJaCConnection.prototype._handlePID=function(a){if(!a.id)return!1;var b=this.jid,c=a.id;if(this._regIDs[b]&&this._regIDs[b][c]){this.oDbg.log("handling id "+c,3);var d=this._regIDs[b][c];return d.cb.call(this,a,d.arg)===!1?!1:(delete this._regIDs[b][c],!0)}return this.oDbg.log("not handling id '"+c+"' from jid "+b,1),!1},JSJaCConnection.prototype._handleResponse=function(a){var b=this._parseResponse(a);if(b){if(this._sendRawCallbacks.length){var c=this._sendRawCallbacks[0];this._sendRawCallbacks=this._sendRawCallbacks.slice(1,this._sendRawCallbacks.length),c.fn.call(this,b,c.arg)}this._inQ=this._inQ.concat(b)}},JSJaCConnection.prototype._parseStreamFeatures=function(a){if(!a)return this.oDbg.log("nothing to parse ... aborting",1),!1;var b,c;if(a.getElementsByTagNameNS)b=a.getElementsByTagNameNS(NS_STREAM,"error").item(0);else{var d=a.getElementsByTagName("error");for(c=0;c<d.length;c++)if(d.item(c).namespaceURI==NS_STREAM||d.item(c).getAttribute("xmlns")==NS_STREAM){b=d.item(c);break}}if(b)return this._setStatus("internal_server_error"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),!1;this.mechs={};var e=a.getElementsByTagName("mechanisms");if(!e.length)return!1;for(this.has_sasl=!1,c=0;c<e.length;c++)if(e.item(c).getAttribute("xmlns")==NS_SASL){this.has_sasl=!0;for(var f=e.item(c).getElementsByTagName("mechanism"),g=0;g<f.length;g++)this.mechs[f.item(g).firstChild.nodeValue]=!0;break}return this.has_sasl?(this.oDbg.log("SASL detected",2),!0):(this.oDbg.log("No support for SASL detected",2),!0)},JSJaCConnection.prototype._process=function(a){if(!this.connected())return this.oDbg.log("Connection lost ...",1),void(this._interval&&clearInterval(this._interval));this.setPollInterval(a),this._timeout&&clearTimeout(this._timeout);var b=this._getFreeSlot();if(!(0>b)){if("undefined"!=typeof this._req[b]&&"undefined"!=typeof this._req[b].r&&4!=this._req[b].r.readyState)return void this.oDbg.log("Slot "+b+" is not ready");if(!this.isPolling()&&0===this._pQueue.length&&this._req[(b+1)%2]&&4!=this._req[(b+1)%2].r.readyState)return void this.oDbg.log("all slots busy, standby ...",2);this.isPolling()||this.oDbg.log("Found working slot at "+b,2);var c=this._getRequestPacket();c instanceof JumpPacket?this._req[b]=this._setupJumpRequest(!0):this._req[b]=this._setupRequest(!0),this._req[b].r.onreadystatechange=JSJaC.bind(function(){this.connected()&&4==this._req[b].r.readyState&&(this.oDbg.log("async recv: "+this._req[b].r.responseText,4),this._handleResponse(this._req[b]),this._setStatus("processing"),this._pQueue.length?this._timeout=setTimeout(JSJaC.bind(this._process,this),100):(this.oDbg.log("scheduling next poll in "+this.getPollInterval()+" msec",4),this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval())))},this);try{this._req[b].r.onerror=JSJaC.bind(function(){if(this.connected()){if(this._errcnt++,this.oDbg.log("XmlHttpRequest error ("+this._errcnt+")",1),this._errcnt>JSJAC_ERR_COUNT)return void this._abort();this._setStatus("onerror_fallback"),setTimeout(JSJaC.bind(this._repeat,this),JSJAC_RETRYDELAY)}},this)}catch(d){}"undefined"!=typeof this._rid&&(this._req[b].rid=this._rid),c instanceof JumpPacket?this._buildAndSend(c,this._req[b].r):this._req[b].r.send(c&&c.xml?c.xml:this._getRequestString())}},JSJaCConnection.prototype._registerPID=function(a,b,c){this.oDbg.log("registering id for packet "+JSON.stringify(a.content),3);var d=a.content.id;if(!d)return this.oDbg.log("id missing",1),!1;if("function"!=typeof b)return this.oDbg.log("callback is not a function",1),!1;var e=this.jid;return this._regIDs[e]||(this._regIDs[e]={}),null!=this._regIDs[e][d]?(this.oDbg.log("id already registered: "+d,1),!1):(this._regIDs[e][d]={cb:b,arg:c,ts:JSJaCUtils.now()},this.oDbg.log("registered id "+d,3),this._cleanupRegisteredPIDs(),!0)},JSJaCConnection.prototype._cleanupRegisteredPIDs=function(){var a=Date.now();for(var b in this._regIDs)if(this._regIDs.hasOwnProperty(b))for(var c in this._regIDs[b])this._regIDs[b].hasOwnProperty(c)&&this._regIDs[b][c].ts+JSJAC_REGID_TIMEOUT<a&&(this.oDbg.log("deleting registered id '"+c+"' due to timeout",1),delete this._regIDs[b][c])},JSJaCConnection.prototype._prepSendEmpty=function(a,b){return function(){b._sendEmpty(JSJaC.bind(a,b))}},JSJaCConnection.prototype._sendEmpty=function(a){var b=this._getFreeSlot();this._req[b]=this._setupRequest(!0),this._req[b].r.onreadystatechange=JSJaC.bind(function(){4==this._req[b].r.readyState&&(this.oDbg.log("async recv: "+this._req[b].r.responseText,4),a(this._req[b].r))},this),"undefined"!=typeof this._req[b].r.onerror&&(this._req[b].r.onerror=JSJaC.bind(function(){this.oDbg.log("XmlHttpRequest error",1)},this));var c=this._getRequestString();this.oDbg.log("sending: "+c,4),this._req[b].r.send(c)},JSJaCConnection.prototype._sendJumpPacket=function(a,b,c){return b&&this._sendRawCallbacks.push({fn:b,arg:c}),this._pQueue.push(a),this._process(),!0},JSJaCConnection.prototype._sendRaw=function(a,b,c){return b&&this._sendRawCallbacks.push({fn:b,arg:c}),this._pQueue.push(a),this._process(),!0},JSJaCConnection.prototype._setStatus=function(a){a&&""!==a&&a!=this._status&&(this._status=a,this._handleEvent("onstatuschanged",a),this._handleEvent("status_changed",a))},JSJaCConnection.prototype._buildAndSend=function(a,b){var c=null,d=null==a.content||"undefined"==typeof a.content,e=JSON.stringify(a.content);
c=this._stringToBytes(e);var f=new Uint8Array(PACKET_HEADER_SIZE);f.set(this._numToBytes(a.sFrame,PACKET_STRUCT.CONSOLE_FRAME.SIZE),PACKET_STRUCT.CONSOLE_FRAME.START),f.set(this._numToBytes(a.opcode,PACKET_STRUCT.OPCODE.SIZE),PACKET_STRUCT.OPCODE.START),d?f.set(this._numToBytes(0,PACKET_STRUCT.PACKET_LEN.SIZE),PACKET_STRUCT.PACKET_LEN.START):f.set(this._numToBytes(c.length,PACKET_STRUCT.PACKET_LEN.SIZE),PACKET_STRUCT.PACKET_LEN.START),f.set(this._numToBytes(a.version,PACKET_STRUCT.VERSION.SIZE),PACKET_STRUCT.VERSION.START),f.set(this._numToBytes(a.seqId,PACKET_STRUCT.SEQ_ID.SIZE),PACKET_STRUCT.SEQ_ID.START);var g;g=d?f:this._concatUint8Array(f,new Uint8Array(c));var h=g.subarray(0,g.byteLength),i=arr2b64(h);b.send(i)},JSJaCConnection.prototype._validateCallbackable=function(a){return this._isIQPacket(a.opcode)||this._isMessagePacket(a.opcode)||this._isPresencePacket(a.opcode)},JSJaCConnection.prototype._isMessagePacket=function(a){return a>=OPCODE.MESSAGE_RANGE.START&&a<OPCODE.MESSAGE_RANGE.END},JSJaCConnection.prototype._isIQPacket=function(a){return a>=OPCODE.IQ_RANGE.START&&a<OPCODE.IQ_RANGE.END},JSJaCConnection.prototype._isPresencePacket=function(a){return a>=OPCODE.PRESENCE_RANGE.START&&a<OPCODE.PRESENCE_RANGE.END},JSJaCConnection.prototype._concatUint8Array=function(a,b){var c=new Uint8Array(a.length+b.length);return c.set(a,0),c.set(b,a.length),c},JSJaCConnection.prototype._numToBytes=function(a,b){var c=new Uint8Array(b),d=b;do c[--d]=255&a,a>>=8;while(d);return c},JSJaCConnection.prototype._uint8ArrayToString=function(a){var b,c,d,e,f,g;for(b="",d=a.length,c=0;d>c;)switch(e=a[c++],e>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:b+=String.fromCharCode(e);break;case 12:case 13:f=a[c++],b+=String.fromCharCode((31&e)<<6|63&f);break;case 14:f=a[c++],g=a[c++],b+=String.fromCharCode((15&e)<<12|(63&f)<<6|(63&g)<<0)}return b},JSJaCConnection.prototype._bytesToInteger=function(a){for(var b=0,c=0;c<a.length;++c)b+=a[c],c<a.length-1&&(b<<=8);return b},JSJaCConnection.prototype._stringToBytes=function(a){for(var b=[],c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b.push(d):2048>d?b.push(192|d>>6,128|63&d):55296>d||d>=57344?b.push(224|d>>12,128|d>>6&63,128|63&d):(c++,d=65536+((1023&d)<<10|1023&a.charCodeAt(c)),b.push(240|d>>18,128|d>>12&63,128|d>>6&63,128|63&d))}return b},JSJaCConnection.prototype._getAuthPacket=function(){return new JumpPacket({usr:this.username,atk:this.pass,br:this.resource},OPCODE.AUTH.SEND)};var NS_ORGANIZATION="http://jabber.org/protocol/org",NS_DISCO_ITEMS="http://jabber.org/protocol/disco#items",NS_DISCO_INFO="http://jabber.org/protocol/disco#info",NS_VCARD="vcard-temp",NS_VCARD_UPDATE="vcard-temp:x:update",NS_AUTH="jabber:iq:auth",NS_AUTH_ERROR="jabber:iq:auth:error",NS_REGISTER="jabber:iq:register",NS_SEARCH="jabber:iq:search",NS_ROSTER="jabber:iq:roster",NS_PUBACCOUNT="jabber:iq:pubaccount",NS_PRIVACY="jabber:iq:privacy",NS_PRIVATE="jabber:iq:private",NS_VERSION="jabber:iq:version",NS_TIME="jabber:iq:time",NS_TIME_NEW="urn:xmpp:time",NS_LAST="jabber:iq:last",NS_XDATA="jabber:x:data",NS_IQDATA="jabber:iq:data",NS_DELAY="jabber:x:delay",NS_DELAY_NEW="urn:xmpp:delay",NS_RECEIPTS="urn:xmpp:receipts",NS_EXPIRE="jabber:x:expire",NS_EVENT="jabber:x:event",NS_XCONFERENCE="jabber:x:conference",NS_PING="urn:xmpp:ping",NS_BOOKSMARKS="storage:bookmarks",NS_FORWARD_0="urn:xmpp:forward:0",NS_CARBONS_2="urn:xmpp:carbons:2",NS_CHAT_STATES="http://jabber.org/protocol/chatstates",NS_STATS="http://jabber.org/protocol/stats",NS_MUC="http://jabber.org/protocol/muc",NS_MUC_USER="http://jabber.org/protocol/muc#user",NS_MUC_ADMIN="http://jabber.org/protocol/muc#admin",NS_MUC_OWNER="http://jabber.org/protocol/muc#owner",NS_PUBSUB="http://jabber.org/protocol/pubsub",NS_PUBSUB_EVENT="http://jabber.org/protocol/pubsub#event",NS_PUBSUB_OWNER="http://jabber.org/protocol/pubsub#owner",NS_PUBSUB_ERRORS="http://jabber.org/protocol/pubsub#errors",NS_PUBSUB_NMI="http://jabber.org/protocol/pubsub#node-meta-info",NS_COMMANDS="http://jabber.org/protocol/commands",NS_CAPS="http://jabber.org/protocol/caps",NS_STREAM="http://etherx.jabber.org/streams",NS_CLIENT="jabber:client",NS_BOSH="http://jabber.org/protocol/httpbind",NS_XBOSH="urn:xmpp:xbosh",NS_STANZAS="urn:ietf:params:xml:ns:xmpp-stanzas",NS_STREAMS="urn:ietf:params:xml:ns:xmpp-streams",NS_TLS="urn:ietf:params:xml:ns:xmpp-tls",NS_SASL="urn:ietf:params:xml:ns:xmpp-sasl",NS_SESSION="urn:ietf:params:xml:ns:xmpp-session",NS_BIND="urn:ietf:params:xml:ns:xmpp-bind",NS_FEATURE_IQAUTH="http://jabber.org/features/iq-auth",NS_FEATURE_IQREGISTER="http://jabber.org/features/iq-register",NS_FEATURE_COMPRESS="http://jabber.org/features/compress",NS_COMPRESS="http://jabber.org/protocol/compress",ERR_BAD_REQUEST=STANZA_ERROR("400","modify","bad-request"),ERR_CONFLICT=STANZA_ERROR("409","cancel","conflict"),ERR_FEATURE_NOT_IMPLEMENTED=STANZA_ERROR("501","cancel","feature-not-implemented"),ERR_FORBIDDEN=STANZA_ERROR("403","auth","forbidden"),ERR_GONE=STANZA_ERROR("302","modify","gone"),ERR_INTERNAL_SERVER_ERROR=STANZA_ERROR("500","wait","internal-server-error"),ERR_ITEM_NOT_FOUND=STANZA_ERROR("404","cancel","item-not-found"),ERR_JID_MALFORMED=STANZA_ERROR("400","modify","jid-malformed"),ERR_NOT_ACCEPTABLE=STANZA_ERROR("406","modify","not-acceptable"),ERR_NOT_ALLOWED=STANZA_ERROR("405","cancel","not-allowed"),ERR_NOT_AUTHORIZED=STANZA_ERROR("401","auth","not-authorized"),ERR_PAYMENT_REQUIRED=STANZA_ERROR("402","auth","payment-required"),ERR_RECIPIENT_UNAVAILABLE=STANZA_ERROR("404","wait","recipient-unavailable"),ERR_REDIRECT=STANZA_ERROR("302","modify","redirect"),ERR_REGISTRATION_REQUIRED=STANZA_ERROR("407","auth","registration-required"),ERR_REMOTE_SERVER_NOT_FOUND=STANZA_ERROR("404","cancel","remote-server-not-found"),ERR_REMOTE_SERVER_TIMEOUT=STANZA_ERROR("504","wait","remote-server-timeout"),ERR_RESOURCE_CONSTRAINT=STANZA_ERROR("500","wait","resource-constraint"),ERR_SERVICE_UNAVAILABLE=STANZA_ERROR("503","cancel","service-unavailable"),ERR_SUBSCRIPTION_REQUIRED=STANZA_ERROR("407","auth","subscription-required"),ERR_UNEXPECTED_REQUEST=STANZA_ERROR("400","wait","unexpected-request");JSJaCCookie.read=function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(b))return new JSJaCCookie(a,JSJaCCookie._unescape(e.substring(b.length,e.length)))}throw new JSJaCCookieException("Cookie not found")},JSJaCCookie.get=function(a){return JSJaCCookie.read(a).getValue()},JSJaCCookie.remove=function(a){JSJaCCookie.read(a).erase()},JSJaCCookie._escape=function(a){return a.replace(/;/g,"%3AB")},JSJaCCookie._unescape=function(a){return a.replace(/%3AB/g,";")},JSJaCDebugger.prototype.log=function(a,b){},JSJaCHttpBindingConnection.prototype=new JSJaCConnection,JSJaCHttpBindingConnection.prototype.inherit=function(a){if(a.jid){var b=new JSJaCJID(a.jid);this.domain=b.getDomain(),this.username=b.getNode(),this.resource=b.getResource()}else this.domain=a.domain||"localhost",this.username=a.username,this.resource=a.resource;this._sid=a.sid,this._rid=a.rid,this._min_polling=a.polling,this._inactivity=a.inactivity,this._setHold(a.requests-1),this.setPollInterval(this._timerval),a.wait&&(this._wait=a.wait),this._connected=!0,this._handleEvent("onconnect"),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL),this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval())},JSJaCHttpBindingConnection.prototype.setPollInterval=function(a){return a&&!isNaN(a)&&(this.isPolling()?this._min_polling&&a<1e3*this._min_polling?this._timerval=1e3*this._min_polling:this._inactivity&&a>1e3*this._inactivity?this._timerval=1e3*this._inactivity:this._timerval=a:this._timerval=100),this._timerval},JSJaCHttpBindingConnection.prototype.isPolling=function(){return 0===this._hold},JSJaCHttpBindingConnection.prototype._getFreeSlot=function(){for(var a=0;a<this._hold+1;a++)if("undefined"==typeof this._req[a]||"undefined"==typeof this._req[a].r||4==this._req[a].r.readyState)return a;return-1},JSJaCHttpBindingConnection.prototype._getHold=function(){return this._hold},JSJaCHttpBindingConnection.prototype._getRequestPacket=function(a,b){var c;if(this._rid<this._last_rid&&"undefined"!=typeof this._last_requests[this._rid])c=this._last_requests[this._rid];else{this._pQueue.length&&(c=this._pQueue[0],this._pQueue=this._pQueue.slice(1,this._pQueue.length)),this._last_requests[this._rid]={},this._last_requests[this._rid]=c,this._last_rid=this._rid;for(var d in this._last_requests)this._last_requests.hasOwnProperty(d)&&d<this._rid-this._hold&&delete this._last_requests[d]}return c},JSJaCHttpBindingConnection.prototype._getRequestString=function(a,b){a=a||"";var c="";if(this._rid<=this._last_rid&&"undefined"!=typeof this._last_requests[this._rid])c=this._last_requests[this._rid].xml;else{for(var d="";this._pQueue.length;){var e=this._pQueue[0];d+=e,this._pQueue=this._pQueue.slice(1,this._pQueue.length)}c="<body rid='"+this._rid+"' sid='"+this._sid+"' xmlns='http://jabber.org/protocol/httpbind'",JSJAC_HAVEKEYS&&(c+=" key='"+this._keys.getKey()+"'",this._keys.lastKey()&&(this._keys=new JSJaCKeys(hex_sha1,this.oDbg),c+=" newkey='"+this._keys.getKey()+"'")),b?c+=" type='terminate'":this._reinit&&(JSJACHBC_USE_BOSH_VER&&(c+=" xml:lang='"+this._xmllang+"' xmpp:restart='true' xmlns:xmpp='urn:xmpp:xbosh' to='"+this.domain+"'"),this._reinit=!1),c+=""!==d||""!==a?">"+a+d+"</body>":"/>",this._last_requests[this._rid]={},this._last_requests[this._rid].xml=c,this._last_rid=this._rid;for(var f in this._last_requests)this._last_requests.hasOwnProperty(f)&&f<this._rid-this._hold&&delete this._last_requests[f]}return c},JSJaCHttpBindingConnection.prototype._getInitialRequestString=function(){var a="<body content='text/xml; charset=utf-8' hold='"+this._hold+"' xmlns='http://jabber.org/protocol/httpbind' to='"+this.authhost+"' wait='"+this._wait+"' rid='"+this._rid+"'";if(this.host&&this.port&&(a+=" route='xmpp:"+this.host+":"+this.port+"'"),JSJAC_HAVEKEYS){this._keys=new JSJaCKeys(hex_sha1,this.oDbg);var b=this._keys.getKey();a+=" newkey='"+b+"'"}return a+=" xml:lang='"+this._xmllang+"'",JSJACHBC_USE_BOSH_VER&&(a+=" ver='"+JSJACHBC_BOSH_VERSION+"'",a+=" xmlns:xmpp='urn:xmpp:xbosh'",("sasl"==this.authtype||"saslanon"==this.authtype)&&(a+=" xmpp:version='1.0'")),a+="/>"},JSJaCHttpBindingConnection.prototype._getStreamID=function(a){if(this.oDbg.log(a.responseText,4),!a.responseXML||!a.responseXML.documentElement)return void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));var b=a.responseXML.documentElement;return"terminate"==b.getAttribute("type")?void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")):(b.getAttribute("authid")&&(this.streamid=b.getAttribute("authid"),this.oDbg.log("got streamid: "+this.streamid,2)),this._parseStreamFeatures(b)?(this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval()),void(this.register?this._doInBandReg():this._doAuth())):void this._sendEmpty(JSJaC.bind(this._getStreamID,this)))},JSJaCHttpBindingConnection.prototype._getSuspendVars=function(){return"host,port,_rid,_last_rid,_wait,_min_polling,_inactivity,_hold,_last_requests,_pause".split(",")},JSJaCHttpBindingConnection.prototype._handleInitialResponse=function(a){try{this.oDbg.log(a.getAllResponseHeaders(),4),this.oDbg.log(a.responseText,4)}catch(b){this.oDbg.log("No response",4)}if(200!=a.status||!a.responseXML)return this.oDbg.log("initial response broken (status: "+a.status+")",1),void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));var c=a.responseXML.documentElement;return c&&"body"==c.tagName&&c.namespaceURI==NS_BOSH?"terminate"==c.getAttribute("type")?(this.oDbg.log("invalid response:\n"+a.responseText,1),clearTimeout(this._timeout),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))):(this._sid=c.getAttribute("sid"),this.oDbg.log("got sid: "+this._sid,2),c.getAttribute("polling")&&(this._min_polling=c.getAttribute("polling")),c.getAttribute("inactivity")&&(this._inactivity=c.getAttribute("inactivity")),c.getAttribute("requests")&&this._setHold(c.getAttribute("requests")-1),this.oDbg.log("set hold to "+this._getHold(),2),c.getAttribute("ver")&&(this._bosh_version=c.getAttribute("ver")),c.getAttribute("maxpause")&&(this._pause=Number.min(c.getAttribute("maxpause"),JSJACHBC_MAXPAUSE)),this.setPollInterval(this._timerval),this._connected=!0,this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),void this._getStreamID(a)):(this.oDbg.log("no body element or incorrect body in initial response",1),void this._handleEvent("onerror",JSJaCError("500","wait","internal-service-error")))},JSJaCHttpBindingConnection.prototype._parseResponse=function(a){if(!this.connected()||!a)return null;var b=a.r;try{if(404==b.status||403==b.status)return this._abort(),null;if(200!=b.status||!b.responseText&&""!=b.responseText){this._errcnt++;var c="invalid response ("+b.status+"):\n"+b.getAllResponseHeaders()+"\n"+b.responseText;return b.responseXML||(c+="\nResponse failed to parse!"),this.oDbg.log(c,1),this._errcnt>JSJAC_ERR_COUNT?(this._abort(),null):(this.connected()&&(this.oDbg.log("repeating ("+this._errcnt+")",1),this._setStatus("proto_error_fallback"),setTimeout(JSJaC.bind(this._repeat,this),this.getPollInterval())),null)}}catch(d){return this.oDbg.log("XMLHttpRequest error: status not available",1),this._errcnt++,this._errcnt>JSJAC_ERR_COUNT?this._abort():this.connected()&&(this.oDbg.log("repeating ("+this._errcnt+")",1),this._setStatus("proto_error_fallback"),setTimeout(JSJaC.bind(this._repeat,this),this.getPollInterval())),null}for(var e="<"==b.responseText[0]?b.responseText:b64decode(b.responseText),f=[],g=0,h=e.length;PACKET_HEADER_SIZE>g&&h>=PACKET_HEADER_SIZE;g++)f[g]=e.charCodeAt(g);var i=new Uint8Array(f),j=i.subarray(PACKET_STRUCT.OPCODE.START,PACKET_STRUCT.OPCODE.END),k=OPCODE_MAP.RECV.get(this._bytesToInteger(j)),l=e.slice(PACKET_HEADER_SIZE);if("undefined"!=typeof a.rid&&this._last_requests[a.rid]){if(this._last_requests[a.rid].handled)return this.oDbg.log("already handled "+a.rid,2),null;this._last_requests[a.rid].handled=!0}return this._errcnt=0,k?{event:k,body:l?JSON.parse(l):null}:null},JSJaCHttpBindingConnection.prototype._reInitStream=function(a){this._reinit=!0,this._sendEmpty(this._prepReInitStreamWait(a))},JSJaCHttpBindingConnection.prototype._prepReInitStreamWait=function(a){return JSJaC.bind(function(b){this._reInitStreamWait(b,a)},this)},JSJaCHttpBindingConnection.prototype._reInitStreamWait=function(a,b){this.oDbg.log("checking for stream features");var d,e,c=a.responseXML.documentElement;if(this.oDbg.log(c),c.getElementsByTagNameNS)this.oDbg.log("checking with namespace"),d=c.getElementsByTagNameNS(NS_STREAM,"features").item(0),d&&(e=d.getElementsByTagNameNS(NS_BIND,"bind").item(0));else{var g,h,f=c.getElementsByTagName("stream:features");for(g=0,h=f.length;h>g;g++)if(f.item(g).namespaceURI==NS_STREAM||f.item(g).getAttribute("xmlns")==NS_STREAM){d=f.item(g);break}if(d)for(e=d.getElementsByTagName("bind"),g=0,h=e.length;h>g;g++)if(e.item(g).namespaceURI==NS_BIND||e.item(g).getAttribute("xmlns")==NS_BIND){e=e.item(g);break}}this.oDbg.log(d),this.oDbg.log(e),d?e?b():(this.oDbg.log("no bind feature - giving up",1),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect")):this._sendEmpty(this._prepReInitStreamWait(b))},JSJaCHttpBindingConnection.prototype._repeat=function(){this._rid>=this._last_rid&&(this._rid=this._last_rid-1),this._process()},JSJaCHttpBindingConnection.prototype._resume=function(){0===this._pause?this._repeat():this._process()},JSJaCHttpBindingConnection.prototype._setHold=function(a){return!a||isNaN(a)||0>a?a=0:a>JSJACHBC_MAX_HOLD&&(a=JSJACHBC_MAX_HOLD),this._hold=a,this._hold},JSJaCHttpBindingConnection.prototype._setupJumpRequest=function(a){var b={},c=XmlHttp.create();this._rid++;try{c.open("POST",this._httpbase+"?rid="+this._rid+"&sid="+this._sid+"&useBase64=1",a),c.setRequestHeader("Content-Type","text/xml; charset=utf-8")}catch(d){this.oDbg.log(d,1)}return b.r=c,b.rid=this._rid,b},JSJaCHttpBindingConnection.prototype._setupRequest=function(a){var b={},c=XmlHttp.create();this._rid++;try{c.open("POST",this._httpbase,a),c.setRequestHeader("Content-Type","text/xml; charset=utf-8")}catch(d){this.oDbg.log(d,1)}return b.r=c,b.rid=this._rid,b},JSJaCHttpBindingConnection.prototype._suspend=function(){if(0!==this._pause){var a=this._getFreeSlot();this._req[a]=this._setupRequest(!1);var b="<body pause='"+this._pause+"' xmlns='http://jabber.org/protocol/httpbind' sid='"+this._sid+"' rid='"+this._rid+"'";for(JSJAC_HAVEKEYS&&(b+=" key='"+this._keys.getKey()+"'",this._keys.lastKey()&&(this._keys=new JSJaCKeys(hex_sha1,this.oDbg),b+=" newkey='"+this._keys.getKey()+"'")),b+=">";this._pQueue.length;){var c=this._pQueue[0];b+=c,this._pQueue=this._pQueue.slice(1,this._pQueue.length)}b+="</body>",this.oDbg.log("Disconnecting: "+b,4),this._req[a].r.send(b)}},JSJaCHttpPollingConnection.prototype=new JSJaCConnection,JSJaCHttpPollingConnection.prototype.isPolling=function(){return!0},JSJaCHttpPollingConnection.prototype._getFreeSlot=function(){return"undefined"==typeof this._req[0]||"undefined"==typeof this._req[0].r||4==this._req[0].r.readyState?0:-1},JSJaCHttpPollingConnection.prototype._getInitialRequestString=function(){var a="0";if(JSJAC_HAVEKEYS){this._keys=new JSJaCKeys(b64_sha1,this.oDbg);var b=this._keys.getKey();a+=";"+b}var c=this.domain;return this.authhost&&(c=this.authhost),a+=",<stream:stream to='"+c+"' xmlns='jabber:client' xmlns:stream='http://etherx.jabber.org/streams'",("sasl"==this.authtype||"saslanon"==this.authtype)&&(a+=" version='1.0'"),a+=">"},JSJaCHttpPollingConnection.prototype._getRequestString=function(a,b){var c=this._sid;for(JSJAC_HAVEKEYS&&(c+=";"+this._keys.getKey(),this._keys.lastKey()&&(this._keys=new JSJaCKeys(b64_sha1,this.oDbg),c+=";"+this._keys.getKey())),c+=",",a&&(c+=a);this._pQueue.length;)c+=this._pQueue[0],this._pQueue=this._pQueue.slice(1,this._pQueue.length);return b&&(c+="</stream:stream>"),c},JSJaCHttpPollingConnection.prototype._getStreamID=function(){if(""===this._req[0].r.responseText)return this.oDbg.log("waiting for stream id",2),void(this._timeout=setTimeout(JSJaC.bind(this._sendEmpty,this),1e3));this.oDbg.log(this._req[0].r.responseText,4),this._req[0].r.responseText.match(/id=[\'\"]([^\'\"]+)[\'\"]/)&&(this.streamid=RegExp.$1),this.oDbg.log("got streamid: "+this.streamid,2);var a;try{var b=this._req[0].r.responseText;if(b.match(/<\/stream:stream>\s*$/)||(b+="</stream:stream>"),a=XmlDocument.create("doc"),a.loadXML(b),!this._parseStreamFeatures(a))return void(this.authtype="nonsasl")}catch(c){this.oDbg.log("loadXML: "+c.toString(),1)}this._connected=!0,this.register?this._doInBandReg():this._doAuth(),this._process(this._timerval)},JSJaCHttpPollingConnection.prototype._getSuspendVars=function(){return[]},JSJaCHttpPollingConnection.prototype._handleInitialResponse=function(){this.oDbg.log(this._req[0].r.getAllResponseHeaders(),4);var a=this._req[0].r.getResponseHeader("Set-Cookie");a=a.split(";");for(var b=0;b<a.length;b++){var c=a[b].split("=");"ID"==c[0]&&(this._sid=c[1])}this.oDbg.log("got sid: "+this._sid,2),this._connected=!0,this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL),this._getStreamID()},JSJaCHttpPollingConnection.prototype._parseResponse=function(a){var b=a.r;if(!this.connected())return null;if(200!=b.status)return this.oDbg.log("invalid response ("+b.status+"):"+b.responseText+"\n"+b.getAllResponseHeaders(),1),this._setStatus("internal_server_error"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),null;this.oDbg.log(b.getAllResponseHeaders(),4);var c,d=b.getResponseHeader("Set-Cookie");if(null===d)c="-1:0";else{d=d.split(";");for(var e=0;e<d.length;e++){var f=d[e].split("=");"ID"==f[0]&&(c=f[1])}}if("undefined"!=typeof c&&-1!=c.indexOf(":0")){switch(c.substring(0,c.indexOf(":0"))){case"0":this.oDbg.log("invalid response:"+b.responseText,1);break;case"-1":this.oDbg.log("Internal Server Error",1);break;case"-2":this.oDbg.log("Bad Request",1);break;case"-3":this.oDbg.log("Key Sequence Error",1)}return this._setStatus("internal_server_error"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._handleEvent("onerror",JSJaCError("500","wait","internal-server-error")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),null}if(!b.responseText)return null;try{var g=b.responseText.replace(/<\?xml.+\?>/,"");g.match(/<stream:stream/)&&(g+="</stream:stream>");var h=JSJaCHttpPollingConnection._parseTree("<body>"+g+"</body>");return h&&"parsererror"!=h.tagName?h:(this.oDbg.log("parsererror",1),h=JSJaCHttpPollingConnection._parseTree("<stream:stream xmlns:stream='http://etherx.jabber.org/streams'>"+b.responseText),h&&"parsererror"!=h.tagName?(this.oDbg.log("stream closed",1),h.getElementsByTagName("conflict").length>0&&this._setStatus("session-terminate-conflict"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect")):this.oDbg.log("parsererror:"+h,1),h)}catch(i){this.oDbg.log("parse error:"+i.message,1)}return null},JSJaCHttpPollingConnection.prototype._reInitStream=function(a){var b=this.authhost?this.authhost:this.domain;this._sendRaw("<stream:stream xmlns:stream='http://etherx.jabber.org/streams' xmlns='jabber:client' to='"+b+"' version='1.0'>",a)},JSJaCHttpPollingConnection.prototype._repeat=function(){this._resume()},JSJaCHttpPollingConnection.prototype._resume=function(){this._process(this._timerval)},JSJaCHttpPollingConnection.prototype._setupRequest=function(a){var b=XmlHttp.create();try{b.open("POST",this._httpbase,a),b.overrideMimeType&&b.overrideMimeType("text/plain; charset=utf-8"),b.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}catch(c){this.oDbg.log(c,1)}var d={};return d.r=b,d},JSJaCHttpPollingConnection.prototype._suspend=function(){},JSJaCHttpPollingConnection._parseTree=function(a){try{var b=XmlDocument.create("body","foo");if("undefined"!=typeof b.loadXML)return b.loadXML(a),b.documentElement;if(window.DOMParser)return(new DOMParser).parseFromString(a,"text/xml").documentElement}catch(c){}return null};var JSJACJID_FORBIDDEN=['"'," ","&","'","/",":","<",">","@"];JSJaCJID.prototype.getBareJID=function(){return this.getNode()+"@"+this.getDomain()},JSJaCJID.prototype.getNode=function(){return this._node},JSJaCJID.prototype.getDomain=function(){return this._domain},JSJaCJID.prototype.getResource=function(){return this._resource},JSJaCJID.prototype.setNode=function(a){return JSJaCJID._checkNodeName(a),this._node=a||"",this},JSJaCJID.prototype.setDomain=function(a){if(!a||""===a)throw new JSJaCJIDInvalidException("domain name missing");return JSJaCJID._checkNodeName(a),this._domain=a,this},JSJaCJID.prototype.setResource=function(a){return this._resource=a||"",this},JSJaCJID.prototype.toString=function(){var a="";return this.getNode()&&""!==this.getNode()&&(a=this.getNode()+"@"),a+=this.getDomain(),this.getResource()&&""!==this.getResource()&&(a+="/"+this.getResource()),a},JSJaCJID.prototype.removeResource=function(){return this.setResource()},JSJaCJID.prototype.clone=function(){return new JSJaCJID(this.toString())},JSJaCJID.prototype.isEntity=function(a){return a="string"==typeof a?new JSJaCJID(a):a.clone(),a.removeResource(),this.clone().removeResource().toString()===a.toString()},JSJaCJID._checkNodeName=function(a){if(a&&""!==a)for(var b=0;b<JSJACJID_FORBIDDEN.length;b++)if(-1!=a.indexOf(JSJACJID_FORBIDDEN[b]))throw new JSJaCJIDInvalidException("forbidden char in nodename: "+JSJACJID_FORBIDDEN[b])},JSJaCJSON.toString=function(a){var b={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},c={array:function(a){var d,e,f,h,b=["["],g=a.length;for(f=0;g>f;f+=1)if(h=a[f],e=c[typeof h])try{h=e(h),"string"==typeof h&&(d&&(b[b.length]=","),b[b.length]=h,d=!0)}catch(i){}return b[b.length]="]",b.join("")},"boolean":function(a){return String(a)},"null":function(){return"null"},number:function(a){return isFinite(a)?String(a):"null"},object:function(a){if(a){if(a instanceof Array)return c.array(a);var d,e,f,g,b=[];b.push("{");for(f in a)if(a.hasOwnProperty(f)&&(g=a[f],e=c[typeof g]))try{g=e(g),"string"==typeof g&&(d&&(b[b.length]=","),b.push(c.string(f),":",g),d=!0)}catch(h){}return b[b.length]="}",b.join("")}return"null"},string:function(a){return/["\\\x00-\x1f]/.test(a)&&(a=a.replace(/([\x00-\x1f\\"])/g,function(a,c){var d=b[c];return d?d:(d=c.charCodeAt(),"\\u00"+Math.floor(d/16).toString(16)+(d%16).toString(16))})),'"'+a+'"'}};switch(typeof a){case"object":return c.object(a);case"array":return c.array(a)}},JSJaCJSON.parse=function(str){try{return!/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/.test(str.replace(/"(\\.|[^"\\])*"/g,""))&&eval("("+str+")")}catch(e){return!1}};var JSJACPACKET_USE_XMLNS=!0;JSJaCPacket.prototype.pType=function(){return this.name},JSJaCPacket.prototype.getDoc=function(){return this.doc},JSJaCPacket.prototype.getNode=function(){return this.getDoc()&&this.getDoc().documentElement?this.getDoc().documentElement:null},JSJaCPacket.prototype.setTo=function(a){return a?"string"==typeof a?this.getNode().setAttribute("to",a):this.getNode().setAttribute("to",a.toString()):this.getNode().removeAttribute("to"),this},JSJaCPacket.prototype.setFrom=function(a){return a?"string"==typeof a?this.getNode().setAttribute("from",a):this.getNode().setAttribute("from",a.toString()):this.getNode().removeAttribute("from"),this},JSJaCPacket.prototype.setID=function(a){return a?this.getNode().setAttribute("id",a):this.getNode().removeAttribute("id"),this},JSJaCPacket.prototype.setType=function(a){return a?this.getNode().setAttribute("type",a):this.getNode().removeAttribute("type"),this},JSJaCPacket.prototype.setXMLLang=function(a){return a?this.getNode().setAttribute("xml:lang",a):this.getNode().removeAttribute("xml:lang"),this},JSJaCPacket.prototype.getTo=function(){return this.getNode().getAttribute("to")},JSJaCPacket.prototype.getFrom=function(){return this.getNode().getAttribute("from")},JSJaCPacket.prototype.getToJID=function(){return new JSJaCJID(this.getTo())},JSJaCPacket.prototype.getFromJID=function(){return new JSJaCJID(this.getFrom())},JSJaCPacket.prototype.getID=function(){return this.getNode().getAttribute("id")},JSJaCPacket.prototype.getType=function(){return this.getNode().getAttribute("type")},JSJaCPacket.prototype.getXMLLang=function(){return this.getNode().getAttribute("xml:lang")},JSJaCPacket.prototype.getXMLNS=function(){return this.getNode().namespaceURI||this.getNode().getAttribute("xmlns")},JSJaCPacket.prototype.getChild=function(a,b){if(!this.getNode())return null;if(a=a||"*",b=b||"*",this.getNode().getElementsByTagNameNS)return this.getNode().getElementsByTagNameNS(b,a).item(0);var c=this.getNode().getElementsByTagName(a);if("*"==b)return c.item(0);for(var d=0;d<c.length;d++)if(c.item(d).namespaceURI==b||c.item(d).getAttribute("xmlns")==b)return c.item(d);return null},JSJaCPacket.prototype.getChildVal=function(a,b){var c=this.getChild(a,b),d="";if(c&&c.hasChildNodes())for(var e=0;e<c.childNodes.length;e++)c.childNodes.item(e).nodeValue&&(d+=c.childNodes.item(e).nodeValue);return d},JSJaCPacket.prototype.clone=function(){return JSJaCPacket.wrapNode(this.getNode())},JSJaCPacket.prototype.isError=function(){return"error"==this.getType()},JSJaCPacket.prototype.errorReply=function(a){var b=this.clone();return b.setTo(this.getFrom()),b.setFrom(),b.setType("error"),b.appendNode("error",{code:a.code,type:a.type},[[a.cond,{xmlns:NS_STANZAS}]]),b},JSJaCPacket.prototype.xml="undefined"!=typeof XMLSerializer?function(){var a=(new XMLSerializer).serializeToString(this.getNode());return"undefined"==typeof a&&(a=(new XMLSerializer).serializeToString(this.doc)),a}:function(){return this.getDoc().xml},JSJaCPacket.prototype._getAttribute=function(a){return this.getNode().getAttribute(a)},document.ELEMENT_NODE||(document.ELEMENT_NODE=1,document.ATTRIBUTE_NODE=2,document.TEXT_NODE=3,document.CDATA_SECTION_NODE=4,document.ENTITY_REFERENCE_NODE=5,document.ENTITY_NODE=6,document.PROCESSING_INSTRUCTION_NODE=7,document.COMMENT_NODE=8,document.DOCUMENT_NODE=9,document.DOCUMENT_TYPE_NODE=10,document.DOCUMENT_FRAGMENT_NODE=11,document.NOTATION_NODE=12),JSJaCPacket.prototype._importNode=function(a,b){switch(a.nodeType){case document.ELEMENT_NODE:var c;c=this.getDoc().createElementNS?this.getDoc().createElementNS(a.namespaceURI,a.nodeName):this.getDoc().createElement(a.nodeName);var d,e;if(a.attributes&&a.attributes.length>0)for(d=0,e=a.attributes.length;e>d;d++){var f=a.attributes.item(d);("xmlns"!=f.nodeName||null===c.getAttribute("xmlns")&&!c.namespaceURI)&&(c.setAttributeNS&&f.namespaceURI?c.setAttributeNS(f.namespaceURI,f.name,f.value):c.setAttribute(f.name,f.value))}if(b&&a.childNodes&&a.childNodes.length>0)for(d=0,e=a.childNodes.length;e>d;d++)c.appendChild(this._importNode(a.childNodes.item(d),b));return c;case document.TEXT_NODE:case document.CDATA_SECTION_NODE:case document.COMMENT_NODE:return this.getDoc().createTextNode(a.nodeValue)}},JSJaCPacket.prototype._setChildNode=function(a,b){var c=this.getChild(a),d=this.getDoc().createTextNode(b);if(c)try{c.replaceChild(d,c.firstChild)}catch(e){}else{try{c=this.getDoc().createElementNS(this.getNode().namespaceURI,a)}catch(f){c=this.getDoc().createElement(a)}this.getNode().appendChild(c),c.appendChild(d)}return c},JSJaCPacket.prototype.buildNode=function(a){return JSJaCBuilder.buildNode(this.getDoc(),a,arguments[1],arguments[2],arguments[3])},JSJaCPacket.prototype.appendNode=function(a){return"object"==typeof a?this.getNode().appendChild(a):this.getNode().appendChild(this.buildNode(a,arguments[1],arguments[2],this.getNode().namespaceURI)),this},JSJaCPresence.prototype=new JSJaCPacket,JSJaCPresence.prototype.setStatus=function(a){return this._setChildNode("status",a),this},JSJaCPresence.prototype.setShow=function(a){return("chat"==a||"away"==a||"xa"==a||"dnd"==a||"unavailable"==a)&&this._setChildNode("show",a),this},JSJaCPresence.prototype.setPriority=function(a){return this._setChildNode("priority",a),this},JSJaCPresence.prototype.setPresence=function(a,b,c){return a&&this.setShow(a),b&&this.setStatus(b),c&&this.setPriority(c),this},JSJaCPresence.prototype.getStatus=function(){return this.getChildVal("status")},JSJaCPresence.prototype.getShow=function(){return this.getChildVal("show")},JSJaCPresence.prototype.getPriority=function(){return this.getChildVal("priority")},JSJaCIQ.prototype=new JSJaCPacket,JSJaCIQ.prototype.setIQ=function(a,b,c){return a&&this.setTo(a),b&&this.setType(b),c&&this.setID(c),this},JSJaCIQ.prototype.setQuery=function(a){var b;try{b=this.getDoc().createElementNS(a,"query")}catch(c){b=this.getDoc().createElement("query"),b.setAttribute("xmlns",a)}return this.getNode().appendChild(b),b},JSJaCIQ.prototype.getQuery=function(){return this.getNode().getElementsByTagName("query").item(0)},JSJaCIQ.prototype.getQueryXMLNS=function(){return this.getQuery()?this.getQuery().namespaceURI||this.getQuery().getAttribute("xmlns"):null},JSJaCIQ.prototype.reply=function(a){
var b=this.clone();if(b.setTo(this.getFrom()),b.setFrom(),b.setType("result"),a)if("string"==typeof a)b.getChild().appendChild(b.getDoc().loadXML(a));else if(a.constructor==Array)for(var c=b.getChild(),d=0;d<a.length;d++)"string"==typeof a[d]?c.appendChild(b.getDoc().loadXML(a[d])):"object"==typeof a[d]&&c.appendChild(a[d]);else"object"==typeof a&&b.getChild().appendChild(a);return b},JSJaCMessage.prototype=new JSJaCPacket,JSJaCMessage.prototype.setBody=function(a){return this._setChildNode("body",a),this},JSJaCMessage.prototype.setSubject=function(a){return this._setChildNode("subject",a),this},JSJaCMessage.prototype.setThread=function(a){return this._setChildNode("thread",a),this},JSJaCMessage.prototype.getThread=function(){return this.getChildVal("thread")},JSJaCMessage.prototype.getBody=function(){return this.getChildVal("body")},JSJaCMessage.prototype.getSubject=function(){return this.getChildVal("subject")},JSJaCPacket.wrapNode=function(a){var b=null;switch(a.nodeName.toLowerCase()){case"presence":b=new JSJaCPresence;break;case"message":b=new JSJaCMessage;break;case"iq":b=new JSJaCIQ}return b&&(b.getDoc().replaceChild(b._importNode(a,!0),b.getNode()),null==b.getDoc().xml&&null!=a&&null!=a.xml&&(b.getDoc().xml=a.xml)),b};var JSJaCUtils={xor:function(a,b){if(!a)return b;if(!b)return a;for(var c="",d=0;d<a.length;d++)c+=String.fromCharCode(a.charCodeAt(d)^b.charCodeAt(d));return c},cnonce:function(a){for(var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c="",d=0;a>d;d++)c+=b.charAt(Math.round(Math.random((new Date).getTime())*(b.length-1)));return c},now:function(){return Date.now&&"function"==typeof Date.now?Date.now():(new Date).getTime()}};JSJaCWebSocketConnection.prototype=new JSJaCConnection,JSJaCWebSocketConnection.prototype._cleanupWebSocket=function(){null!==this._ws&&(this._ws.onclose=null,this._ws.onerror=null,this._ws.onopen=null,this._ws.onmessage=null,this._ws.close(),this._ws=null)},JSJaCWebSocketConnection.prototype.connect=function(a){return this._setStatus("connecting"),this.domain=a.domain||"localhost",this.username=a.username,this.resource=a.resource,this.pass=a.password||a.pass,this.authzid=a.authzid||"",this.register=a.register,this.authhost=a.authhost||this.domain,this.authtype=a.authtype||"sasl",this.jid=this.username+"@"+this.domain,this.fulljid=this.jid+"/"+this.resource,a.allow_plain?this._allow_plain=a.allow_plain:this._allow_plain=JSJAC_ALLOW_PLAIN,a.allow_scram?this._allow_scram=a.allow_scram:this._allow_scram=JSJAC_ALLOW_SCRAM,a.xmllang&&""!==a.xmllang?this._xmllang=a.xmllang:this._xmllang="en","undefined"==typeof WebSocket?void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")):(this._ws=new WebSocket(this._httpbase,"xmpp"),this._ws.onclose=JSJaC.bind(this._onclose,this),this._ws.onerror=JSJaC.bind(this._onerror,this),void(this._ws.onopen=JSJaC.bind(this._onopen,this)))},JSJaCWebSocketConnection.prototype._onopen=function(){var a=new JumpPacket({usr:this.username,atk:this.pass,br:this.resource},OPCODE.AUTH.SEND);this._buildAndSend(a),this._ws.onmessage=JSJaC.bind(this._onAuthMessage,this)},JSJaCWebSocketConnection.prototype._onAuthMessage=function(a){var b=this;if(a.data instanceof Blob){var c=a.data,d=new FileReader;d.onload=function(a){if(a.target.readyState==FileReader.DONE){var c=new Uint8Array(a.target.result),d=b._bytesToInteger(c.subarray(PACKET_STRUCT.PACKET_LEN.START,PACKET_STRUCT.PACKET_LEN.END)),e=c.subarray(PACKET_STRUCT.OPCODE.START,PACKET_STRUCT.OPCODE.END),f=c.subarray(PACKET_HEADER_SIZE,PACKET_HEADER_SIZE+d);if(b._bytesToInteger(e)==OPCODE.AUTH.RECV){var g=JSON.parse(b._uint8ArrayToString(f));if(console.log("\u3010recv\u3011	OPCODE.AUTH.KEY\n	"+JSON.stringify(g)),200!=g.code)return void b._handleEvent(OPCODE.STREAM_ERROR.KEY,{code:401,message:"not-authorized"});b._handleEvent("packet_in",g),b._handleEvent(OPCODE.AUTH.KEY,g),b._connected=!0,b._handleEvent("onconnect"),b._ws.onmessage=JSJaC.bind(b._onJumpMessage,b)}else if(b._bytesToInteger(e)==OPCODE.STREAM_ERROR.RECV){var g=JSON.parse(b._uint8ArrayToString(f));if(console.log("\u3010recv\u3011	OPCODE.AUTH.KEY\n	"+JSON.stringify(g)),200!=g.code)return void b._handleEvent(OPCODE.STREAM_ERROR.KEY,{code:401,message:"not-authorized"})}}},d.readAsArrayBuffer(c)}},JSJaCWebSocketConnection.prototype.sendJumpPacket=function(a,b,c){if(!this.connected())return!1;if(!a||!a.opcode)return!1;if(b&&this._validateCallbackable(a)){if(!a.content)throw new Error("packet content cannot be null when send a Message or IQ packet.");a.content.id||(a.content.id=this._IDPrefix+this._ID++),this._registerPID(a,b,c)}a instanceof JumpPacket&&console.log("\u3010send\u3011	 "+OPCODE_MAP.SEND.get(a.opcode)+"\n	"+JSON.stringify(a));try{this._handleEvent("packet_out",a)}catch(d){return this.oDbg.log(d.toString(),1),!1}return this._buildAndSend(a),!0},JSJaCWebSocketConnection.prototype._buildAndSend=function(a){var b=null,c=null==a.content||"undefined"==typeof a.content,d=new Blob([JSON.stringify(a.content)],{type:"text/json"}),e=new FileReader,f=this;e.onload=function(d){if(d.target.readyState==FileReader.DONE){b=this.result;var e=new Uint8Array(PACKET_HEADER_SIZE);e.set(f._numToBytes(a.sFrame,PACKET_STRUCT.CONSOLE_FRAME.SIZE),PACKET_STRUCT.CONSOLE_FRAME.START),e.set(f._numToBytes(a.opcode,PACKET_STRUCT.OPCODE.SIZE),PACKET_STRUCT.OPCODE.START),c?e.set(f._numToBytes(0,PACKET_STRUCT.PACKET_LEN.SIZE),PACKET_STRUCT.PACKET_LEN.START):e.set(f._numToBytes(b.byteLength,PACKET_STRUCT.PACKET_LEN.SIZE),PACKET_STRUCT.PACKET_LEN.START),e.set(f._numToBytes(a.version,PACKET_STRUCT.VERSION.SIZE),PACKET_STRUCT.VERSION.START),e.set(f._numToBytes(a.seqId,PACKET_STRUCT.SEQ_ID.SIZE),PACKET_STRUCT.SEQ_ID.START);var g;g=c?e:f._concatUint8Array(e,new Uint8Array(b)),f._ws.send(g)}},e.readAsArrayBuffer(d)},JSJaCWebSocketConnection.prototype._handleOpenStream=function(a){var b,c;return this.oDbg.log(a.data,4),b=a.data,b=b.substr(b.indexOf("<stream:stream")),"/>"!==b.substr(-2)&&"</stream:stream>"!==b.substr(-16)&&(b+="</stream:stream>"),(c=this._parseXml(b))?(this.streamid=c.getAttribute("id"),this.oDbg.log("got streamid: "+this.streamid,2),void(this._ws.onmessage=JSJaC.bind(this._handleInitialResponse,this))):void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))},JSJaCWebSocketConnection.prototype._handleInitialResponse=function(a){var b=this._parseXml(a.data);return this._parseStreamFeatures(b)?(this._connected=!0,void(this.register?this._doInBandReg():this._doAuth())):void this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))},JSJaCWebSocketConnection.prototype.disconnect=function(){this._setStatus("disconnecting"),this.connected()&&(this._connected=!1,this.oDbg.log("Disconnecting",4),this._sendRaw("</stream:stream>",JSJaC.bind(this._cleanupWebSocket,this)),this.oDbg.log("Disconnected",2),this._handleEvent("ondisconnect"))},JSJaCWebSocketConnection.prototype._onclose=function(){this.oDbg.log("websocket closed",2),"disconnecting"!==this._status&&(this._connected=!1)},JSJaCWebSocketConnection.prototype._onerror=function(){this.oDbg.log("websocket error",1),this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))},JSJaCWebSocketConnection.prototype._onJumpMessage=function(a){var b=this;if(a.data instanceof Blob){var c=a.data,d=new FileReader;d.onload=function(a){if(a.target.readyState==FileReader.DONE){var c=new Uint8Array(a.target.result),d=b._bytesToInteger(c.subarray(PACKET_STRUCT.PACKET_LEN.START,PACKET_STRUCT.PACKET_LEN.END)),e=c.subarray(PACKET_STRUCT.OPCODE.START,PACKET_STRUCT.OPCODE.END),f=c.subarray(PACKET_HEADER_SIZE,PACKET_HEADER_SIZE+d);b._parseUint8Array(e,f)}},d.readAsArrayBuffer(c)}},JSJaCWebSocketConnection.prototype._onmessage=function(a){var c,d,e;if(c=a.data,this._setStatus("processing"),c&&""!==c){if(d=this._parseXml(c),d.namespaceURI===NS_STREAM&&"error"===d.localName)return d.getElementsByTagNameNS(NS_STREAMS,"conflict").length>0&&this._setStatus("session-terminate-conflict"),this._connected=!1,void this._handleEvent("onerror",JSJaCError("503","cancel","remote-stream-error"));e=JSJaCPacket.wrapNode(d),e&&(this.oDbg.log("async recv: "+a.data,4),this._handleEvent("packet_in",e),e.pType&&!this._handlePID(e)&&(this._handleEvent(e.pType()+"_in",e),this._handleEvent(e.pType(),e)))}},JSJaCWebSocketConnection.prototype._parseXml=function(a){var b;this.oDbg.log("Parsing: "+a,4);try{if(b=XmlDocument.create("stream",NS_STREAM),"</stream:stream>"==a.trim()){this.oDbg.log("session terminated",1),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto);try{JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase()}catch(c){}return this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate")),this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),null}return-1===a.indexOf("<stream:stream")?(b.loadXML("<stream:stream xmlns:stream='"+NS_STREAM+"' xmlns='jabber:client'>"+a+"</stream:stream>"),"undefined"==typeof b.documentElement.firstChild.xml&&(b.documentElement.firstChild.xml=a),b.documentElement.firstChild):(b.loadXML(a),b.documentElement)}catch(c){this.oDbg.log("Error: "+c),this._connected=!1,this._handleEvent("onerror",JSJaCError("500","wait","internal-service-error"))}return null},JSJaCWebSocketConnection.prototype._getInitialRequestString=function(){var a,b;return a=this.domain,this.authhost&&(a=this.authhost),b='<stream:stream to="'+a+'" xmlns="jabber:client" xmlns:stream="'+NS_STREAM+'"',("sasl"===this.authtype||"saslanon"===this.authtype)&&(b+=' version="1.0"'),b+=">"},JSJaCWebSocketConnection.prototype.send=function(a,b,c){if(this._ws.onmessage=JSJaC.bind(this._onmessage,this),!a||!a.pType)return this.oDbg.log("no packet: "+a,1),!1;if(!this.connected())return!1;b&&(a.getID()||a.setID("JSJaCID_"+this._ID++),this._registerPID(a,b,c));try{this._handleEvent(a.pType()+"_out",a),this._handleEvent("packet_out",a),this._ws.send(a.xml())}catch(d){return this.oDbg.log(d.toString(),1),!1}return!0},JSJaCWebSocketConnection.prototype.resume=function(){return!1},JSJaCWebSocketConnection.prototype.suspend=function(){return!1},JSJaCWebSocketConnection.prototype._doSASLAuthScramSha1S1=function(a){var b=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthScramSha1S1,this)(b)},JSJaCWebSocketConnection.prototype._doSASLAuthScramSha1S2=function(a){var b=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthScramSha1S2,this)(b)},JSJaCWebSocketConnection.prototype._doSASLAuthDigestMd5S1=function(a){var b=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDigestMd5S1,this)(b)},JSJaCWebSocketConnection.prototype._doSASLAuthDigestMd5S2=function(a){var b=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDigestMd5S2,this)(b)},JSJaCWebSocketConnection.prototype._doSASLAuthDone=function(a){var b=this._parseXml(a.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDone,this)(b)},JSJaCWebSocketConnection.prototype._reInitStream=function(a){var b,c=this.domain;this.authhost&&(c=this.authhost),b='<stream:stream xmlns:stream="'+NS_STREAM+'" xmlns="jabber:client" to="'+c+'" version="1.0">',this._sendRaw(b,a)},JSJaCWebSocketConnection.prototype._sendRaw=function(a,b,c){return this._ws?(b&&(this._ws.onmessage=JSJaC.bind(b,this,c)),this._ws.send(a),!0):!1},JSJaCWebSocketConnection.prototype._parseUint8Array=function(a,b){if(this._setStatus("processing"),b){var c=OPCODE_MAP.RECV.get(this._bytesToInteger(a));if(console.log("\u3010recv\u3011	"+OPCODE_MAP.RECV.get(this._bytesToInteger(a))+"\n	"+this._uint8ArrayToString(b)),0==b.byteLength)return this._handleEvent("packet_in"),void this._handleEvent(c);try{var d=JSON.parse(this._uint8ArrayToString(b));this._handlePID(d)||(this._handleEvent("packet_in",d),this._handleEvent(c,d))}catch(e){}}};var hexcase=0,b64pad="=";if(("undefined"==typeof atob||"undefined"==typeof btoa)&&b64arrays(),"undefined"==typeof atob?(b64decode=function(a){return utf8d2t(b64t2d(a))},b64decode_bin=function(a){for(var b=b64t2d(a),c="",d=0;d<b.length;d++)c+=String.fromCharCode(b[d]);return c}):(b64decode=function(a){return decodeURIComponent(escape(atob(a)))},b64decode_bin=atob),"undefined"==typeof btoa?b64encode=function(a){return b64d2t(utf8t2d(a))}:b64encode=function(a){return btoa(unescape(encodeURIComponent(a)))},window.XDomainRequest){window.ieXDRToXHR=function(a){"use strict";var b=a.XMLHttpRequest;a.XMLHttpRequest=function(){this.onreadystatechange=Object,this.xhr=null,this.xdr=null,this.readyState=0,this.status="",this.statusText=null,this.responseText=null,this.getResponseHeader=null,this.getAllResponseHeaders=null,this.setRequestHeader=null,this.abort=null,this.send=null,this.isxdr=!1;var a=this;a.xdrLoadedBinded=function(){a.xdrLoaded()},a.xdrErrorBinded=function(){a.xdrError()},a.xdrProgressBinded=function(){a.xdrProgress()},a.xhrReadyStateChangedBinded=function(){a.xhrReadyStateChanged()}},XMLHttpRequest.prototype.open=function(c,d,e,f,g){var h=document.createElement("a");h.href=d,h.hostname!=document.domain?(null===this.xdr&&(this.xdr=new a.XDomainRequest),this.isxdr=!0,this.setXDRActive(),this.xdr.open(c,d)):(null===this.xhr&&(this.xhr=new b),this.isxdr=!1,this.setXHRActive(),this.xhr.open(c,d,e,f,g))},XMLHttpRequest.prototype.xdrGetResponseHeader=function(a){return"Content-Type"===a&&this.xdr.contentType>""?this.xdr.contentType:""},XMLHttpRequest.prototype.xdrGetAllResponseHeaders=function(){return this.xdr.contentType>""?"Content-Type: "+this.xdr.contentType:""},XMLHttpRequest.prototype.xdrSetRequestHeader=function(a,b){},XMLHttpRequest.prototype.xdrLoaded=function(){if(null!==this.onreadystatechange){if(this.readyState=4,this.status=200,this.statusText="OK",this.responseText=this.xdr.responseText,a.ActiveXObject){var b=new ActiveXObject("Microsoft.XMLDOM");b.async="false",b.loadXML(this.responseText),this.responseXML=b}this.onreadystatechange()}},XMLHttpRequest.prototype.xdrError=function(){null!==this.onreadystatechange&&(this.readyState=4,this.status=0,this.statusText="",this.responseText="",this.onreadystatechange())},XMLHttpRequest.prototype.xdrProgress=function(){null!==this.onreadystatechange&&3!==this.status&&(this.readyState=3,this.status=3,this.statusText="",this.onreadystatechange())},XMLHttpRequest.prototype.finalXDRRequest=function(){var a=this.xdr;delete a.onload,delete a.onerror,delete a.onprogress},XMLHttpRequest.prototype.sendXDR=function(a){var b=this.xdr;b.onload=this.xdrLoadedBinded,b.onerror=this.xdr.ontimeout=this.xdrErrorBinded,b.onprogress=this.xdrProgressBinded,this.responseText=null,this.xdr.send(a)},XMLHttpRequest.prototype.abortXDR=function(){this.finalXDRRequest(),this.xdr.abort()},XMLHttpRequest.prototype.setXDRActive=function(){this.send=this.sendXDR,this.abort=this.abortXDR,this.getResponseHeader=this.xdrGetResponseHeader,this.getAllResponseHeaders=this.xdrGetAllResponseHeaders,this.setRequestHeader=this.xdrSetRequestHeader},XMLHttpRequest.prototype.xhrGetResponseHeader=function(a){return this.xhr.getResponseHeader(a)},XMLHttpRequest.prototype.xhrGetAllResponseHeaders=function(){return this.xhr.getAllResponseHeaders()},XMLHttpRequest.prototype.xhrSetRequestHeader=function(a,b){return this.xhr.setRequestHeader(a,b)},XMLHttpRequest.prototype.xhrReadyStateChanged=function(){if(null!==this.onreadystatechange&&this.readyState!==this.xhr.readyState){var a=this.xhr;this.readyState=a.readyState,4===this.readyState&&(this.status=a.status,this.statusText=a.statusText,this.responseText=a.responseText,this.responseXML=a.responseXML),this.onreadystatechange()}},XMLHttpRequest.prototype.finalXHRRequest=function(){delete this.xhr.onreadystatechange},XMLHttpRequest.prototype.abortXHR=function(){this.finalXHRRequest(),this.xhr.abort()},XMLHttpRequest.prototype.sendXHR=function(a){this.xhr.onreadystatechange=this.xhrReadyStateChangedBinded,this.xhr.send(a)},XMLHttpRequest.prototype.setXHRActive=function(){this.send=this.sendXHR,this.abort=this.abortXHR,this.getResponseHeader=this.xhrGetResponseHeader,this.getAllResponseHeaders=this.xhrGetAllResponseHeaders,this.setRequestHeader=this.xhrSetRequestHeader},a.ieXDRToXHR=void 0};var isWebsocketSupport=function(){var a=navigator.userAgent.indexOf("Safari")>-1&&navigator.userAgent.indexOf("Chrome")<1;return a?!1:(window.WebSocket=window.WebSocket||window.MozWebSocket,window.WebSocket?!0:!1)}();isWebsocketSupport||window.ieXDRToXHR(window)}String.prototype.htmlEnc=function(){if(!this)return this;var a=this.replace(/&/g,"&amp;");return a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),a=a.replace(/\"/g,"&quot;"),a=a.replace(/\n/g,"<br />")},String.prototype.revertHtmlEnc=function(){if(!this)return this;var a=this.replace(/&amp;/gi,"&");return a=a.replace(/&lt;/gi,"<"),a=a.replace(/&gt;/gi,">"),a=a.replace(/&quot;/gi,'"'),a=a.replace(/<br( )?(\/)?>/gi,"\n")},Date.jab2date=function(a){var b=new Date(Date.UTC(a.substr(0,4),a.substr(5,2)-1,a.substr(8,2),a.substr(11,2),a.substr(14,2),a.substr(17,2)));if("Z"!=a.substr(a.length-6,1)){var c=new Date;c.setTime(0),c.setUTCHours(a.substr(a.length-5,2)),c.setUTCMinutes(a.substr(a.length-2,2)),"+"==a.substr(a.length-6,1)?b.setTime(b.getTime()-c.getTime()):"-"==a.substr(a.length-6,1)&&b.setTime(b.getTime()+c.getTime())}return b},Date.hrTime=function(a){return Date.jab2date(a).toLocaleString()},Date.prototype.jabberDate=function(){var a=function(a){return 10>a?"0"+a:a},b=this.getUTCFullYear()+"-";return b+=a(this.getUTCMonth()+1)+"-",b+=a(this.getUTCDate())+"T",b+=a(this.getUTCHours())+":",b+=a(this.getUTCMinutes())+":",b+=a(this.getUTCSeconds())+"Z"},Number.max=function(a,b){return a>b?a:b},Number.min=function(a,b){return b>a?a:b};var browserSys={},browserUa=navigator.userAgent.toLowerCase(),b;(b=browserUa.match(/msie ([\d.]+)/))?browserSys.ie=b[1]:(b=browserUa.match(/firefox\/([\d.]+)/))?browserSys.firefox=b[1]:(b=browserUa.match(/chrome\/([\d.]+)/))?browserSys.chrome=b[1]:(b=browserUa.match(/version\/([\d.]+).*safari/))?browserSys.safari=b[1]:0;var isFormDataSupport=!!window.FormData&&"[object Function]"===Object.prototype.toString.call(FormData);isFormDataSupport===!0?jQuery.fn._Huploadify=snsimUploadUseXHR:jQuery.fn._Huploadify=function(){};var SNSFile=function(a,b,c){function d(a){if(a){var b=a.lastIndexOf(".");if(-1!=b){var c=a.substring(b+1).toLowerCase();return c}return"unknown"}}this.path=b,this.name=a,this.size=c,this.type=d(a)};SNSFile.prototype.renderSize=function(){return SNSFile.renderSize(this.size)},SNSFile.roundFun=function(a,b){if(a>=0){var c=parseInt(a*Math.pow(10,b)+.5)/Math.pow(10,b);return c}numberRound1=-a;var c=parseInt(numberRound1*Math.pow(10,b)+.5)/Math.pow(10,b);return-c},SNSFile.renderSize=function(a){if(null==a||""==a)return"";var b=new Array("Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"),c=0,d=parseFloat(a),e=SNSFile.roundFun(d/Math.pow(1024,c=Math.floor(Math.log(d)/Math.log(1024))),0);return e+b[c]};var FileUpload=function(a){this.inputId=a,this.fileObj};if(FileUpload.getInstance=function(a,b){FileUpload.list||(FileUpload.list=new SNSBaseList);var c=FileUpload.list.get(a);return c||(c=new FileUpload(a),FileUpload.list.add(a,c)),b&&jQuery("#"+a)._Huploadify(b),c},FileUpload.getInstanceByInputId=function(a){return FileUpload.list.get(a)},FileUpload.prototype.sendFile=function(a){this.fileObj.funSendFile(a)},FileUpload.formatFileSize=function(a,b){return a=a>1048576&&!b?(Math.round(100*a/1048576)/100).toString()+"MB":(Math.round(100*a/1024)/100).toString()+"KB"},FileUpload.getFile=function(a,b){for(var c=0;c<b.length;c++)if(b[c].index==a)return b[c];return!1},isFormDataSupport===!1){var SNSIMUploadUseFlash=function(){this.swfUploadList=new SNSBaseList};SNSIMUploadUseFlash.getInstance=function(){return SNSIMUploadUseFlash._instance||(SNSIMUploadUseFlash._instance=new SNSIMUploadUseFlash),SNSIMUploadUseFlash._instance},SNSIMUploadUseFlash.prototype.addUploader=function(a){if(!this.swfUploadList.get(a.button_placeholder_id)){var b=new SWFUpload({upload_url:"",flash_url:a.flash_url,button_placeholder_id:a.button_placeholder_id,button_image_url:a.button_image_url,button_width:a.button_width,button_height:a.button_height,button_text:a.button_text,button_text_style:a.button_text_style,button_text_left_padding:a.button_text_left_padding,button_text_top_padding:a.button_text_top_padding,button_disabled:a.button_disabled,button_cursor:a.button_cursor,button_window_mode:a.button_window_mode,file_size_limit:"30000",file_types:"image"==a.contentType||"avatar"==a.contentType?"*.jpg;*.gif;*.jpeg;*.png;*.bmp":"*.*",file_types_description:"Image Files",file_queue_limit:"1",chat_info:{},content_type:"avatar"==a.contentType?"avatar":"image"==a.contentType?8:4,file_dialog_start_handler:function(){},file_queued_handler:function(b){var e,f,g,c=a.getChatInfo&&a.getChatInfo()||{},d=YYIMChat.getServletPath().FILE_UPLOAD_SERVLET,h=c.to||YYIMChat.getUserNode();YYIMChat.isAnonymous()?(e=YYIMChat.getUserFullJID(),g="anonymous"):(e=YYIMChat.getUserNode(),g=YYIMChat.getToken()),f=c.resource&&"anonymous"==c.resource.toLowerCase()?YYIMChat.getJIDUtil().buildUserJID(YYIMChat.getJIDUtil().getID(h),"ANONYMOUS"):YYIMChat.getJIDUtil().getNode(h),d=d+"?fileName="+encodeURI(b.name,"utf-8")+"&uploadedSize=0&fileSize="+b.size+"&fromUser="+e+"&toUser="+f+"&token="+g+"&muc=1","avatar"===a.contentType&&(d+="&isAvatar=true"),this.settings.chat_info={to:YYIMChat.getJIDUtil().getNode(h),type:c.type?c.type:"chat",resource:c.resource},this.setUploadURL(d)},file_queue_error_handler:function(){a.error&&a.error(arguments)},file_dialog_complete_handler:function(){this.startUpload()},upload_start_handler:function(){},upload_progress_handler:function(){},upload_error_handler:function(){a.error&&a.error(arguments)},upload_success_handler:function(b,c){var d=this.settings;if("200"==JSON.parse(c).code){var e=JSON.parse(c).result.attachId;if("avatar"===a.contentType)a.success&&a.success(e);else{var f={id:Math.uuid(),body:{content:new SNSFile(b.name,e,b.size),contentType:d.content_type,dateline:(new Date).getTime()},to:d.chat_info.to,type:d.chat_info.type,success:function(b){var c=Object.clone(b);c.to=YYIMChat.getJIDUtil().getID(b.to),c.body.content.path=YYIMChat.getFileUrl(c.body.content.path),a.success&&a.success(c)}};d.chat_info.resource&&(f.resource=d.chat_info.resource),YYIMChat.sendMessage(f)}}},upload_complete_handler:function(){}});this.swfUploadList.add(a.button_placeholder_id,b)}}}var isDelete=!1,filesIndex="",deletefilesIndex="",FILE_TYPES=["rar","zip","pdf","txt","html"],IMAGE_TYPES=["png","gif","jpg","jpeg","bmp"],UPLOAD_AVATAR="snsim_upload_avatar";if(isFormDataSupport===!1){var SWFUpload;void 0==SWFUpload&&(SWFUpload=function(a){this.initSWFUpload(a)}),SWFUpload.prototype.initSWFUpload=function(a){try{this.customSettings={},this.settings=a,this.eventQueue=[],this.movieName="SWFUpload_"+SWFUpload.movieCount++,this.movieElement=null,SWFUpload.instances[this.movieName]=this,this.initSettings(),this.loadFlash(),this.displayDebugInfo()}catch(b){throw delete SWFUpload.instances[this.movieName],b}},SWFUpload.instances={},SWFUpload.movieCount=0,SWFUpload.version="2.2.0 2009-03-25",SWFUpload.QUEUE_ERROR={QUEUE_LIMIT_EXCEEDED:-100,FILE_EXCEEDS_SIZE_LIMIT:-110,ZERO_BYTE_FILE:-120,INVALID_FILETYPE:-130},SWFUpload.UPLOAD_ERROR={HTTP_ERROR:-200,MISSING_UPLOAD_URL:-210,IO_ERROR:-220,SECURITY_ERROR:-230,UPLOAD_LIMIT_EXCEEDED:-240,UPLOAD_FAILED:-250,SPECIFIED_FILE_ID_NOT_FOUND:-260,FILE_VALIDATION_FAILED:-270,FILE_CANCELLED:-280,UPLOAD_STOPPED:-290},SWFUpload.FILE_STATUS={QUEUED:-1,IN_PROGRESS:-2,ERROR:-3,COMPLETE:-4,CANCELLED:-5},SWFUpload.BUTTON_ACTION={SELECT_FILE:-100,SELECT_FILES:-110,START_UPLOAD:-120},SWFUpload.CURSOR={ARROW:-1,HAND:-2},SWFUpload.WINDOW_MODE={WINDOW:"window",TRANSPARENT:"transparent",OPAQUE:"opaque"},SWFUpload.completeURL=function(a){if("string"!=typeof a||a.match(/^https?:\/\//i)||a.match(/^\//))return a;var c=(window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:""),window.location.pathname.lastIndexOf("/"));return 0>=c?path="/":path=window.location.pathname.substr(0,c)+"/",path+a},SWFUpload.prototype.initSettings=function(){this.ensureDefault=function(a,b){this.settings[a]=void 0==this.settings[a]?b:this.settings[a]},this.ensureDefault("upload_url",""),this.ensureDefault("preserve_relative_urls",!1),this.ensureDefault("file_post_name","Filedata"),this.ensureDefault("post_params",{}),this.ensureDefault("use_query_string",!1),this.ensureDefault("requeue_on_error",!1),this.ensureDefault("http_success",[]),this.ensureDefault("assume_success_timeout",0),this.ensureDefault("file_types","*.*"),this.ensureDefault("file_types_description","All Files"),this.ensureDefault("file_size_limit",0),this.ensureDefault("file_upload_limit",0),this.ensureDefault("file_queue_limit",0),this.ensureDefault("flash_url","swfupload.swf"),this.ensureDefault("prevent_swf_caching",!0),this.ensureDefault("button_image_url",""),this.ensureDefault("button_width",1),this.ensureDefault("button_height",1),this.ensureDefault("button_text",""),this.ensureDefault("button_text_style","color: #000000; font-size: 16pt;"),this.ensureDefault("button_text_top_padding",0),this.ensureDefault("button_text_left_padding",0),this.ensureDefault("button_action",SWFUpload.BUTTON_ACTION.SELECT_FILES),this.ensureDefault("button_disabled",!1),this.ensureDefault("button_placeholder_id",""),this.ensureDefault("button_placeholder",null),this.ensureDefault("button_cursor",SWFUpload.CURSOR.ARROW),this.ensureDefault("button_window_mode",SWFUpload.WINDOW_MODE.OPAQUE),this.ensureDefault("debug",!1),this.settings.debug_enabled=this.settings.debug,this.settings.return_upload_start_handler=this.returnUploadStart,this.ensureDefault("swfupload_loaded_handler",null),this.ensureDefault("file_dialog_start_handler",null),this.ensureDefault("file_queued_handler",null),this.ensureDefault("file_queue_error_handler",null),this.ensureDefault("file_dialog_complete_handler",null),this.ensureDefault("upload_start_handler",null),this.ensureDefault("upload_progress_handler",null),this.ensureDefault("upload_error_handler",null),this.ensureDefault("upload_success_handler",null),this.ensureDefault("upload_complete_handler",null),this.ensureDefault("debug_handler",this.debugMessage),this.ensureDefault("custom_settings",{}),this.customSettings=this.settings.custom_settings,this.settings.prevent_swf_caching&&(this.settings.flash_url=this.settings.flash_url+(this.settings.flash_url.indexOf("?")<0?"?":"&")+"preventswfcaching="+(new Date).getTime()),this.settings.preserve_relative_urls||(this.settings.upload_url=SWFUpload.completeURL(this.settings.upload_url),this.settings.button_image_url=SWFUpload.completeURL(this.settings.button_image_url)),delete this.ensureDefault},SWFUpload.prototype.loadFlash=function(){var a,b;if(null!==document.getElementById(this.movieName))throw"ID "+this.movieName+" is already in use. The Flash Object could not be added";if(a=document.getElementById(this.settings.button_placeholder_id)||this.settings.button_placeholder,void 0==a)throw"Could not find the placeholder element: "+this.settings.button_placeholder_id;b=document.createElement("div"),b.innerHTML=this.getFlashHTML(),a.parentNode.replaceChild(b.firstChild,a),void 0==window[this.movieName]&&(window[this.movieName]=this.getMovieElement())},SWFUpload.prototype.getFlashHTML=function(){return['<object id="',this.movieName,'" type="application/x-shockwave-flash" data="',this.settings.flash_url,'" width="',this.settings.button_width,'" height="',this.settings.button_height,'" class="swfupload">','<param name="wmode" value="',this.settings.button_window_mode,'" />','<param name="movie" value="',this.settings.flash_url,'" />','<param name="quality" value="high" />','<param name="menu" value="false" />','<param name="allowScriptAccess" value="always" />','<param name="flashvars" value="'+this.getFlashVars()+'" />',"</object>"].join("")},SWFUpload.prototype.getFlashVars=function(){var a=this.buildParamString(),b=this.settings.http_success.join(",");return["movieName=",encodeURIComponent(this.movieName),"&amp;uploadURL=",encodeURIComponent(this.settings.upload_url),"&amp;useQueryString=",encodeURIComponent(this.settings.use_query_string),"&amp;requeueOnError=",encodeURIComponent(this.settings.requeue_on_error),"&amp;httpSuccess=",encodeURIComponent(b),"&amp;assumeSuccessTimeout=",encodeURIComponent(this.settings.assume_success_timeout),"&amp;params=",encodeURIComponent(a),"&amp;filePostName=",encodeURIComponent(this.settings.file_post_name),"&amp;fileTypes=",encodeURIComponent(this.settings.file_types),"&amp;fileTypesDescription=",encodeURIComponent(this.settings.file_types_description),"&amp;fileSizeLimit=",encodeURIComponent(this.settings.file_size_limit),"&amp;fileUploadLimit=",encodeURIComponent(this.settings.file_upload_limit),"&amp;fileQueueLimit=",encodeURIComponent(this.settings.file_queue_limit),"&amp;debugEnabled=",encodeURIComponent(this.settings.debug_enabled),"&amp;buttonImageURL=",encodeURIComponent(this.settings.button_image_url),"&amp;buttonWidth=",encodeURIComponent(this.settings.button_width),"&amp;buttonHeight=",encodeURIComponent(this.settings.button_height),"&amp;buttonText=",encodeURIComponent(this.settings.button_text),"&amp;buttonTextTopPadding=",encodeURIComponent(this.settings.button_text_top_padding),"&amp;buttonTextLeftPadding=",encodeURIComponent(this.settings.button_text_left_padding),"&amp;buttonTextStyle=",encodeURIComponent(this.settings.button_text_style),"&amp;buttonAction=",encodeURIComponent(this.settings.button_action),"&amp;buttonDisabled=",encodeURIComponent(this.settings.button_disabled),"&amp;buttonCursor=",encodeURIComponent(this.settings.button_cursor)].join("")},SWFUpload.prototype.getMovieElement=function(){if(void 0==this.movieElement&&(this.movieElement=document.getElementById(this.movieName)),null===this.movieElement)throw"Could not find Flash element";return this.movieElement},SWFUpload.prototype.buildParamString=function(){var a=this.settings.post_params,b=[];if("object"==typeof a)for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c.toString())+"="+encodeURIComponent(a[c].toString()));return b.join("&amp;")},SWFUpload.prototype.destroy=function(){try{this.cancelUpload(null,!1);var a=null;if(a=this.getMovieElement(),a&&"unknown"==typeof a.CallFunction){for(var b in a)try{"function"==typeof a[b]&&(a[b]=null)}catch(c){}try{a.parentNode.removeChild(a)}catch(d){}}return window[this.movieName]=null,SWFUpload.instances[this.movieName]=null,delete SWFUpload.instances[this.movieName],this.movieElement=null,this.settings=null,this.customSettings=null,this.eventQueue=null,this.movieName=null,!0}catch(e){return!1}},SWFUpload.prototype.displayDebugInfo=function(){this.debug(["---SWFUpload Instance Info---\n","Version: ",SWFUpload.version,"\n","Movie Name: ",this.movieName,"\n","Settings:\n","	","upload_url:               ",this.settings.upload_url,"\n","	","flash_url:                ",this.settings.flash_url,"\n","	","use_query_string:         ",this.settings.use_query_string.toString(),"\n","	","requeue_on_error:         ",this.settings.requeue_on_error.toString(),"\n","	","http_success:             ",this.settings.http_success.join(", "),"\n","	","assume_success_timeout:   ",this.settings.assume_success_timeout,"\n","	","file_post_name:           ",this.settings.file_post_name,"\n","	","post_params:              ",this.settings.post_params.toString(),"\n","	","file_types:               ",this.settings.file_types,"\n","	","file_types_description:   ",this.settings.file_types_description,"\n","	","file_size_limit:          ",this.settings.file_size_limit,"\n","	","file_upload_limit:        ",this.settings.file_upload_limit,"\n","	","file_queue_limit:         ",this.settings.file_queue_limit,"\n","	","debug:                    ",this.settings.debug.toString(),"\n","	","prevent_swf_caching:      ",this.settings.prevent_swf_caching.toString(),"\n","	","button_placeholder_id:    ",this.settings.button_placeholder_id.toString(),"\n","	","button_placeholder:       ",this.settings.button_placeholder?"Set":"Not Set","\n","	","button_image_url:         ",this.settings.button_image_url.toString(),"\n","	","button_width:             ",this.settings.button_width.toString(),"\n","	","button_height:            ",this.settings.button_height.toString(),"\n","	","button_text:              ",this.settings.button_text.toString(),"\n","	","button_text_style:        ",this.settings.button_text_style.toString(),"\n","	","button_text_top_padding:  ",this.settings.button_text_top_padding.toString(),"\n","	","button_text_left_padding: ",this.settings.button_text_left_padding.toString(),"\n","	","button_action:            ",this.settings.button_action.toString(),"\n","	","button_disabled:          ",this.settings.button_disabled.toString(),"\n","	","custom_settings:          ",this.settings.custom_settings.toString(),"\n","Event Handlers:\n","	","swfupload_loaded_handler assigned:  ",("function"==typeof this.settings.swfupload_loaded_handler).toString(),"\n","	","file_dialog_start_handler assigned: ",("function"==typeof this.settings.file_dialog_start_handler).toString(),"\n","	","file_queued_handler assigned:       ",("function"==typeof this.settings.file_queued_handler).toString(),"\n","	","file_queue_error_handler assigned:  ",("function"==typeof this.settings.file_queue_error_handler).toString(),"\n","	","upload_start_handler assigned:      ",("function"==typeof this.settings.upload_start_handler).toString(),"\n","	","upload_progress_handler assigned:   ",("function"==typeof this.settings.upload_progress_handler).toString(),"\n","	","upload_error_handler assigned:      ",("function"==typeof this.settings.upload_error_handler).toString(),"\n","	","upload_success_handler assigned:    ",("function"==typeof this.settings.upload_success_handler).toString(),"\n","	","upload_complete_handler assigned:   ",("function"==typeof this.settings.upload_complete_handler).toString(),"\n","	","debug_handler assigned:             ",("function"==typeof this.settings.debug_handler).toString(),"\n"].join(""));
},SWFUpload.prototype.addSetting=function(a,b,c){return void 0==b?this.settings[a]=c:this.settings[a]=b},SWFUpload.prototype.getSetting=function(a){return void 0!=this.settings[a]?this.settings[a]:""},SWFUpload.prototype.callFlash=function(functionName,argumentArray){argumentArray=argumentArray||[];var movieElement=this.getMovieElement(),returnValue,returnString;try{returnString=movieElement.CallFunction('<invoke name="'+functionName+'" returntype="javascript">'+__flash__argumentsToXML(argumentArray,0)+"</invoke>"),returnValue=eval(returnString)}catch(ex){throw"Call to "+functionName+" failed"}return void 0!=returnValue&&"object"==typeof returnValue.post&&(returnValue=this.unescapeFilePostParams(returnValue)),returnValue},SWFUpload.prototype.selectFile=function(){this.callFlash("SelectFile")},SWFUpload.prototype.selectFiles=function(){this.callFlash("SelectFiles")},SWFUpload.prototype.startUpload=function(a){this.callFlash("StartUpload",[a])},SWFUpload.prototype.cancelUpload=function(a,b){b!==!1&&(b=!0),this.callFlash("CancelUpload",[a,b])},SWFUpload.prototype.stopUpload=function(){this.callFlash("StopUpload")},SWFUpload.prototype.getStats=function(){return this.callFlash("GetStats")},SWFUpload.prototype.setStats=function(a){this.callFlash("SetStats",[a])},SWFUpload.prototype.getFile=function(a){return"number"==typeof a?this.callFlash("GetFileByIndex",[a]):this.callFlash("GetFile",[a])},SWFUpload.prototype.addFileParam=function(a,b,c){return this.callFlash("AddFileParam",[a,b,c])},SWFUpload.prototype.removeFileParam=function(a,b){this.callFlash("RemoveFileParam",[a,b])},SWFUpload.prototype.setUploadURL=function(a){this.settings.upload_url=a.toString(),this.callFlash("SetUploadURL",[a])},SWFUpload.prototype.setPostParams=function(a){this.settings.post_params=a,this.callFlash("SetPostParams",[a])},SWFUpload.prototype.addPostParam=function(a,b){this.settings.post_params[a]=b,this.callFlash("SetPostParams",[this.settings.post_params])},SWFUpload.prototype.removePostParam=function(a){delete this.settings.post_params[a],this.callFlash("SetPostParams",[this.settings.post_params])},SWFUpload.prototype.setFileTypes=function(a,b){this.settings.file_types=a,this.settings.file_types_description=b,this.callFlash("SetFileTypes",[a,b])},SWFUpload.prototype.setFileSizeLimit=function(a){this.settings.file_size_limit=a,this.callFlash("SetFileSizeLimit",[a])},SWFUpload.prototype.setFileUploadLimit=function(a){this.settings.file_upload_limit=a,this.callFlash("SetFileUploadLimit",[a])},SWFUpload.prototype.setFileQueueLimit=function(a){this.settings.file_queue_limit=a,this.callFlash("SetFileQueueLimit",[a])},SWFUpload.prototype.setFilePostName=function(a){this.settings.file_post_name=a,this.callFlash("SetFilePostName",[a])},SWFUpload.prototype.setUseQueryString=function(a){this.settings.use_query_string=a,this.callFlash("SetUseQueryString",[a])},SWFUpload.prototype.setRequeueOnError=function(a){this.settings.requeue_on_error=a,this.callFlash("SetRequeueOnError",[a])},SWFUpload.prototype.setHTTPSuccess=function(a){"string"==typeof a&&(a=a.replace(" ","").split(",")),this.settings.http_success=a,this.callFlash("SetHTTPSuccess",[a])},SWFUpload.prototype.setAssumeSuccessTimeout=function(a){this.settings.assume_success_timeout=a,this.callFlash("SetAssumeSuccessTimeout",[a])},SWFUpload.prototype.setDebugEnabled=function(a){this.settings.debug_enabled=a,this.callFlash("SetDebugEnabled",[a])},SWFUpload.prototype.setButtonImageURL=function(a){void 0==a&&(a=""),this.settings.button_image_url=a,this.callFlash("SetButtonImageURL",[a])},SWFUpload.prototype.setButtonDimensions=function(a,b){this.settings.button_width=a,this.settings.button_height=b;var c=this.getMovieElement();void 0!=c&&(c.style.width=a+"px",c.style.height=b+"px"),this.callFlash("SetButtonDimensions",[a,b])},SWFUpload.prototype.setButtonText=function(a){this.settings.button_text=a,this.callFlash("SetButtonText",[a])},SWFUpload.prototype.setButtonTextPadding=function(a,b){this.settings.button_text_top_padding=b,this.settings.button_text_left_padding=a,this.callFlash("SetButtonTextPadding",[a,b])},SWFUpload.prototype.setButtonTextStyle=function(a){this.settings.button_text_style=a,this.callFlash("SetButtonTextStyle",[a])},SWFUpload.prototype.setButtonDisabled=function(a){this.settings.button_disabled=a,this.callFlash("SetButtonDisabled",[a])},SWFUpload.prototype.setButtonAction=function(a){this.settings.button_action=a,this.callFlash("SetButtonAction",[a])},SWFUpload.prototype.setButtonCursor=function(a){this.settings.button_cursor=a,this.callFlash("SetButtonCursor",[a])},SWFUpload.prototype.queueEvent=function(a,b){void 0==b?b=[]:b instanceof Array||(b=[b]);var c=this;if("function"==typeof this.settings[a])this.eventQueue.push(function(){this.settings[a].apply(this,b)}),setTimeout(function(){c.executeNextEvent()},0);else if(null!==this.settings[a])throw"Event handler "+a+" is unknown or is not a function"},SWFUpload.prototype.executeNextEvent=function(){var a=this.eventQueue?this.eventQueue.shift():null;"function"==typeof a&&a.apply(this)},SWFUpload.prototype.unescapeFilePostParams=function(a){var d,b=/[$]([0-9a-f]{4})/i,c={};if(void 0!=a){for(var e in a.post)if(a.post.hasOwnProperty(e)){d=e;for(var f;null!==(f=b.exec(d));)d=d.replace(f[0],String.fromCharCode(parseInt("0x"+f[1],16)));c[d]=a.post[e]}a.post=c}return a},SWFUpload.prototype.testExternalInterface=function(){try{return this.callFlash("TestExternalInterface")}catch(a){return!1}},SWFUpload.prototype.flashReady=function(){var a=this.getMovieElement();return a?(this.cleanUp(a),void this.queueEvent("swfupload_loaded_handler")):void this.debug("Flash called back ready but the flash movie can't be found.")},SWFUpload.prototype.cleanUp=function(a){try{if(this.movieElement&&"unknown"==typeof a.CallFunction){this.debug("Removing Flash functions hooks (this should only run in IE and should prevent memory leaks)");for(var b in a)try{"function"==typeof a[b]&&(a[b]=null)}catch(c){}}}catch(d){}window.__flash__removeCallback=function(a,b){try{a&&(a[b]=null)}catch(c){}}},SWFUpload.prototype.fileDialogStart=function(){this.queueEvent("file_dialog_start_handler")},SWFUpload.prototype.fileQueued=function(a){a=this.unescapeFilePostParams(a),this.queueEvent("file_queued_handler",a)},SWFUpload.prototype.fileQueueError=function(a,b,c){a=this.unescapeFilePostParams(a),this.queueEvent("file_queue_error_handler",[a,b,c])},SWFUpload.prototype.fileDialogComplete=function(a,b,c){this.queueEvent("file_dialog_complete_handler",[a,b,c])},SWFUpload.prototype.uploadStart=function(a){a=this.unescapeFilePostParams(a),this.queueEvent("return_upload_start_handler",a)},SWFUpload.prototype.returnUploadStart=function(a){var b;if("function"==typeof this.settings.upload_start_handler)a=this.unescapeFilePostParams(a),b=this.settings.upload_start_handler.call(this,a);else if(void 0!=this.settings.upload_start_handler)throw"upload_start_handler must be a function";void 0===b&&(b=!0),b=!!b,this.callFlash("ReturnUploadStart",[b])},SWFUpload.prototype.uploadProgress=function(a,b,c){a=this.unescapeFilePostParams(a),this.queueEvent("upload_progress_handler",[a,b,c])},SWFUpload.prototype.uploadError=function(a,b,c){a=this.unescapeFilePostParams(a),this.queueEvent("upload_error_handler",[a,b,c])},SWFUpload.prototype.uploadSuccess=function(a,b,c){a=this.unescapeFilePostParams(a),this.queueEvent("upload_success_handler",[a,b,c])},SWFUpload.prototype.uploadComplete=function(a){a=this.unescapeFilePostParams(a),this.queueEvent("upload_complete_handler",a)},SWFUpload.prototype.debug=function(a){this.queueEvent("debug_handler",a)},SWFUpload.prototype.debugMessage=function(a){if(this.settings.debug){var b,c=[];if("object"==typeof a&&"string"==typeof a.name&&"string"==typeof a.message){for(var d in a)a.hasOwnProperty(d)&&c.push(d+": "+a[d]);b=c.join("\n")||"",c=b.split("\n"),b="EXCEPTION: "+c.join("\nEXCEPTION: "),SWFUpload.Console.writeLine(b)}else SWFUpload.Console.writeLine(a)}},SWFUpload.Console={},SWFUpload.Console.writeLine=function(a){var b,c;try{b=document.getElementById("SWFUpload_Console"),b||(c=document.createElement("form"),document.getElementsByTagName("body")[0].appendChild(c),b=document.createElement("textarea"),b.id="SWFUpload_Console",b.style.fontFamily="monospace",b.setAttribute("wrap","off"),b.wrap="off",b.style.overflow="auto",b.style.width="700px",b.style.height="350px",b.style.margin="5px",c.appendChild(b)),b.value+=a+"\n",b.scrollTop=b.scrollHeight-b.clientHeight}catch(d){alert("Exception: "+d.name+" Message: "+d.message)}}}var PACKET_HEADER_SIZE=13,OPCODE_MAP={RECV:new SNSBaseList,SEND:new SNSBaseList},OPCODE={AUTH:new _Opcode("auth",1),PING:new _Opcode("ping",2),RECEIPTS:new _Opcode("receipts",4098),USER_MESSAGE:new _Opcode("userMessage",4112),CHATGROUP_MESSAGE:new _Opcode("chatGroupMessage",4144),PUBACCOUNT_MESSAGE:new _Opcode("pubaccountMessage",4176),RECEIPTS:new _Opcode("receipts",4098),NOTIFY_MESSAGE:new _Opcode("notifyMessage",4099),INVITE_USERS:new _Opcode("inviteUsers",4865),VCARD:new _Opcode("vcard",8209),VCARDS:new _Opcode("vcards",8209,8210),IQ_RESULT:new _Opcode("iqResult",8225),QUERY_USER:new _Opcode("queryUser",8464,8465),QUERY_CHATGROUP:new _Opcode("queryChatGroup",8496,8497),QUERY_PUBACCOUNT:new _Opcode("queryPubaccount",8528,8529),ROSTER_LIST:new _Opcode("rosterList",8736,8737),CHATGROUP_LIST:new _Opcode("chatGroupList",8752,8753),CHATGROUP_MEMBER_LIST:new _Opcode("chatGroupMemberList",8768,8769),PUBACCOUNT_LIST:new _Opcode("pubaccountList",8784,8785),CHATGROUP_INFO:new _Opcode("chatGroupInfo",9008,9009),CHATGROUP_SHARED_FILES:new _Opcode("chatGroupSharedFiles",9010,9011),UPDATE_ROSTER:new _Opcode("updateRoster",9504),CONFIG_CHATGROUP:new _Opcode("chatGroupConfig",9520,9521),FULL_SYNC_ROSTER:new _Opcode("fullSyncRoster",10016),DELTA_SYNC_ROSTER:new _Opcode("deltaSyncRoster",10018),FULL_SYNC_CHATGROUP:new _Opcode("fullSyncChatGroup",10032),DELTA_SYNC_CHATGROUP:new _Opcode("deltaSyncChatGroup",10034),PRESENCE:new _Opcode("presence",12289),CHATGROUP:new _Opcode("chatGroup",13057,13058),DEL_GROUPMEMBER:new _Opcode("delGroupMember",9792),PACKET_ERROR:new _Opcode("packetError",16384),STREAM_ERROR:new _Opcode("streamError",16640),MESSAGE_RANGE:new _Range(4096,8192),IQ_RANGE:new _Range(8192,12288),PRESENCE_RANGE:new _Range(12288,16384)},PACKET_STRUCT={CONSOLE_FRAME:new _Range(0,1),OPCODE:new _Range(1,3),PACKET_LEN:new _Range(3,7),VERSION:new _Range(7,9),SEQ_ID:new _Range(9,13)},YYIMChat=function(){function b(a){this.level=a?a:0==a?0:3,this.start=function(){},this.log=function(a,b,c,d){if(h.LOG.ENABLE&&(b=b?b:0==b?0:3,!(b>this.level)&&"undefined"!=typeof console&&"undefined"!=typeof console.group))try{switch(console.group(a),b){case 0:console.error(a),console.trace();break;case 1:console.warn(a),console.trace();break;case 2:console.info(a);break;case 4:console.debug(a);break;default:console.log(a)}var e=arguments.length;if(e>2)for(var f=2;e>f;f++){var g=arguments[f];g&&(g instanceof JSJaCPacket?console.info(g.doc.xml):console.debug(g))}console.groupEnd()}catch(i){try{console.error(i)}catch(j){}}},this.logParam=function(a){a=a||3;var b=this.logParam.caller;this.log("arguments:",a,b.arguments)},this.setLevel=function(a){return this.level=a,this},this.getLevel=function(){return this.level}}function w(){this.lastPongTime,this.pingInterval,this.pingTimeout}function x(){this._inited=!1}function y(){this.daemon=new w,this.eventHandler=new x,this.connection=this.getConnection(),this.connectArg}function z(a){this.url=a.url,this.data=a.data,this.sCallback=a.successCallback,this.eCallback=a.errorCallback,this.xhr=function(){return window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")}(),this.timeout=1e4,this.timeoutIndex,this.loop=!1}var a={};a.getBareJID=function(a){var c,b=I.getInstance().getUserBareJID();if(a){if(a instanceof JSJaCJID)return a.getBareJID()==b?a.toString():a.getBareJID();if("string"==typeof a)return c=new JSJaCJID(a),c.getBareJID()==b?c.toString():c.getBareJID();if(a.jid&&a.jid instanceof JSJaCJID)return c=a.jid,c.getBareJID()==b?c.toString():c.getBareJID()}throw new JSJaCJIDInvalidException("invalid jid: "+a)},a.getID=function(a){var b,c,d;return YYIMCommonUtil.isStringAndNotEmpty(a)?(b=I.getInstance().getAppkey(),d=a.indexOf("@"),-1!=d?(c=a.substring(0,d),c.indexOf(b)>0?c.replace(b,""):c):a.indexOf(b)>0?a.replace(b,""):a):null},a.getNode=function(a){var b;return YYIMCommonUtil.isStringAndNotEmpty(a)?(b=I.getInstance().getAppkey(),-1!=a.indexOf("@")?a.substring(0,a.indexOf("@")):a.indexOf(b)>0?a:a+b):null},a.getResource=function(a){return YYIMCommonUtil.isStringAndNotEmpty(a)&&-1!=a.indexOf("/")?a.substring(a.indexOf("/")+1):null},a.buildUserJID=function(a,b){return YYIMCommonUtil.isStringAndNotEmpty(a)?-1!=a.indexOf("@")?a:a+"@"+c+(b?"/"+b:""):null},a.getDomain=function(a){return YYIMCommonUtil.isStringAndNotEmpty(a)&&-1!=a.indexOf("@")?a.substring(a.indexOf("@")+1):null},a.buildChatGroupJID=function(a){return YYIMCommonUtil.isStringAndNotEmpty(a)?-1!=a.indexOf("@")?a:a+"@"+h.DOMAIN.CHATROOM:null},a.buildPubAccountJID=function(a){return YYIMCommonUtil.isStringAndNotEmpty(a)?-1!=a.indexOf("@")?a:a+"@"+h.DOMAIN.PUBACCOUNT:null};var c="im.yyuap.com",d="stellar.yyuap.com",e=5227,f=7075,g="http://im.yyuap.com/sysadmin/",h={RESOURCE:"web-v2.0",IS_ANONYMOUS:!0,MULTI_TENANCY:{ENABLE:!0,ETP_KEY:"etp",APP_KEY:"app",SEPARATOR:"."},RECEIPTSPACKET_AUTO:!1,PACKETTYPE:{LONGCONNECT:"long connection",SHORTCONNECT:"short connection"},SUPPORT:{isWebSocketSupport:function(){var a=navigator.userAgent.indexOf("Safari")>-1&&navigator.userAgent.indexOf("Chrome")<1;return a?!1:(window.WebSocket=window.WebSocket||window.MozWebSocket,window.WebSocket?!0:!1)}(),isLocalConnectionSupport:function(){return window.localStorage?!0:!1}()},CONNECTION:{TIMERVAL:2e3,WAIT:300,SECURE:!1,ALLOW_PLAIN:!0,ENABLE_WEBSOCKET:!0,ENABLE_LOCAL_CONNECTION:!0,USE_HTTPS:!1,SERVER_NAME:c,HTTP_BASE:d,HTTP_BIND_PORT:f,WS_PORT:e},PING:{INTERVAL:3e4,DURATION:3e4,TIMEOUT:3e4},SERVLET:{FILE_UPLOAD_SERVLET:g+"fileUpload",FILE_DOWNLOAD_SERVLET:g+"download",FILE_DELETE_SERVLET:g+"cancel",AVATAR_SERVLET:g+"avatar",HISTORY_MESSAGE_SERVLET:g+"plugins/messageHistory/service",OFFLINE_MESSAGE_SERVLET:g+"rest/version/"},DOMAIN:{CHATROOM:"conference."+c,SEARCH:"search."+c,PUBACCOUNT:"pubaccount."+c},MESSAGE:{SEND_TIMEOUT:3e4,MAX_CHARACHER:1e3,REQUEST_RECEIPTS:!0},LOG:{ENABLE:!0,FILTER_LEVEL:3},BROWSER:function(){var a=navigator.userAgent.toLowerCase();return{version:(a.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[])[1],safari:/webkit/.test(a),opera:/opera/.test(a),msie:/msie/.test(a)&&!/opera/.test(a),mozilla:/mozilla/.test(a)&&!/(compatible|webkit)/.test(a)}}()};h.getHttpBindUrl=function(){var a=this.CONNECTION.USE_HTTPS?"https://":"http://";return a+this.CONNECTION.HTTP_BASE+":"+this.CONNECTION.HTTP_BIND_PORT+"/http-bind/"},h.getWebSocketUrl=function(){var a=this.CONNECTION.USE_HTTPS?"wss://":"ws://";return a+this.CONNECTION.HTTP_BASE+":"+this.CONNECTION.WS_PORT},h.useWebSocket=function(){return this.SUPPORT.isWebSocketSupport&&this.CONNECTION.ENABLE_WEBSOCKET},h.useLocalConnection=function(){return this.SUPPORT.isLocalConnectionSupport&&this.CONNECTION.ENABLE_LOCAL_CONNECTION},h.getConnectionArgObj=function(){var a={domain:this.CONNECTION.SERVER_NAME,resource:this.RESOURCE,allow_plain:this.CONNECTION.ALLOW_PLAIN,secure:this.CONNECTION.SECURE,register:!1};return this.IS_ANONYMOUS&&(a.authtype="saslanon"),a};var k={CHAT:"chat",AWAY:"away",XA:"xa",DND:"dnd",UNAVAILABLE:"unavailable"},l={SET:"set",RESULT:"result",GET:"get",SUBMIT:"submit",UNAVAILABLE:"unavailable"},m={SUBSCRIBE:"subscribe",UNSUBSCRIBE:"unsubscribe",SUBSCRIBED:"subscribed",UNSUBSCRIBED:"unsubscribed",PROBE:"probe",UNAVAILABLE:"unavailable"},o={CHAT:"chat",GROUP_CHAT:"groupchat",DEVICE:"device",PUB_ACCOUNT:"pubaccount"},p={JOIN:"join",QUIT:"quit"},q={MIXED:1,TEXT:2,FILE:4,IMAGE:8,SYSTEM:16,PUBLIC:32,SHARE:256},r=new Object;r.CHAT="chat",r.ERROR="error",r.GROUPCHAT="groupchat",r.HEADLINE="headline",r.NORMAL="normal",r.INVITE="invite",r.SUBSCRIBE="subscribe";var t=function(){function j(){var b=y.getInstance();b.registerHandler(OPCODE.UPDATE_ROSTER.KEY,function(b){var c=b.item,d=a.getID(b.item.jid);"both"===c.subscription?(H.log("update or add: "+JSON.stringify(c)),I.getInstance().onRosterUpdateded({id:d,name:c.name,groups:c.groups})):"none"===c.subscription?(H.log("delete: "+JSON.stringify(c)),I.getInstance().onRosterDeleted(d)):"remove"===c.subscription})}var b=function(){function b(b){var c={type:l.GET};YYIMCommonUtil.isStringAndNotEmpty(b.jid)?c.to=b.jid:null,y.getInstance().send(new JumpPacket(c,OPCODE.VCARD.SEND),function(b,c){c.complete&&c.complete();var d=b.vcard||{};c.success&&c.success({email:d.email,mobile:d.mobile,nickname:d.nickname,photo:d.photo,telephone:d.telephone,userId:a.getID(d.username)})},b)}function c(b){var c={type:"roster"};y.getInstance().send(new JumpPacket(c,OPCODE.VCARDS.SEND),function(b,c){var d=b.vcards||[];for(vcards=[],i=d.length;i--;){var e=d[i];vcards.push({email:e.email,mobile:e.mobile,nickname:e.nickname,photo:e.photo,userId:a.getID(e.username)})}c.complete&&c.complete(),c.success&&c.success(vcards)},b)}function d(a){y.getInstance().send(new JumpPacket({type:l.SET,vcard:a.vcard},OPCODE.VCARD.SEND),function(a,b){b.complete&&b.complete(),b.success&&b.success()},a)}return{getVCard:b,setVCard:d,getVCards:c}}(),c=function(){function b(b){var c=new JumpPacket({},OPCODE.ROSTER_LIST.SEND);y.getInstance().send(c,function(b,c){if(c){c.complete&&c.complete();var d=b.items;if(0!==(d&&d.length||0)){for(var e=[],f=d.length;f--;){var g=d[f],i=g.jid,j={id:a.getID(i),resource:a.getResource(i),ask:g.ask,name:g.name,photo:g.photo,subscription:g.subscription,group:g.groups};a.getDomain(i)!==h.DOMAIN.PUBACCOUNT&&e.push(j)}c.success&&c.success(JSON.stringify(e))}}},b)}function c(b){var c={type:l.SET,ns:NS_ROSTER,item:{jid:b.jid,subscription:"remove"}};y.getInstance().send(new JumpPacket(c,OPCODE.UPDATE_ROSTER.SEND),function(b,c){c.complete&&c.complete(),c.success&&c.success(a.getID(c.jid))},b)}function d(b){for(var c=b.roster,d={item:{jid:c.jid,name:YYIMCommonUtil.isStringAndNotEmpty(c.name)?c.name:a.getID(c.jid),groups:[]}},e=c.groups,f=e?e.length:0;f--&&YYIMCommonUtil.isStringAndNotEmpty(e[f]);)d.item.groups=d.item.groups.concat(e[f]);y.getInstance().send(new JumpPacket(d,OPCODE.UPDATE_ROSTER.SEND),function(a,b){b.complete&&b.complete(),b.success&&b.success()},b)}function e(b){var c={start:YYIMCommonUtil.isNumber(b.start)?b.start:0,size:YYIMCommonUtil.isNumber(b.size)?b.size:20,fields:["Username","Name"],search:b.keyword};y.getInstance().send(new JumpPacket(c,OPCODE.QUERY_USER.SEND),function(b,c){for(var d=b.items||[],e=[],f=d.length;f--;){var g=d[f],h=g.jid;h!==I.getInstance().getUserBareJID()&&e.push({id:a.getID(h),name:YYIMCommonUtil.isStringAndNotEmpty(g.name)?g.name:a.getID(h),photo:g.photo,email:g.email})}c.complete&&c.complete(),c.success&&c.success({start:b.start,total:b.total,items:e})},b)}return{getRosterItems:b,deleteRosterItem:c,queryRosterItem:e,updateRosterItem:d}}(),d=function(){function b(b){var c=new JumpPacket({},OPCODE.CHATGROUP_LIST.SEND);y.getInstance().send(c,function(b,c){if(c){c.complete&&c.complete();var d=b.items;if(0!==(d&&d.length||0)){for(var e=[],f=d.length;f--;){var g=d[f],h=g.jid,i={id:a.getID(h),name:g.name,photo:g.photo};e.push(i)}c.success&&c.success(JSON.stringify(e))}}},b)}function c(b){var c={start:YYIMCommonUtil.isNumber(b.start)?b.start:0,size:YYIMCommonUtil.isNumber(b.size)?b.size:20,search:b.keyword};y.getInstance().send(new JumpPacket(c,OPCODE.QUERY_CHATGROUP.SEND),function(b,c){for(var d=b.items||[],e=[],f=d.length;f--;){var g=d[f],h=g.jid;e.push({id:a.getID(h),name:YYIMCommonUtil.isStringAndNotEmpty(g.name)?g.name:a.getID(h)})}c.complete&&c.complete(),c.success&&c.success({start:b.start,total:b.total,items:e})},b)}function d(a){var b={to:a.jid,roomname:a.name,roomdesc:a.desc,persistent:1,owners:[I.getInstance().getUserBareJID()],etp:h.MULTI_TENANCY.ETP_KEY,app:h.MULTI_TENANCY.APP_KEY};YYIMCommonUtil.isStringAndNotEmpty(a.photo)&&(b.photo=a.photo),y.getInstance().send(new JumpPacket(b,OPCODE.CONFIG_CHATGROUP.SEND),function(a,b){b.complete&&b.complete(),b.success&&b.success()},a)}function e(b){var c={to:b.jid,type:l.GET,ns:NS_DISCO_INFO};y.getInstance().send(new JumpPacket(c,OPCODE.CHATGROUP_INFO.SEND),function(b,c){c.complete&&c.complete();var d=b.roomname?b.roomname:a.getID(c.jid),e=b.description;c.success&&c.success({name:d,desc:e})},b)}function f(b){var c={to:b.jid,start:b.start,size:b.size};y.getInstance().send(new JumpPacket(c,OPCODE.CHATGROUP_SHARED_FILES.SEND),function(b,c){c.complete&&c.complete();var d={start:b.start,total:b.total,files:[]};for(files=b.files||[],i=files.length;i--;){var e=files[i];d.files.push({attachId:e.id,name:e.name,type:e.type,size:e.size,createTime:e.createTime,creator:a.getID(e.creator),downloads:e.downloads})}c.success&&c.success(d)},b)}return{queryChatGroup:c,configChatGroup:d,getChatGroups:b,getChatGroupInfo:e,getSharedFiles:f}}(),e=function(){function b(b){y.getInstance().send(new JumpPacket({type:l.GET,ns:NS_DISCO_ITEMS,to:b.jid},OPCODE.CHATGROUP_MEMBER_LIST.SEND),function(b,c){if(c){c.complete&&c.complete();var d=b.items;if(0!==(d&&d.length||0)){for(var e=[],f=-1,g=d.length;++f<g;){var h=d[f],i=h.jid;e.push({id:a.getID(i),name:h.name,photo:h.photo,affiliation:h.affiliation})}c.success&&c.success(JSON.stringify(e))}}},b)}return{getGroupMembers:b}}(),f=function(){function b(b){var c=new JumpPacket({type:l.GET,ns:NS_PUBACCOUNT,to:h.DOMAIN.PUBACCOUNT},OPCODE.PUBACCOUNT_LIST.SEND);y.getInstance().send(c,function(b,c){if(c){c.complete&&c.complete();var d=b.items;if(0!==(d&&d.length||0)){for(var e=[],f=d.length;f--;){var g=d[f],h=g.jid,i={id:a.getID(h),resource:a.getResource(h),name:g.name,photo:g.photo};e.push(i)}c.success&&c.success(JSON.stringify(e))}}},b)}function c(b){var c={start:YYIMCommonUtil.isNumber(b.start)?b.start:0,size:YYIMCommonUtil.isNumber(b.size)?b.size:20,fields:["Accountname","Name"],search:b.keyword};y.getInstance().send(new JumpPacket(c,OPCODE.QUERY_PUBACCOUNT.SEND),function(b,c){for(var d=b.items||[],e=[],f=d.length;f--;){var g=d[f],h=g.jid;e.push({id:a.getID(h),name:YYIMCommonUtil.isStringAndNotEmpty(g.name)?g.name:a.getID(h)})}c.complete&&c.complete(),c.success&&c.success({start:b.start,total:b.total,items:e})},b)}return{getPubAccountItems:b,queryPubaccount:c}}(),g=function(){function a(a){y.getInstance().send(new JumpPacket({submits:a},OPCODE.FULL_SYNC_ROSTER.SEND))}function b(a,b){var c={};a.length>0&&(c.removes=a),b.length>0&&(c.sets=b),(a.length>0||b.length>0)&&y.getInstance().send(new JumpPacket(c,OPCODE.DELTA_SYNC_ROSTER.SEND))}function c(a){y.getInstance().send(new JumpPacket({submits:a},OPCODE.FULL_SYNC_CHATGROUP.SEND))}function d(a,b){var c={};a.length>0&&(c.removes=a),b.length>0&&(c.sets=b),(a.length>0||b.length>0)&&y.getInstance().send(new JumpPacket(c,OPCODE.DELTA_SYNC_CHATGROUP.SEND))}return{fullSyncRoster:a,deltaSyncRoster:b,fullSyncChatGroup:c,deltaSyncChatGroup:d}}();return{monitor:j,getVCard:b.getVCard,setVCard:b.setVCard,getVCards:b.getVCards,getRosterItems:c.getRosterItems,deleteRosterItem:c.deleteRosterItem,queryRosterItem:c.queryRosterItem,updateRosterItem:c.updateRosterItem,queryChatGroup:d.queryChatGroup,configChatGroup:d.configChatGroup,getChatGroups:d.getChatGroups,getChatGroupInfo:d.getChatGroupInfo,getSharedFiles:d.getSharedFiles,getGroupMembers:e.getGroupMembers,getPubAccountItems:f.getPubAccountItems,queryPubaccount:f.queryPubaccount,fullSyncRoster:g.fullSyncRoster,deltaSyncRoster:g.deltaSyncRoster,fullSyncChatGroup:g.fullSyncChatGroup,deltaSyncChatGroup:g.deltaSyncChatGroup}}(),u=function(){function c(){var a=y.getInstance();a.registerHandler(OPCODE.USER_MESSAGE.KEY,function(a){d(a,"chat")}),a.registerHandler(OPCODE.CHATGROUP_MESSAGE.KEY,function(a){d(a,"groupchat")}),a.registerHandler(OPCODE.PUBACCOUNT_MESSAGE.KEY,function(a){d(a,"chat")})}function d(c,d){if(void 0==c.content)return void console.error("packetContent_error:");if(console.log("packetContent:",c.content),b.get(c.id)!==!0&&(b.add(c.id,!0),c.from!==I.getInstance().getUserFullJID())){var f=c.content;try{f=JSON.parse(c.content)}catch(g){}var i={content:f.content,contentType:c.contentType,dateline:c.dateline,receiptsbody:{type:h.PACKETTYPE.LONGCONNECT,receipts:c.receipts,arg:{from:c.from,id:c.id}},extend:f&&f.extend?f.extend:void 0},j=d==o.CHAT?a.getID(c.from):{room:a.getID(c.from),roster:a.getID(a.getResource(c.from))},k={id:c.id,type:d,from:j,data:i};if(d==o.CHAT)k.resource=a.getResource(c.from);else if(d==o.GROUP_CHAT&&j.roster==I.getInstance().getUserID())return;if(i.contentType==q.TEXT){f.style&&(k.data.style=f.style);try{I.getInstance().onTextMessage(k),console.log("text_message:",k)}catch(g){console.error(g.message,c,d)}}else if(i.contentType==q.IMAGE){k.data&&k.data.content&&k.data.content.path&&(k.data.content.path=YYIMChat.getFileUrl(k.data.content.path));try{I.getInstance().onPictureMessage(k),console.log("image_message:",k)}catch(g){console.error(g.message,c,d)}}else if(i.contentType==q.FILE){k.data&&k.data.content&&k.data.content.path&&(k.data.content.path=YYIMChat.getFileUrl(k.data.content.path));try{I.getInstance().onFileMessage(k),console.log("file_message:",k)}catch(g){console.error(g.message,c,d)}}else if(i.contentType==q.SHARE)try{I.getInstance().onShareMessage(k),console.log("share_message:",k)}catch(g){console.error(g.message,c,d)}c.receipts===!0&&h.RECEIPTSPACKET_AUTO&&e({from:c.from,id:c.id})}}function e(a){var b=new JumpPacket({to:a.from,dateline:(new Date).getTime(),id:a.id},OPCODE.RECEIPTS.SEND);y.getInstance().send(b)}function f(a){var b=new JumpPacket({to:a.from,dateline:(new Date).getTime(),id:a.id,state:2},OPCODE.RECEIPTS.SEND);y.getInstance().send(b)}function g(b){var c,d=b.body||{},e={id:b.id,type:b.type,contentType:d.contentType||q.TEXT,dateline:d.dateline,content:{extend:d.extend,content:d.content}},f=OPCODE.USER_MESSAGE.SEND;"chat"==b.type?(e.receipts="1",c=b.resource?"anonymous"==b.resource.toLowerCase()?a.buildUserJID(a.getID(b.to),b.resource.toUpperCase()):b.to==YYIMChat.getUserID()?a.buildUserJID(a.getNode(b.to),b.resource):a.buildUserJID(a.getNode(b.to)):a.buildUserJID(a.getNode(b.to))):"groupchat"==b.type?(c=a.buildChatGroupJID(a.getNode(b.to)),f=OPCODE.CHATGROUP_MESSAGE.SEND):"pubaccount"==b.type&&(c=a.buildPubAccountJID(a.getNode(b.to)),f=OPCODE.PUBACCOUNT_MESSAGE.SEND),e.to=c,b.style&&(e.content.style=b.style);var g=new JumpPacket(e,f);y.getInstance().send(g,function(a){I.getInstance().onReceipts(a.id)}),b.success&&b.success(b)}function i(a,b){y.getInstance().send(new JumpPacket({to:a,invites:b},OPCODE.INVITE_USERS.SEND))}function j(b){var c=h.SERVLET.HISTORY_MESSAGE_SERVLET+"?token="+I.getInstance().getToken()+"&start="+b.start+"&num="+b.num+"&type=1&toUser=";c+=b.resource&&"anonymous"==b.resource?b.id:a.getNode(b.id),YYIMCommonUtil.isStringAndNotEmpty(b.chatType)&&(c+="&fromUser="+I.getInstance().getUserNode()),I.getInstance().log("\u5386\u53f2\u8bb0\u5f55\uff1arequest URL",2,c),jQuery.ajax({url:c,dataType:"json",success:function(a){r(a,b)},error:function(a,b,c){I.getInstance().log("ajax error",3,a.status+a.readyState+a.responseText)}})}function k(a){var b=h.SERVLET.OFFLINE_MESSAGE_SERVLET+h.MULTI_TENANCY.ETP_KEY+"/"+h.MULTI_TENANCY.APP_KEY+"/"+a.id+"/version?resource="+h.RESOURCE+"&token="+I.getInstance().getToken();I.getInstance().log("\u83b7\u53d6\u7248\u672c\u53f7\uff1aget version",2,b),jQuery.ajax({url:b,dataType:"json",success:function(b){YYIMCookieUtil.setcookie("offline_version_"+a.id,b,1440,"/"),a.version=b,l(a)},error:function(a,b,c){console.error("getVersion error"),I.getInstance().log("getOfflineMessage ajax error",3,a.status+a.readyState+a.responseText)}})}function l(a){a.start||(a.start=0),a.size||(a.size=100);var b=h.SERVLET.OFFLINE_MESSAGE_SERVLET+h.MULTI_TENANCY.ETP_KEY+"/"+h.MULTI_TENANCY.APP_KEY+"/"+a.id+"?version="+a.version+"&start="+a.start+"&size="+a.size+"&resource="+h.RESOURCE+"&token="+I.getInstance().getToken();I.getInstance().log("\u79bb\u7ebf\u6d88\u606f\uff1arequest URL",2,b),jQuery.ajax({url:b,dataType:"json",success:function(b){b.version>a.version?p(b,a):b.version<a.version&&b.version>=-1&&k(a)},error:function(a,b,c){console.error("getOfflineMessage error"),I.getInstance().log("getOfflineMessage ajax error",3,a.status+a.readyState+a.responseText)}})}function m(a,b){var c=h.SERVLET.OFFLINE_MESSAGE_SERVLET+h.MULTI_TENANCY.ETP_KEY+"/"+h.MULTI_TENANCY.APP_KEY+"/"+b.id+"/ack?oldversion="+b.version+"&version="+a.version+"&resource="+h.RESOURCE+"&token="+I.getInstance().getToken();I.getInstance().log("\u79bb\u7ebf\u6d88\u606f\u5904\u7406\u540e\u51fd\u6570\uff1arequest URL",2,c),jQuery.ajax({url:c,dataType:"json",type:"put",statusCode:{200:function(){YYIMCookieUtil.setcookie("offline_version_"+b.id,a.version,1440,"/")}},error:function(a,b,c){console.error("_offlineMessagehandleAfter error"),I.getInstance().log("_offlineMessagehandleAfter ajax error",3,a.status+a.readyState+a.responseText)}})}function p(b,c){if(I.getInstance().log("\u79bb\u7ebf\u6d88\u606f\u5904\u7406\u51fd\u6570\uff1adata",2,b),b.packets&&b.packets.length){for(var e in b.packets){var f=b.packets[e],h=(f.opcode,JSON.parse(f.body));console.log("offline_packet:",h),n.unshift(h)}if(b.packets.length>=b.size)l({id:c.id,version:c.version,start:b.start+b.size});else{if(n.length){for(var i in n)"subscribe"==n[i].type?I.getInstance().onSubscribe({from:a.getID(n[i].from),type:n[i].type}):("chat"==n[i].type||"groupchat"==n[i].type)&&d(n[i],n[i].type);n=[]}m(b,c)}}else if(!b.packets||!b.packets.length){if(n.length){for(var j in n)"subscribe"==n[j].type?I.getInstance().onSubscribe({from:a.getID(n[j].from),type:n[j].type}):("chat"==n[j].type||"groupchat"==n[j].type)&&d(n[j],n[j].type);n=[]}m(b,c)}}function r(b,c){function g(a){if(!a.stanza)return a.messageID;var b=jQuery(a.stanza).attr("id");return b?b:Math.uuid()}function h(b){if(!b.stanza)return null;var c=jQuery(b.stanza).attr("from");return c?a.getResource(c):null}function i(a){if(a){var b=JSON.parse(a);try{b.content=JSON.parse(b.content),b.content.style&&(b.style=b.content.style,delete b.content.style),b.content.content&&(b.content=b.content.content)}catch(c){}return b}return null}YYIMChat.log("\u5386\u53f2\u8bb0\u5f55\uff1adata",2,b);for(var d=[],e=0;e<b.result.length;e++){var f={fromId:a.getID(b.result[e].sender),toId:a.getID(b.result[e].receiver),msgId:g(b.result[e])};c.chatType&&"groupchat"==c.chatType&&(f.memberId=h(b.result[e])),b.result[e].content&&(f.body=i(b.result[e].content),f.body.content&&f.body.contentType&&(f.body.contentType==q.IMAGE||f.body.contentType==q.FILE)&&(f.body.content.path=f.body.content.path?YYIMChat.getFileUrl(f.body.content.path):null),d.push(f))}YYIMCommonUtil.isFunction(c.success)&&c.success({count:Number(b.count),result:d})}var b=new SNSBaseList,n=[];return{monitor:c,sendMessage:g,addGroupMember:i,getHistoryMessage:j,getOfflineMessage:l,getVersion:k,sendReceiptsPacket:e,sendReadedReceiptsPacket:f}}(),v=function(){function b(){var b=y.getInstance();b.registerHandler(OPCODE.PRESENCE.KEY,function(b){if(b.type&&b.type!=l.UNAVAILABLE)return void I.getInstance().onSubscribe({from:a.getID(b.from),type:b.type});var c={from:a.getID(b.from),resource:a.getResource(b.from),type:b.type,show:b.show,status:b.status};E.getInstance().addToOnline(c.from),b.type&&b.type==l.UNAVAILABLE&&(c.show=k.UNAVAILABLE,c.status=k.UNAVAILABLE,E.getInstance().removeFromOnline(c.from)),YYIMCommonUtil.isStringAndNotEmpty(c.status)||(c.show=k.CHAT,c.status=k.CHAT),I.getInstance().onPresence(c)}),b.registerHandler(OPCODE.CHATGROUP.KEY,function(b){b.type==m.UNAVAILABLE?I.getInstance().onRoomMemerPresence({room:a.getID(b.from),member:{id:a.getID(b.jid)},type:p.QUIT}):I.getInstance().onRoomMemerPresence({room:a.getID(b.from),member:{id:a.getID(b.jid),nick:b.name?b.name:a.getID(b.jid),affiliation:b.affiliation,role:b.role},type:p.JOIN})})}function c(a){var b={};YYIMCommonUtil.isStringAndNotEmpty(a.show)&&(b.show=a.show),
YYIMCommonUtil.isStringAndNotEmpty(a.status)&&(b.status=a.status),YYIMCommonUtil.isStringAndNotEmpty(a.priority)&&(b.priority=a.priority),YYIMCommonUtil.isStringAndNotEmpty(a.type)&&(b.type=a.type),y.getInstance().send(new JumpPacket(b,OPCODE.PRESENCE.SEND))}function d(a){y.getInstance().send(new JumpPacket({type:m.SUBSCRIBE,to:a},OPCODE.PRESENCE.SEND))}function e(a){y.getInstance().send(new JumpPacket({type:m.SUBSCRIBED,to:a},OPCODE.PRESENCE.SEND))}function f(a){YYIMConncetion.getInstance().send(new JumpPacket({type:m.UNSUBSCRIBED,to:a},OPCODE.PRESENCE.SEND))}function g(a){y.getInstance().send(new JumpPacket({type:m.SUBSCRIBE,to:a.jid},OPCODE.PRESENCE.SEND),function(a,b){b.complete&&b.complete(),b.success&&b.success()},a)}function h(b){var c={to:b.jid+"/"+I.getInstance().getUserNode()};y.getInstance().send(new JumpPacket(c,OPCODE.CHATGROUP.SEND),function(c,d){b.complete&&b.complete(),b.success&&b.success({id:a.getID(c.from),affiliation:c.affiliation,role:c.role})},b)}function i(a,b,c){var d=parseInt(1e5+1e5*Math.random()),e=a;b.indexOf("@")>0&&(b=b.split("@")[0]),y.getInstance().send(new JumpPacket({id:d,to:e,nick:b,role:"none"},OPCODE.DEL_GROUPMEMBER.SEND),function(a){c&&"function"==typeof c&&c(a)})}function j(a){y.getInstance().send(new JumpPacket({type:m.UNAVAILABLE,to:a+"/"+I.getInstance().getUserNode()},OPCODE.CHATGROUP.SEND),function(){})}return{monitor:b,addRosterItem:d,approveSubscribe:e,rejectSubscribe:f,setPresence:c,addPubAccount:g,joinChatGroup:h,delGroupMember:i,quitChatGroup:j}}();w.prototype.startPing=function(){y.getInstance().connected()&&(this.pingInterval=setInterval(this.ping.bind(this),h.PING.INTERVAL))},w.prototype.stopPing=function(){clearTimeout(this.pingTimeout),clearInterval(this.pingInterval)},w.prototype.ping=function(){var a=(new Date).getTime();if(!(a-this.lastPongTime<h.PING.DURATION)){var b=new JumpPacket(null,OPCODE.PING.SEND);try{y.getInstance().send(b),this.pingTimeout=setTimeout(this.timeoutHandler.bind(this),h.PING.TIMEOUT)}catch(c){return H.log("SNSConnectService.ping",0,c),this.stopPing(),void I.getInstance().onConnectError({errorCode:408,message:"\u8fde\u63a5\u5931\u8d25"})}}},w.prototype.pong=function(){this.lastPongTime=(new Date).getTime(),clearTimeout(this.pingTimeout)},w.prototype.timeoutHandler=function(){this.stopPing(),I.getInstance().onConnectError({errorCode:408,message:"\u8fde\u63a5\u5931\u8d25"})},x.prototype._init=function(){if(H.log("YYIMConnectEventHandler.prototype.registerHandler",3),!this._inited){var a=y.getInstance();a.registerHandler("onConnect",this.onConnected),a.registerHandler("onDisconnect",this.onDisConnect),a.registerHandler("onStatusChanged",this.connectStatusChangeHandler),a.registerHandler(OPCODE.STREAM_ERROR.KEY,this.onStreamError),a.registerHandler(OPCODE.PACKET_ERROR.KEY,this.onPacketError),this._inited=!0}},x.prototype.onConnected=function(){I.getInstance().onOpened(),y.getInstance().getDaemon().startPing()},x.prototype.onConnectError=function(a){H.log("YYIMConnectEventHandler.prototype.onConnectError ",0,a),errorCode=a.getAttribute("code"),y.getInstance().getDaemon().stopPing(),401==errorCode||errorCode/10==401?I.getInstance().onAuthError({errorCode:401,message:"\u7528\u6237\u540d\u6216\u5bc6\u7801\u9519\u8bef"}):I.getInstance().onConnectError({errorCode:errorCode,message:"\u8fde\u63a5\u5931\u8d25"})},x.prototype.onStreamError=function(a){H.log("YYIMConnectEventHandler.prototype.onPacketError ",0,a),y.getInstance().getDaemon().stopPing(),401==a.code||a.code/10==401?I.getInstance().onAuthError({errorCode:401,message:"\u7528\u6237\u540d\u6216\u5bc6\u7801\u9519\u8bef"}):I.getInstance().onConnectError({errorCode:a.code,message:a.message})},x.prototype.onPacketError=function(a){H.log("YYIMConnectEventHandler.prototype.onPacketError ",0,a)},x.prototype.onDisConnect=function(){I.getInstance().onClosed(),y.getInstance().getDaemon().stopPing()},x.prototype.connectStatusChangeHandler=function(a){H.log("connectStatusChangeHandler",3,a),I.getInstance().onStatusChanged(a)},y.getInstance=function(){return y._instance||(y._instance=new y,y._instance._init()),y._instance},y.prototype.getDaemon=function(){return this.daemon},y.prototype._init=function(){v.monitor(),u.monitor(),t.monitor(),this.eventHandler._init(),this.registerHandler(OPCODE.AUTH.KEY,function(b){var c=new JSJaCJID(b.jid),d=a.getID(b.jid);I.getInstance()._user={jid:c,name:d},I.getInstance().onUserBind(d,c.getResource())}),this.registerHandler(OPCODE.PING.KEY,this.getDaemon().pong.bind(this.getDaemon()))},y.prototype.registerHandler=function(a,b,c,d){if(this.connection)return void this.connection.registerHandler.apply(this.connection,arguments);throw"connection is undefined!"},y.prototype.connected=function(){return this.connection&&this.connection.connected()?!0:!1},y.prototype.getConnection=function(){return this.connection||(h.useWebSocket()?this.connection=new JSJaCWebSocketConnection({httpbase:h.getWebSocketUrl()}):this.connection=new JSJaCHttpBindingConnection({httpbase:h.getHttpBindUrl(),timerval:h.CONNECTION.TIMERVAL,wait:h.CONNECTION.WAIT})),this.connection},y.prototype.connect=function(a,b,d){!this.connectArg&&!a,this.connectArg||(this.connectArg=h.getConnectionArgObj()),a&&(this.connectArg.username=a,this.connectArg.password=b),I.getInstance()._user={jid:new JSJaCJID(this.connectArg.username+"@"+c+"/"+this.connectArg.resource),name:this.connectArg.username},this.connection.connect(this.connectArg)},y.prototype.disconnect=function(){this.daemon.stopPing(),this.connection&&this.connection.disconnect()},y.prototype.send=function(a,b,c,d){return d?this.connection.sendJumpPacket(a,b.bind(d),c):this.connection.sendJumpPacket(a,b,c)},z.prototype.get=function(){var a=this.xhr;a.open("GET",this.url,!0),z.prototype._listenFn.call(this),a.send()},z.prototype.post=function(){var a=this.xhr;a.open("POST",this.url,!0),z.prototype._listenFn.call(this),a.setRequestHeader("Content-Type","x-www-form-urlencoded"),a.send(this.data)},z.prototype.isLoop=function(a){this.loop=a},z.prototype.stopLoop=function(){clearTimeout(_self.timeoutIndex)},z.prototype._listenFn=function(){var a=this,b=this.xhr;this.timeoutIndex=setTimeout(function(){a.loop&&z.prototype.get.call(a),a.eCallback(b.responseText)},a.timeout),b.onreadystatechange=function(){4==b.readyState&&(clearTimeout(a.timeoutIndex),200==b.status?a.sCallback(b.responseText):a.eCallback(b.responseText))}};var A=function(){this._provider};A.getInstance=function(){return A._instance||(A._instance=new A),A._instance},A.prototype.init=function(a){a&&a.provider?this._provider=a.provider:this._provider=new B},A.prototype.getProvider=function(){return this._provider||(this._provider=new B),this._provider},A.prototype.getChatGroups=function(a){this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().getChatGroups)&&this.getProvider().getChatGroups(a)},A.prototype.addChatGroup=function(b){v.joinChatGroup({jid:a.buildChatGroupJID(a.getNode(b.node)),success:function(){t.configChatGroup({jid:this.jid,name:b.name,desc:b.desc,error:b.error,success:function(){b.success&&b.success({name:b.name,node:b.node,id:b.id,nickname:I.getInstance().getUserID()})},complete:b.complete})},error:function(){b.error&&b.error()}}),this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().addChatGroup)&&this.getProvider().addChatGroup(b)},A.prototype.delGroupMember=function(a,b,c){v.delGroupMember(a,b,c)},A.prototype.quitChatGroup=function(a){v.quitChatGroup(a),this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().quitChatGroup)&&this.getProvider().quitChatGroup(a)},A.prototype.queryChatGroup=function(a){this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().queryChatGroup)&&this.getProvider().queryChatGroup(a)},A.prototype.joinChatGroup=function(a){v.joinChatGroup(a)},A.prototype.updateChatGroup=function(a){t.configChatGroup(a)};var B=function(){};B.prototype.getChatGroups=function(a){t.getChatGroups(a)},B.prototype.addChatGroup=function(a){},B.prototype.quitChatGroup=function(a){},B.prototype.queryChatGroup=function(a){t.queryChatGroup(a)};var C=function(){this._provider};C.getInstance=function(){return C._instance||(C._instance=new C),C._instance},C.prototype.init=function(a){a&&a.provider?this._provider=a.provider:this._provider=new D},C.prototype.getProvider=function(){return this._provider||(this._provider=new D),this._provider},C.prototype.getGroupMembers=function(a){this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().getGroupMembers)&&this.getProvider().getGroupMembers(a)},C.prototype.addGroupMember=function(a,b){u.addGroupMember(a,b),this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().addGroupMember)&&this.getProvider().addGroupMember(a,b)};var D=function(){};D.prototype.getGroupMembers=function(a){t.getGroupMembers(a)},D.prototype.addGroupMember=function(a,b){};var E=function(){this._provider,this._onlineList=new SNSBaseList};E.getInstance=function(){return E._instance||(E._instance=new E),E._instance},E.prototype.addToOnline=function(a){this._onlineList.add(a,!0)},E.prototype.removeFromOnline=function(a){this._onlineList.remove(a)},E.prototype.init=function(a){a&&a.provider?this._provider=a.provider:this._provider=new F},E.prototype.getProvider=function(){return this._provider||(this._provider=new F),this._provider},E.prototype.getRosterItems=function(a){this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().getRosterItems)&&this.getProvider().getRosterItems(a)},E.prototype.addRosterItem=function(a){v.addRosterItem(a),this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().addRosterItem)&&this.getProvider().addRosterItem(a)},E.prototype.deleteRosterItem=function(a){t.deleteRosterItem(a),this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().deleteRosterItem)&&this.getProvider().deleteRosterItem(a)},E.prototype.queryRosterItem=function(a){this.getProvider()&&YYIMCommonUtil.isFunction(this.getProvider().queryRosterItem)&&this.getProvider().queryRosterItem(a)};var F=function(){};F.prototype.getRosterItems=function(a){t.getRosterItems(a)},F.prototype.addRosterItem=function(a){},F.prototype.deleteRosterItem=function(a){},F.prototype.queryRosterItem=function(a){t.queryRosterItem(a)};var G=function(){},H=new b(h.LOG.FILTER_LEVEL),I=function(){this._user,this.init(),this._token={},this._anonymousUser=!1,this.appkey,this.version="2.0"};return I.getInstance=function(){return I._instance||(I._instance=new I),I._instance},I.prototype.log=function(a,b,c,d){H.log(a,b,c,d)},I.prototype.init=function(a){a=a||new Object,this.onOpened=a.onOpened||G,this.onClosed=a.onClosed||G,this.onAuthError=a.onAuthError||G,this.onStatusChanged=a.onStatusChanged||G,this.onConnectError=a.onConnectError||G,this.onUserBind=a.onUserBind||G,this.onPresence=a.onPresence||G,this.onSubscribe=a.onSubscribe||G,this.onRosterDeleted=a.onRosterDeleted||G,this.onRosterUpdateded=a.onRosterUpdateded||G,this.onRoomMemerPresence=a.onRoomMemerPresence||G,this.onMessage=a.onMessage||G,this.onReceipts=a.onReceipts||G,this.onTextMessage=a.onTextMessage||G,this.onPictureMessage=a.onPictureMessage||G,this.onFileMessage=a.onFileMessage||G,this.onShareMessage=a.onShareMessage||G,this.onDeviceMessage=a.onDeviceMessage||G,this.onMessageOut=a.onMessageout||G},I.prototype.initUpload=function(){if(arguments&&SNSIMUploadUseFlash&&"function"==typeof SNSIMUploadUseFlash.prototype.addUploader)for(i=0;i<arguments.length;i++){var a=arguments[i];"string"==typeof a.button_placeholder_id&&SNSIMUploadUseFlash.getInstance().addUploader(a)}},I.prototype.initSDK=function(a,b){var c=h.MULTI_TENANCY;c.ENABLE=!0,c.APP_KEY=a,c.ETP_KEY=b,this.appkey=c.SEPARATOR+c.APP_KEY+c.SEPARATOR+c.ETP_KEY},I.prototype.getTenancy=function(){return h.MULTI_TENANCY},I.prototype.getAppkey=function(){return this.appkey},I.prototype.setRosterProvider=function(a){E.getInstance().init({provider:a||new F})},I.prototype.setChatGroupProvider=function(a){A.getInstance().init({provider:a||new B})},I.prototype.setChatGroupMemberProvider=function(a){C.getInstance().init({provider:a||new D})},I.prototype.setServer=function(a,b){h.CONNECTION.SERVER_NAME=a,b?h.CONNECTION.HTTP_BASE=b:h.CONNECTION.HTTP_BASE=a},I.prototype.disConnect=function(){y.getInstance().disconnect()},I.prototype.connect=function(){y.getInstance().connect()},I.prototype.getToken=function(){return this._token.token},I.prototype.getTokenExpiration=function(){return this._token.expiration},I.prototype.login=function(b,c,d){this._token={token:c,expiration:d},!YYIMCommonUtil.isStringAndNotEmpty(b)&&h.IS_ANONYMOUS&&(this._anonymousUser=!0),!this.isAnonymous()&&h.MULTI_TENANCY.ENABLE&&(b=a.getNode(b)),y.getInstance().connect(b,c)},I.prototype.logout=function(){y.getInstance().disconnect()},I.prototype.getUserBareJID=function(){return this._user.jid.getBareJID()},I.prototype.getUserFullJID=function(){return this._user.jid.toString()},I.prototype.getUserNode=function(){return a.getNode(this.getUserBareJID())},I.prototype.getUserID=function(){return a.getID(this.getUserBareJID())},I.prototype.fullSyncRoster=function(b){if(YYIMArrayUtil.isArray(b)){for(var c=b.length,d=[];c--;)YYIMCommonUtil.isStringAndNotEmpty(b[c].id)&&d.push({jid:a.buildUserJID(a.getNode(b[c].id)),name:b[c].name?b[c].name:b[c].id});t.fullSyncRoster(d)}},I.prototype.deltaSyncRoster=function(b,c){var d=-2,e=-2,f=[],g=[];if(YYIMArrayUtil.isArray(b))for(d=b.length;d--;)YYIMCommonUtil.isStringAndNotEmpty(b[d])&&f.push(a.buildUserJID(a.getNode(b[d])));if(YYIMArrayUtil.isArray(c))for(e=c.length;e--;)YYIMCommonUtil.isStringAndNotEmpty(c[e].id)&&g.push({jid:a.buildUserJID(a.getNode(c[e].id)),name:c[e].name?c[e].name:c[e].id});(-2!==d||-2!==e)&&t.deltaSyncRoster(f,g)},I.prototype.fullSyncChatGroup=function(b){if(YYIMArrayUtil.isArray(b)){for(var c=b.length,d=[];c--;)YYIMCommonUtil.isStringAndNotEmpty(b[c].id)&&d.push({id:a.getID(b[c].id),name:b[c].name?b[c].name:b[c].id});t.fullSyncChatGroup(d)}},I.prototype.deltaSyncChatGroup=function(b,c){var d=-2,e=-2,f=[],g=[];if(YYIMArrayUtil.isArray(b))for(d=b.length;d--;)YYIMCommonUtil.isStringAndNotEmpty(b[d])&&f.push(a.getID(b[d]));if(YYIMArrayUtil.isArray(c))for(e=c.length;e--;)YYIMCommonUtil.isStringAndNotEmpty(c[e].id)&&g.push({id:a.getID(c[e].id),name:c[e].name?c[e].name:c[e].id});(-2!==d||-2!==e)&&t.deltaSyncChatGroup(f,g)},I.prototype.setPresence=function(a){a||(a={status:k.AVAILABLE}),v.setPresence(a)},I.prototype.getVCard=function(b){var c={success:b.success,error:b.error,complete:b.complete};YYIMCommonUtil.isStringAndNotEmpty(b.id)&&(c.jid=a.buildUserJID(a.getNode(b.id))),t.getVCard(c)},I.prototype.getVCards=function(a){t.getVCards({success:a.success,error:a.error,complete:a.complete})},I.prototype.setVCard=function(a){t.setVCard({vcard:{nickname:a.vcard.nickname,photo:a.vcard.photo,email:a.vcard.email,mobile:a.vcard.mobile,telephone:a.vcard.telephone},success:a.success,error:a.error})},I.prototype.getRosterItems=function(a){E.getInstance().getRosterItems(a)},I.prototype.addRosterItem=function(b){YYIMCommonUtil.isStringAndNotEmpty(b)&&E.getInstance().addRosterItem(a.buildUserJID(a.getNode(b)))},I.prototype.approveSubscribe=function(b){YYIMCommonUtil.isStringAndNotEmpty(b)&&v.approveSubscribe(a.buildUserJID(a.getNode(b)))},I.prototype.rejectSubscribe=function(b){YYIMCommonUtil.isStringAndNotEmpty(b)&&v.rejectSubscribe(a.buildUserJID(a.getNode(b)))},I.prototype.deleteRosterItem=function(b){YYIMCommonUtil.isStringAndNotEmpty(b.id)&&E.getInstance().deleteRosterItem({jid:a.buildUserJID(a.getNode(b.id)),success:b.success,error:b.error,complete:b.complete})},I.prototype.queryRosterItem=function(a){YYIMCommonUtil.isStringAndNotEmpty(a.keyword)&&E.getInstance().queryRosterItem(a)},I.prototype.updateRosterItem=function(b){b&&b.roster&&YYIMCommonUtil.isStringAndNotEmpty(b.roster.id)&&t.updateRosterItem({roster:{jid:a.buildUserJID(a.getNode(b.roster.id)),name:b.roster.name,groups:b.roster.groups},success:b.success,error:b.error})},I.prototype.queryChatGroup=function(a){YYIMCommonUtil.isStringAndNotEmpty(a.keyword)&&A.getInstance().queryChatGroup(a)},I.prototype.quitChatGroup=function(b){YYIMCommonUtil.isStringAndNotEmpty(b)&&A.getInstance().quitChatGroup(a.buildChatGroupJID(a.getNode(b)))},I.prototype.delGroupMember=function(b,c){YYIMCommonUtil.isStringAndNotEmpty(c)&&A.getInstance().delGroupMember(a.buildChatGroupJID(a.getNode(b)),a.buildUserJID(a.getNode(c)))},I.prototype.joinChatGroup=function(b){YYIMCommonUtil.isStringAndNotEmpty(b.id)&&A.getInstance().joinChatGroup({jid:a.buildChatGroupJID(a.getNode(b.id)),success:b.success,error:b.error})},I.prototype.getChatGroupInfo=function(b){YYIMCommonUtil.isStringAndNotEmpty(b.id)&&t.getChatGroupInfo({jid:a.buildChatGroupJID(a.getNode(b.id)),success:b.success,error:b.error})},I.prototype.getSharedFiles=function(b){if(YYIMCommonUtil.isStringAndNotEmpty(b.id)){var c=0,d=20;!isNaN(b.start)&&Number(b.start)>0&&(c=Number(b.start)),!isNaN(b.size)&&Number(b.size)>0&&(d=Number(b.size)),t.getSharedFiles({jid:a.buildChatGroupJID(a.getNode(b.id)),start:c,size:d,success:b.success,error:b.error})}},I.prototype.getPubAccount=function(a){t.getPubAccountItems(a)},I.prototype.addPubaccount=function(b){YYIMCommonUtil.isStringAndNotEmpty(b.id)&&v.addPubAccount({jid:a.buildPubAccountJID(a.getNode(b.id)),success:b.success,error:b.error})},I.prototype.queryPubaccount=function(a){t.queryPubaccount(a)},I.prototype.getChatGroups=function(a){A.getInstance().getChatGroups(a)},I.prototype.addGroupMember=function(b){if(YYIMCommonUtil.isStringAndNotEmpty(b.roomId)&&YYIMArrayUtil.isArray(b.ids)){for(var c=a.buildChatGroupJID(a.getNode(b.roomId)),d=b.ids.slice(),e=0,f=d.length;f>e;e++)d[e]=a.buildUserJID(a.getNode(d[e]));C.getInstance().addGroupMember(c,d)}},I.prototype.addChatGroup=function(a){YYIMCommonUtil.isStringAndNotEmpty(a.node)&&A.getInstance().addChatGroup(a)},I.prototype.updateChatGroup=function(b){YYIMCommonUtil.isStringAndNotEmpty(b.id)&&A.getInstance().updateChatGroup({jid:a.buildChatGroupJID(a.getNode(b.id)),name:b.name,desc:b.desc,photo:b.photo,error:b.error,success:b.success,complete:b.complete})},I.prototype.getGroupMembers=function(b){YYIMCommonUtil.isStringAndNotEmpty(b.id)&&C.getInstance().getGroupMembers({jid:a.buildChatGroupJID(a.getNode(b.id)),success:b.success,error:b.error,complete:b.complete})},I.prototype.getHistoryMessage=function(a){u.getHistoryMessage(a)},I.prototype.getOfflineMessage=function(){var a={};a.id=this.getUserID(),u.getVersion(a)},I.prototype.sendReceiptsPacket=function(a){u.sendReceiptsPacket(a)},I.prototype.sendReadedReceiptsPacket=function(a){u.sendReadedReceiptsPacket(a)},I.prototype.sendMessage=function(a){u.sendMessage(a)},I.prototype.sendShareMessage=function(a){a.id=Math.uuid(),a.body={extend:a.extend,content:a.sharebody,contentType:q.SHARE,dateline:(new Date).getTime()},a.style&&"string"!=typeof a.style&&(a.body.style=JSON.stringify(a.style)),this.sendMessage(a)},I.prototype.sendTextMessage=function(a){a.id=Math.uuid(),a.body={extend:a.extend,content:a.msg,contentType:q.TEXT,dateline:(new Date).getTime()},a.style&&"string"!=typeof a.style&&(a.body.style=JSON.stringify(a.style)),this.sendMessage(a)},I.prototype.sendPic=function(b){var c=a.getNode(b.to);c=b.type==o.GROUP_CHAT?a.buildChatGroupJID(c):a.buildUserJID(c);var d={fileTypeExts:"jpg;jpeg;png;bmp;gif",fileSizeLimit:5120,breakPoints:!1,saveInfoLocal:!1,removeTimeout:100,uploader:h.SERVLET.FILE_UPLOAD_SERVLET,uploadIdPrefix:"image_upload_",inputId:b.fileInputId,to:c,type:q.IMAGE,chatType:b.type,onUploadSuccess:b.success,onUploadError:b.error,showProcess:!1,processId:"udnProcessBar"};b.resource&&(d.resource=b.resource),FileUpload.getInstance(b.fileInputId,d),FileUpload.getInstance(b.fileInputId).sendFile(document.getElementById(b.fileInputId))},I.prototype.sendFile=function(b){var c=a.getNode(b.to);c=b.type==o.GROUP_CHAT?a.buildChatGroupJID(c):a.buildUserJID(c);var d={fileTypeExts:"*",fileSizeLimit:99999999,breakPoints:!0,saveInfoLocal:!0,removeTimeout:100,uploader:h.SERVLET.FILE_UPLOAD_SERVLET,uploadIdPrefix:"bp_upload_",inputId:b.fileInputId,to:c,type:q.FILE,chatType:b.type,onUploadSuccess:b.success,onUploadError:b.error,showProcess:!0,processId:"udnProcessBar"};b.resource&&(d.resource=b.resource),FileUpload.getInstance(b.fileInputId,d),FileUpload.getInstance(b.fileInputId).sendFile(document.getElementById(b.fileInputId))},I.prototype.uploadAvatar=function(b){var c=a.getNode(b.to);c=b.type==o.GROUP_CHAT?a.buildChatGroupJID(c):a.buildUserJID(c),FileUpload.getInstance(b.fileInputId,{fileTypeExts:"jpg;jpeg;png;bmp;gif",fileSizeLimit:5120,breakPoints:!1,saveInfoLocal:!1,removeTimeout:100,uploader:h.SERVLET.FILE_UPLOAD_SERVLET,uploadIdPrefix:"user_avatar_upload_",inputId:b.fileInputId,to:c,type:UPLOAD_AVATAR,onUploadSuccess:b.success,onUploadError:b.error,showProcess:!1,processId:"udnProcessBar"}),FileUpload.getInstance(b.fileInputId).sendFile(document.getElementById(b.fileInputId))},I.prototype.getServerName=function(){return h.CONNECTION.SERVER_NAME},I.prototype.getFileUrl=function(a){var b,c;return this.isAnonymous()?(b=this.getUserFullJID(),c="anonymous"):(b=this.getUserNode(),c=this.getToken()),h.SERVLET.FILE_DOWNLOAD_SERVLET+"?attachId="+a+"&fromUser="+b+"&token="+c},I.prototype.getServletPath=function(){return h.SERVLET},I.prototype.getJIDUtil=function(){return a},I.prototype.getArrayUtil=function(){return YYIMArrayUtil},I.prototype.isAnonymous=function(){return this._anonymousUser},I.prototype.enableAnonymous=function(){return h.IS_ANONYMOUS},I.prototype.getBrowser=function(){return h.BROWSER},I.prototype.isOnline=function(a){return 1==E.getInstance()._onlineList.get(a)},I.prototype.defaultImg=function(a){var b=a.src;a.src="res/skin/default/icons/avatar.gif",a.setAttribute("data-url",b)},I.getInstance()}();